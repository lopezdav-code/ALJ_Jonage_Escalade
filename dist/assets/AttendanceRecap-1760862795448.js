import{x as q,r as n,w as G,l as K,y as _,j as e,z as Q,H as X,D as h,G as y,J as H,K as I,aa as Y,W as N,N as Z,O as ee,Q as se,U as te,V as ae,B as ne,a0 as re,M as ie,o as le,p as ce,q as M,s as k,t as oe,v as T,az as de,aB as me,X as ue}from"./index-1760862795448.js";import{C as xe}from"./calendar-check-1760862795448.js";import{C as he}from"./check-circle-2-1760862795448.js";const je=()=>{const{isAdmin:v,isEncadrant:b,loading:w}=q(),[o,V]=n.useState([]),[r,D]=n.useState(""),[E,A]=n.useState([]),[u,J]=n.useState([]),[L,F]=n.useState(!1),[z,f]=n.useState(!0),{toast:p}=G(),B=K();n.useEffect(()=>{if(!w&&!v&&!b){B("/schedule");return}},[v,b,w,B]);const R=n.useCallback(async()=>{try{const{data:s,error:t}=await _.from("schedules").select("id, type, age_category, day, start_time, end_time").order("day").order("start_time");if(t)throw t;V(s||[]),s&&s.length>0&&!r&&D(s[0].id)}catch(s){console.error("Error fetching schedules:",s),p({title:"Erreur",description:"Impossible de charger les plannings.",variant:"destructive"})}},[r,p]),U=(s,t,d)=>{const l=[`${s} ${t}`,`${t} ${s}`,t,s].map(i=>i.toLowerCase().trim());console.log("Termes de recherche:",l);for(const i of d){const m=i.toLowerCase();for(const c of l)if(m===c||m.includes(c)||c.includes(m))return console.log(`Match trouvé: "${i}" correspond à "${c}"`),i}return null},O=n.useCallback(async()=>{if(!r){f(!1);return}f(!0);try{const s=o.find(a=>a.id===r);if(!s){A([]),f(!1);return}console.log("Schedule sélectionné:",s);const{data:t,error:d}=await _.from("sessions").select("id, date, start_time, students, schedule_id").not("date","is",null).order("date",{ascending:!0}).order("start_time",{ascending:!0});if(d)throw d;console.log("Toutes les sessions récupérées:",t);const l=t.filter(a=>{if(a.schedule_id===r)return!0;if(a.date&&a.start_time){const g=new Date(a.date),C=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"][g.getDay()],W=a.start_time.substring(0,5);return C===s.day&&W===s.start_time.substring(0,5)}return!1});console.log("Sessions filtrées pour le schedule:",l),J(l||[]);const{data:i}=await _.from("secure_members").select("id, first_name, last_name, title").not("title","is",null),m=[...new Set((i==null?void 0:i.map(a=>a.title))||[])];console.log("Titles disponibles:",m);const c=U(s.type,s.age_category,m);console.log("Title correspondant trouvé:",c);let S=[];c&&(S=i.filter(a=>a.title===c)),console.log("Membres trouvés:",S);const $=(S||[]).map(a=>{const g={member:a,sessions:{}};return(l||[]).forEach(j=>{const C=j.students&&j.students.includes(a.id);g.sessions[j.id]=C}),g});console.log("Données de présence construites:",$),A($)}catch(s){console.error("Error fetching attendance data:",s),p({title:"Erreur",description:"Impossible de charger les données de présence.",variant:"destructive"})}finally{f(!1)}},[r,o,p]);if(n.useEffect(()=>{R()},[R]),n.useEffect(()=>{r&&o.length>0&&O()},[r,o.length,O]),w||z)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(Q,{className:"w-12 h-12 animate-spin text-primary"})});if(!v&&!b)return e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Accès non autorisé"}),e.jsx("p",{className:"text-muted-foreground",children:"Cette page est réservée aux administrateurs et encadrants."})]});const x=o.find(s=>s.id===r),P=L?E.filter(({sessions:s})=>{const t=Object.values(s||{});return t.length===0?!1:!t.every(Boolean)}):E;return e.jsxs("div",{className:"space-y-8",children:[e.jsxs(X,{children:[e.jsx("title",{children:"Récapitulatif de Présence - ALJ Escalade Jonage"}),e.jsx("meta",{name:"description",content:"Récapitulatif des présences des élèves aux séances d'entraînement."})]}),e.jsx(h.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(xe,{className:"w-10 h-10 text-primary"}),"Récapitulatif de Présence"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Consultez les présences des élèves par planning"})]})}),e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},children:e.jsxs(y,{children:[e.jsx(H,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-6 h-6"}),"Sélectionner un Planning"]})}),e.jsx(N,{children:e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsx("div",{className:"flex-1",children:e.jsxs(Z,{value:r,onValueChange:D,children:[e.jsx(ee,{className:"w-full",children:e.jsx(se,{placeholder:"Choisissez un planning..."})}),e.jsx(te,{children:o.map(s=>e.jsx(ae,{value:s.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{variant:"outline",children:s.type}),e.jsx("span",{children:s.age_category}),e.jsxs("span",{className:"text-muted-foreground",children:["- ",s.day," ",s.start_time]})]})},s.id))})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{id:"only-absent",checked:L,onCheckedChange:s=>F(!!s)}),e.jsx(ie,{htmlFor:"only-absent",className:"text-sm",children:"Afficher seulement les absents"})]})]})})]})}),x&&u.length>0&&e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsxs(y,{children:[e.jsx(H,{children:e.jsxs(I,{children:["Présences - ",x.type," ",x.age_category]})}),e.jsx(N,{className:"overflow-x-auto",children:P.length>0?e.jsxs(le,{children:[e.jsx(ce,{children:e.jsxs(M,{children:[e.jsx(k,{className:"sticky left-0 bg-background z-10 min-w-[180px]",children:"Élève"}),u.map(s=>e.jsx(k,{className:"text-center min-w-[120px]",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"font-semibold",children:new Date(s.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit"})}),e.jsx("span",{className:"text-xs text-muted-foreground font-normal",children:s.start_time})]})},s.id)),e.jsx(k,{className:"text-center font-bold sticky right-0 bg-background z-10 min-w-[100px]",children:"Total"})]})}),e.jsx(oe,{children:P.map(({member:s,sessions:t})=>{const d=Object.values(t).filter(Boolean).length;return e.jsxs(M,{children:[e.jsx(T,{className:"font-medium sticky left-0 bg-background z-10",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-primary"}),e.jsx("span",{children:me(s.first_name,s.last_name,!0)})]})}),u.map(l=>e.jsx(T,{className:"text-center",children:t[l.id]?e.jsx(he,{className:"w-5 h-5 text-green-500 mx-auto"}):e.jsx(ue,{className:"w-5 h-5 text-gray-300 mx-auto"})},l.id)),e.jsxs(T,{className:"text-center font-bold sticky right-0 bg-background z-10 text-primary",children:[d," / ",u.length]})]},s.id)})})]}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"Aucun élève trouvé pour ce planning."})})]})}),x&&u.length===0&&!z&&e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsx(y,{children:e.jsx(N,{className:"py-12",children:e.jsx("p",{className:"text-muted-foreground text-center",children:"Aucune séance enregistrée pour ce planning."})})})}),!x&&e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsx(y,{children:e.jsx(N,{className:"py-12",children:e.jsx("p",{className:"text-muted-foreground text-center",children:"Veuillez sélectionner un planning pour afficher les présences."})})})})]})};export{je as default};

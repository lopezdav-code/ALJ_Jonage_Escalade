import{r as l,m as se,l as ae,u as te,s as u,j as e,n as $,H as le,o as O,d as i,q as T,C as B,w as M,p as re,Z as ie,t as ne,v as ce,B as oe,_ as de,$ as me,M as xe,a0 as ue,P as he,T as pe,O as ge,Q as fe,R as je,U as ve,V as Ne,z as h,I as v,K as ye,a1 as we,a2 as _e}from"./index-1760451543780.js";import{A as Ce,a as be,b as De,c as Ae,d as Fe,e as Ee,f as Pe,g as Se}from"./alert-dialog-1760451543780.js";import{U as q}from"./upload-1760451543780.js";const H="cycle_documents",Ue=()=>{const[E,R]=l.useState([]),[V,P]=l.useState(!0),[G,N]=l.useState(!1),[t,y]=l.useState(null),[o,w]=l.useState(null),[S,k]=l.useState(!1),{user:K,isAdmin:z,isEncadrant:J}=se(),{toast:n}=ae(),Q=te(),[r,d]=l.useState({name:"",short_description:"",long_description:""}),[p,_]=l.useState(null),[f,C]=l.useState(null),[I,j]=l.useState(null),[g,m]=l.useState("center"),b=z||J;l.useEffect(()=>{D()},[]);const D=async()=>{P(!0);try{const{data:s,error:a}=await u.from("cycles").select(`
          *,
          sessions:sessions(count)
        `).eq("is_active",!0).order("created_at",{ascending:!1});if(a)throw a;R(s||[])}catch(s){n({title:"Erreur",description:`Impossible de charger les cycles: ${s.message}`,variant:"destructive"})}finally{P(!1)}},A=(s=null)=>{s?(y(s),d({name:s.name,short_description:s.short_description||"",long_description:s.long_description||""}),j(s.image_url||null),m(s.image_position||"center")):(y(null),d({name:"",short_description:"",long_description:""}),j(null),m("center")),_(null),C(null),N(!0)},U=()=>{N(!1),y(null),d({name:"",short_description:"",long_description:""}),_(null),C(null),j(null),m("center")},Y=s=>{var c;const a=(c=s.target.files)==null?void 0:c[0];if(a){C(a);const x=new FileReader;x.onloadend=()=>{j(x.result)},x.readAsDataURL(a)}},L=async(s,a)=>{const c=s.name.split(".").pop(),x=`${a}/${(t==null?void 0:t.id)||"new"}_${Date.now()}.${c}`,{error:F}=await u.storage.from(H).upload(x,s);if(F)throw console.error("Upload error:",F),new Error(`Erreur d'upload: ${F.message}`);const{data:ee}=u.storage.from(H).getPublicUrl(x);return ee.publicUrl},Z=async()=>{if(!r.name.trim()){n({title:"Erreur",description:"Le nom du cycle est obligatoire",variant:"destructive"});return}k(!0);try{const s={name:r.name,short_description:r.short_description,long_description:r.long_description,image_position:g};if(p){const a=await L(p,"pdfs");s.pdf_url=a}if(f){const a=await L(f,"images");s.image_url=a}if(t){const{error:a}=await u.from("cycles").update(s).eq("id",t.id);if(a)throw a;n({title:"Succès",description:"Cycle mis à jour avec succès"})}else{const{error:a}=await u.from("cycles").insert({...s,created_by:K.id});if(a)throw a;n({title:"Succès",description:"Cycle créé avec succès"})}U(),D()}catch(s){n({title:"Erreur",description:`Impossible de sauvegarder le cycle: ${s.message}`,variant:"destructive"})}finally{k(!1)}},W=async()=>{if(o)try{const{error:s}=await u.from("cycles").update({is_active:!1}).eq("id",o.id);if(s)throw s;n({title:"Succès",description:"Cycle archivé avec succès"}),w(null),D()}catch(s){n({title:"Erreur",description:`Impossible d'archiver le cycle: ${s.message}`,variant:"destructive"})}},X=s=>{Q(`/cycles/${s}`)};return V?e.jsx("div",{className:"flex justify-center items-center min-h-[60vh]",children:e.jsx($,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsx(le,{children:e.jsx("title",{children:"Gestion des Cycles - ALJ Escalade"})}),e.jsx("div",{className:"container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl",children:e.jsxs(O.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2",children:"Gestion des Cycles"}),e.jsx("p",{className:"text-gray-600 text-sm sm:text-base",children:"Organisez vos séances en cycles thématiques"})]}),b&&e.jsxs(i,{onClick:()=>A(),size:"lg",className:"w-full sm:w-auto",children:[e.jsx(T,{className:"w-5 h-5 mr-2"}),"Nouveau Cycle"]})]}),E.length===0?e.jsx(B,{children:e.jsxs(M,{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(re,{className:"w-16 h-16 text-gray-300 mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg mb-4",children:"Aucun cycle pour le moment"}),b&&e.jsxs(i,{onClick:()=>A(),children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),"Créer le premier cycle"]})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:e.jsx(ie,{children:E.map(s=>{var a,c;return e.jsx(O.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.3},children:e.jsxs(B,{className:"hover:shadow-lg transition-shadow h-full flex flex-col overflow-hidden",children:[s.image_url&&e.jsx("div",{className:"relative w-full h-48 overflow-hidden bg-gray-100",children:e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-300",style:{objectPosition:s.image_position||"center"}})}),e.jsxs(ne,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 mb-2",children:[e.jsx(ce,{className:"text-lg sm:text-xl break-words",children:s.name}),e.jsxs(oe,{variant:"secondary",className:"w-fit flex-shrink-0",children:[e.jsx(de,{className:"w-3 h-3 mr-1"}),((c=(a=s.sessions)==null?void 0:a[0])==null?void 0:c.count)||0," séances"]})]}),s.short_description&&e.jsx(me,{className:"line-clamp-2 break-words",children:s.short_description})]}),e.jsx(M,{className:"flex-grow",children:s.long_description&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-3 break-words",children:s.long_description})}),e.jsxs(xe,{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>X(s.id),className:"flex-1 sm:flex-initial w-full sm:w-auto",children:[e.jsx(ue,{className:"w-4 h-4 mr-1"}),"Voir"]}),b&&e.jsxs("div",{className:"flex gap-2 flex-1 sm:flex-initial",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>A(s),className:"flex-1 sm:flex-initial",children:e.jsx(he,{className:"w-4 h-4"})}),z&&e.jsx(i,{variant:"outline",size:"sm",onClick:()=>w(s),className:"text-red-600 hover:text-red-700 flex-1 sm:flex-initial",children:e.jsx(pe,{className:"w-4 h-4"})})]})]})]})},s.id)})})})]})}),e.jsx(ge,{open:G,onOpenChange:N,children:e.jsxs(fe,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(je,{children:[e.jsx(ve,{children:t?"Modifier le cycle":"Créer un nouveau cycle"}),e.jsx(Ne,{children:t?"Modifiez les informations du cycle et ajoutez des documents":"Créez un nouveau cycle pour regrouper vos séances"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"name",children:"Nom du cycle *"}),e.jsx(v,{id:"name",value:r.name,onChange:s=>d({...r,name:s.target.value}),placeholder:"Ex: Initiation Bloc 2025"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"short_description",children:"Description courte"}),e.jsx(v,{id:"short_description",value:r.short_description,onChange:s=>d({...r,short_description:s.target.value}),placeholder:"Résumé en une phrase"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"long_description",children:"Description détaillée"}),e.jsx(ye,{id:"long_description",value:r.long_description,onChange:s=>d({...r,long_description:s.target.value}),placeholder:"Décrivez les objectifs et le contenu du cycle...",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"cycle-image",children:"Image illustrative"}),I&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative w-full h-48 overflow-hidden bg-gray-100 rounded-lg border-2 border-gray-200",children:e.jsx("img",{src:I,alt:"Aperçu",className:"w-full h-full object-cover",style:{objectPosition:g}})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm",children:"Position de l'image"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(i,{type:"button",variant:g==="top"?"default":"outline",size:"sm",onClick:()=>m("top"),className:"text-xs",children:"Haut"}),e.jsx(i,{type:"button",variant:g==="center"?"default":"outline",size:"sm",onClick:()=>m("center"),className:"text-xs",children:"Centre"}),e.jsx(i,{type:"button",variant:g==="bottom"?"default":"outline",size:"sm",onClick:()=>m("bottom"),className:"text-xs",children:"Bas"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{id:"cycle-image",type:"file",accept:"image/*",onChange:Y,className:"flex-1"}),f&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(q,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:f?"Une nouvelle image sera téléchargée":t!=null&&t.image_url?"Laisser vide pour conserver l'image actuelle":"Format recommandé: 16:9 (1200x675px)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"cycle-pdf",children:"Document PDF"}),(t==null?void 0:t.pdf_url)&&!p&&e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(we,{className:"w-4 h-4 text-red-600"}),e.jsx("a",{href:t.pdf_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline",children:"Document actuel"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{id:"cycle-pdf",type:"file",accept:".pdf",onChange:s=>{var a;return _(((a=s.target.files)==null?void 0:a[0])||null)},className:"flex-1"}),p&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(q,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:p?"Un nouveau PDF sera téléchargé":t!=null&&t.pdf_url?"Laisser vide pour conserver le PDF actuel":"Optionnel: ajoutez un document PDF"})]})]}),e.jsxs(_e,{children:[e.jsx(i,{variant:"outline",onClick:U,children:"Annuler"}),e.jsxs(i,{onClick:Z,disabled:S,children:[S&&e.jsx($,{className:"w-4 h-4 mr-2 animate-spin"}),t?"Mettre à jour":"Créer"]})]})]})}),e.jsx(Ce,{open:!!o,onOpenChange:()=>w(null),children:e.jsxs(be,{children:[e.jsxs(De,{children:[e.jsx(Ae,{children:"Archiver ce cycle ?"}),e.jsxs(Fe,{children:['Le cycle "',o==null?void 0:o.name,'" sera archivé. Les séances associées ne seront pas supprimées. Cette action peut être annulée en restaurant le cycle depuis les archives.']})]}),e.jsxs(Ee,{children:[e.jsx(Pe,{children:"Annuler"}),e.jsx(Se,{onClick:W,className:"bg-red-600 hover:bg-red-700",children:"Archiver"})]})]})})]})};export{Ue as default};

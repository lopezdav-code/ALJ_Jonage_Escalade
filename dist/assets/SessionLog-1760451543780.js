import{u as A,j as e,A as D,a as I,b as $,B as H,c as O,d as v,P as B,T as R,e as F,f as P,g as L,h as n,i as V,k as i,L as M,r as h,l as J,m as G,s as C,n as k,H as K,o as E,p as Q,q as U,C as W,t as X,v as Y,S as Z,I as ee,w as se}from"./index-1760451543780.js";import{L as te,a as re}from"./lock-1760451543780.js";const ae=({sessions:g,onEdit:f,onDelete:N,isAdmin:y})=>{const x=A(),o=(s,j)=>{let c=new Date(`1970-01-01T${s}:00`);return j.map(l=>{var u,b;const t=parseInt(((b=(u=l.time)==null?void 0:u.match(/\d+/))==null?void 0:b[0])||"0",10),d=new Date(c.getTime()+t*6e4),m=d.toTimeString().substring(0,5);return c=d,{...l,endTime:m}})},w=s=>{s&&x(`/pedagogy#sheet-${s}`)};return e.jsx(D,{type:"single",collapsible:!0,className:"w-full",children:g.map(s=>{var c,l;const j=o(s.start_time,s.exercises);return e.jsxs(I,{value:`session-${s.id}`,children:[e.jsx($,{children:e.jsxs("div",{className:"flex justify-between w-full pr-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-semibold",children:s.date?`${new Date(s.date).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"})} - ${s.start_time}`:"Séance sans date"}),s.cycles&&e.jsxs(H,{variant:"outline",className:"text-xs px-2 py-1 border-blue-500 text-blue-700",children:["Cycle: ",s.cycles.name]})]}),e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-xs",children:s.session_objective})]})}),e.jsxs(O,{className:"space-y-4",children:[y&&e.jsxs("div",{className:"flex justify-end gap-2 mb-4",children:[e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>f(s),children:[e.jsx(B,{className:"w-4 h-4 mr-2"})," Modifier"]}),e.jsxs(v,{variant:"destructive",size:"sm",onClick:()=>N(s.id),children:[e.jsx(R,{className:"w-4 h-4 mr-2"})," Supprimer"]})]}),s.cycles&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("p",{className:"font-semibold text-blue-900",children:["Cycle: ",s.cycles.name]}),s.cycles.short_description&&e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:s.cycles.short_description})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Objectif de séance:"})," ",s.session_objective]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Encadrants:"})," ",(c=s.instructors)==null?void 0:c.join(", ")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Élèves présents:"})," ",(l=s.students)==null?void 0:l.join(", ")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Matériel:"})," ",s.equipment]}),s.comment&&e.jsxs("p",{children:[e.jsx("strong",{children:"Commentaire:"})," ",s.comment]}),e.jsx("h4",{className:"font-semibold mt-4",children:"Déroulé :"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(F,{children:[e.jsx(P,{children:e.jsxs(L,{children:[e.jsx(n,{children:"Fin"}),e.jsx(n,{children:"Temps"}),e.jsx(n,{children:"Objectif Op."}),e.jsx(n,{children:"Situation"}),e.jsx(n,{children:"Organisation"}),e.jsx(n,{children:"Consigne"}),e.jsx(n,{children:"Critère réussite"}),e.jsx(n,{children:"Régulation"}),e.jsx(n,{children:"Support"}),e.jsx(n,{children:"Image"})]})}),e.jsx(V,{children:j.map(t=>e.jsxs(L,{children:[e.jsx(i,{className:"font-mono",children:t.endTime}),e.jsx(i,{children:t.time}),e.jsxs(i,{className:"relative",children:[t.pedagogy_sheet_id&&e.jsx(v,{variant:"ghost",size:"icon",className:"absolute -left-8 top-1/2 -translate-y-1/2 h-7 w-7",onClick:()=>w(t.pedagogy_sheet_id),title:"Voir la fiche pédagogique",children:e.jsx(te,{className:"w-4 h-4 text-primary"})}),t.operational_objective]}),e.jsx(i,{children:t.situation}),e.jsx(i,{children:t.organisation}),e.jsx(i,{children:t.consigne}),e.jsx(i,{children:t.success_criteria}),e.jsx(i,{children:t.regulation}),e.jsx(i,{children:t.support_link&&e.jsx("a",{href:t.support_link,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:e.jsx(M,{className:"w-4 h-4"})})}),e.jsx(i,{children:t.image_url&&e.jsx("a",{href:t.image_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:t.image_url,className:"h-16 w-16 object-cover rounded-md",alt:`Image pour ${t.situation||"exercice"}`})})})]},t.id))})]})})]})]},s.id)})})},le=()=>{const g=A(),[f,N]=h.useState([]),[y,x]=h.useState(!0),[o,w]=h.useState(""),{toast:s}=J(),{user:j,isAdmin:c,isAdherent:l,loading:t}=G(),d=!t&&(c||l),m=!t&&c,u=h.useCallback(async()=>{if(!d){x(!1);return}x(!0);const{data:a,error:r}=await C.from("sessions").select(`
        *, 
        exercises (*),
        cycles (
          id,
          name,
          short_description
        )
      `).order("date",{ascending:!1,nullsFirst:!0}).order("start_time",{ascending:!1,nullsFirst:!0}).order("order",{foreignTable:"exercises",ascending:!0});console.log("Données récupérées pour les séances :",a),r?s({title:"Erreur",description:"Impossible de charger les séances.",variant:"destructive"}):N(a.map(p=>({...p,start_time:p.start_time?p.start_time.substring(0,5):"18:30"}))),x(!1)},[s,d]);h.useEffect(()=>{u()},[u]);const b=a=>{m&&g(`/session-log/edit/${a.id}`)},q=async a=>{if(m)try{await C.from("exercises").delete().eq("session_id",a);const{error:r}=await C.from("sessions").delete().eq("id",a);if(r)throw r;s({title:"Séance supprimée",description:"La séance a été supprimée avec succès.",variant:"destructive"}),u()}catch(r){s({title:"Erreur de suppression",description:r.message,variant:"destructive"})}},_=h.useMemo(()=>{const a=f.filter(r=>{var S,T;if(!r.date)return!1;if(!o)return!0;const p=o.toLowerCase();return[((S=r.cycles)==null?void 0:S.name)||"",((T=r.cycles)==null?void 0:T.short_description)||"",r.session_objective,r.comment,...r.instructors||[],...r.students||[],...r.exercises.map(z=>Object.values(z).join(" "))].join(" ").toLowerCase().includes(p)});return console.log("Séances après filtrage :",a),a},[f,o]);return t?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(k,{className:"w-12 h-12 animate-spin text-primary"})}):d?e.jsxs("div",{className:"space-y-8",children:[e.jsxs(K,{children:[e.jsx("title",{children:"Séances d'entraînement - ALJ Escalade Jonage"}),e.jsx("meta",{name:"description",content:"Consultez et gérez les séances d'escalade du club."})]}),e.jsx(E.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(Q,{className:"w-10 h-10 text-primary"}),"Séances d'entraînement"]}),m&&e.jsxs(v,{onClick:()=>g("/session-log/new"),children:[e.jsx(U,{className:"w-4 h-4 mr-2"})," Créer une séance"]})]})}),e.jsx(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:e.jsxs(W,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Historique des séances"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground"}),e.jsx(ee,{placeholder:"Rechercher par objectif, encadrant, élève...",className:"pl-10",value:o,onChange:a=>w(a.target.value)})]})]}),e.jsxs(se,{children:[y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsx(k,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsx(ae,{sessions:_,onEdit:b,onDelete:q,isAdmin:m}),!y&&_.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:'Aucune séance trouvée. Cliquez sur "Créer une séance" pour commencer !'})]})]})})]}):e.jsxs("div",{className:"text-center py-16",children:[e.jsx(re,{className:"w-12 h-12 mx-auto text-muted-foreground"}),e.jsx("h1",{className:"text-2xl font-bold mt-4",children:"Accès restreint"}),e.jsx("p",{className:"text-muted-foreground",children:"Vous devez être un adhérent ou un administrateur pour voir cette page."}),!j&&e.jsx("p",{className:"mt-4",children:"Veuillez vous connecter."})]})};export{le as default};

import{R as xe,r as l,w as ce,bd as ge,j as e,be as _e,bf as pe,bg as je,az as fe,m as _,M as c,T as ve,I as S,N as k,O as D,Q as L,U as R,V as f,a0 as ye,aB as E,b5 as Q,aR as Ce,ac as me,z as ie,a1 as K,a2 as W,a3 as X,a4 as Y,a5 as Ne,b6 as Z,b7 as b,b9 as ee,b8 as se,ba as te,bb as q,y as F,bh as we,bi as Se,bj as Ee,aA as Fe,ar as ae,a6 as Ae,l as Ie,ay as Ue,x as Oe,af as ke,H as De,a9 as Le,bk as Re}from"./index-1760860133980.js";import{U as Be}from"./upload-cloud-1760860133980.js";const ne={"Loisir enfants":["mercredi 13h Groupe A","mercredi 13h Groupe B","mercredi 16h","vendredi"],"Loisir collége":["Mardi 18h","Jeudi 18h"],"Loisir lycée":[],"Loisir adulte":[],"Adultes autonomes":[],"Compétition U11-U15":[],"Compétition U15-U19":[],Bénévole:[],Bureau:[],emergency_contact:[]},Me=["U11","U13","U15","U17","U19"],Pe=["Blanc","Jaune","Orange","Vert","Bleu","Violet","Rouge"],$e=["Initiateur SAE","Juge Bloc 1","Juge Bloc 2","Juge Bloc 3","Juge de difficulté 1","Juge de difficulté 2","Juge de difficulté 3","Gestionanaire EPI","Entraineur d'escalade 1","Entraineur d'escalade 2"],Te=({member:s,onSave:B,onCancel:T,isSaving:v})=>{const u=xe.useMemo(()=>(s==null?void 0:s.id)||`new-${Date.now()}`,[s==null?void 0:s.id]),[a,y]=l.useState({first_name:(s==null?void 0:s.first_name)||"",last_name:(s==null?void 0:s.last_name)||"",title:(s==null?void 0:s.title)||"",sub_group:(s==null?void 0:s.sub_group)||"",category:(s==null?void 0:s.category)||"",phone:(s==null?void 0:s.phone)||"",photo_url:(s==null?void 0:s.photo_url)||null,sexe:(s==null?void 0:s.sexe)||"",licence:(s==null?void 0:s.licence)||"",email:(s==null?void 0:s.email)||"",passeport:(s==null?void 0:s.passeport)||"",emergency_contact_1_id:(s==null?void 0:s.emergency_contact_1_id)||null,emergency_contact_2_id:(s==null?void 0:s.emergency_contact_2_id)||null,brevet_federaux:(s==null?void 0:s.brevet_federaux)||[]}),[M,P]=l.useState(null),[A,p]=l.useState(null),[h,I]=l.useState([]),[J,U]=l.useState(!1),[V,N]=l.useState(!1),[o,x]=l.useState(null),[r,O]=l.useState([]),{toast:j}=ce();l.useEffect(()=>{(async()=>{const{data:n,error:i}=await F.from("secure_members").select("id, first_name, last_name").order("last_name").order("first_name");i||I(n)})(),s!=null&&s.id&&(async()=>{const{data:i,error:g}=await F.from("secure_members").select("id, first_name, last_name").or(`emergency_contact_1_id.eq.${s.id},emergency_contact_2_id.eq.${s.id}`);g||O(i)})(),s!=null&&s.photo_url?ge(s.photo_url).then(n=>p(n)).catch(n=>{console.error("Erreur chargement image:",n),p(null)}):p(null)},[s]);const C=l.useMemo(()=>s!=null&&s.emergency_contact_1&&typeof s.emergency_contact_1=="object"&&s.emergency_contact_1.id===a.emergency_contact_1_id?s.emergency_contact_1:h.find(t=>t.id===a.emergency_contact_1_id),[h,a.emergency_contact_1_id,s==null?void 0:s.emergency_contact_1]),m=l.useMemo(()=>s!=null&&s.emergency_contact_2&&typeof s.emergency_contact_2=="object"&&s.emergency_contact_2.id===a.emergency_contact_2_id?s.emergency_contact_2:h.find(t=>t.id===a.emergency_contact_2_id),[h,a.emergency_contact_2_id,s==null?void 0:s.emergency_contact_2]),w=t=>{const{name:n,value:i}=t.target;y(g=>({...g,[n]:i}))},d=(t,n)=>{const i={...a,[t]:n};t==="title"&&(i.sub_group=""),y(i)},$=t=>{y(n=>{const i=n.brevet_federaux.includes(t)?n.brevet_federaux.filter(g=>g!==t):[...n.brevet_federaux,t];return{...n,brevet_federaux:i}})},le=t=>{if(t.target.files&&t.target.files[0]){const n=t.target.files[0];P(n),p(URL.createObjectURL(n)),y(i=>({...i,photo_url:URL.createObjectURL(n)}))}},re=()=>{P(null),p(null),y(t=>({...t,photo_url:null}))},oe=t=>{t.preventDefault();const{isEmergencyContactFor:n,is_emergency_contact_for_others:i,...g}=a;B({...g},M)},de=async t=>{if(!s||!s.id){j({title:"Erreur",description:"Le membre actuel doit être sauvegardé avant de pouvoir être défini comme contact d'urgence.",variant:"destructive"});return}const{data:n,error:i}=await F.from("secure_members").select("emergency_contact_1_id, emergency_contact_2_id").eq("id",t).single();if(i){j({title:"Erreur",description:"Impossible de récupérer les informations du membre cible.",variant:"destructive"});return}let g;if(!n.emergency_contact_1_id)g={emergency_contact_1_id:s.id};else if(!n.emergency_contact_2_id)g={emergency_contact_2_id:s.id};else{j({title:"Information",description:"Ce membre a déjà deux contacts d'urgence.",variant:"default"});return}const{error:he}=await F.from("members").update(g).eq("id",t);he?j({title:"Erreur",description:"Échec de la mise à jour du contact d'urgence.",variant:"destructive"}):(j({title:"Succès",description:"Contact d'urgence défini avec succès.",variant:"success"}),U(!1))},G=t=>{x(t),N(!0)},H=t=>{o&&d(o,t),N(!1),x(null)},z=a.title?ne[a.title]||[]:[],ue=t=>t.includes("Initiateur")?e.jsx(we,{className:"h-4 w-4"}):t.includes("Juge Bloc")?e.jsx(Se,{className:"h-4 w-4"}):t.includes("Juge de difficulté")?e.jsx(Ee,{className:"h-4 w-4"}):t.includes("Gestionnaire")?e.jsx(Fe,{className:"h-4 w-4"}):t.includes("Entraîneur")?e.jsx(ae,{className:"h-4 w-4"}):e.jsx(ae,{className:"h-4 w-4"});return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:oe,children:[e.jsxs("div",{className:"grid gap-3 py-2 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsxs(_e,{className:"w-20 h-20",children:[e.jsx(pe,{src:A,alt:"Avatar"}),e.jsx(je,{className:"text-3xl",children:e.jsx(fe,{className:"w-12 h-12"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{type:"button",asChild:!0,variant:"outline",children:e.jsxs(c,{htmlFor:`photo-upload-${u}`,className:"cursor-pointer",children:[e.jsx(Be,{className:"mr-2 h-4 w-4"})," Changer"]})}),A&&e.jsxs(_,{type:"button",variant:"destructive",onClick:re,children:[e.jsx(ve,{className:"mr-2 h-4 w-4"})," Supprimer"]})]}),e.jsx(S,{id:`photo-upload-${u}`,type:"file",className:"hidden",onChange:le,accept:"image/*"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Prénom"}),e.jsx(S,{name:"first_name",value:a.first_name,onChange:w,required:!0})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Nom"}),e.jsx(S,{name:"last_name",value:a.last_name,onChange:w,required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Email"}),e.jsx(S,{name:"email",type:"email",value:a.email||"",onChange:w})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Téléphone"}),e.jsx(S,{name:"phone",type:"tel",value:a.phone||"",onChange:w})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Sexe"}),e.jsxs(k,{name:"sexe",value:a.sexe||"",onValueChange:t=>d("sexe",t),children:[e.jsx(D,{children:e.jsx(L,{placeholder:"Sexe"})}),e.jsxs(R,{children:[e.jsx(f,{value:"H",children:"Homme"}),e.jsx(f,{value:"F",children:"Femme"})]})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Licence"}),e.jsx(S,{name:"licence",value:a.licence||"",onChange:w})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Titre/Catégorie"}),e.jsxs(k,{name:"title",value:a.title,onValueChange:t=>d("title",t),children:[e.jsx(D,{children:e.jsx(L,{placeholder:"Catégorie"})}),e.jsx(R,{children:Object.keys(ne).map(t=>e.jsx(f,{value:t,children:t},t))})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Sous-groupe"}),e.jsxs(k,{name:"sub_group",value:a.sub_group,onValueChange:t=>d("sub_group",t),disabled:z.length===0,children:[e.jsx(D,{children:e.jsx(L,{placeholder:"Sous-groupe"})}),e.jsx(R,{children:z.map(t=>e.jsx(f,{value:t,children:t},t))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Catégorie d'âge (Compétition)"}),e.jsxs(k,{name:"category",value:a.category||"",onValueChange:t=>d("category",t),children:[e.jsx(D,{children:e.jsx(L,{placeholder:"Catégorie d'âge"})}),e.jsxs(R,{children:[e.jsx(f,{value:"",children:"Aucune"}),Me.map(t=>e.jsx(f,{value:t,children:t},t))]})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Passeport"}),e.jsxs(k,{name:"passeport",value:a.passeport||"",onValueChange:t=>d("passeport",t),children:[e.jsx(D,{children:e.jsx(L,{placeholder:"Passeport"})}),e.jsxs(R,{children:[e.jsx(f,{value:"",children:"Aucun"}),Pe.map(t=>e.jsx(f,{value:t,children:t},t))]})]})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Brevets Fédéraux"}),e.jsx("div",{className:"grid grid-cols-2 gap-1 mt-2",children:$e.map(t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{id:`b-${u}-${t}`,checked:a.brevet_federaux.includes(t),onCheckedChange:()=>$(t)})," ",ue(t)," ",e.jsx(c,{htmlFor:`b-${u}-${t}`,className:"font-normal text-sm",children:t})]},t))})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Contact d'urgence 1"}),e.jsxs(_,{variant:"outline",type:"button",className:"w-full justify-between",onClick:()=>G("emergency_contact_1_id"),children:[C?E(C.first_name,C.last_name,!0):"Sélectionner un contact",e.jsx(Q,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Contact d'urgence 2"}),e.jsxs(_,{variant:"outline",type:"button",className:"w-full justify-between",onClick:()=>G("emergency_contact_2_id"),children:[m?E(m.first_name,m.last_name,!0):"Sélectionner un contact",e.jsx(Q,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})]}),(s==null?void 0:s.id)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{type:"button",variant:"secondary",onClick:()=>U(!0),className:"w-full",children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"})," Je suis le contact de..."]}),r.length>0&&e.jsxs("div",{children:[e.jsxs(c,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-4 h-4"})," Contact d'urgence pour :"]}),e.jsx("ul",{className:"text-sm list-disc list-inside mt-1",children:r.map(t=>e.jsx("li",{children:E(t.first_name,t.last_name,!0)},t.id))})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(_,{type:"button",variant:"outline",onClick:T,children:"Annuler"}),e.jsxs(_,{type:"submit",disabled:v,children:[v&&e.jsx(ie,{className:"mr-2 h-4 w-4 animate-spin"}),"Enregistrer"]})]})]}),e.jsx(K,{open:J,onOpenChange:U,children:e.jsxs(W,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Définir comme contact d'urgence"}),e.jsxs(Ne,{children:["Sélectionnez le membre pour lequel ",E(a.first_name,a.last_name,!0)," sera le contact d'urgence."]})]}),e.jsxs(Z,{children:[e.jsx(b,{placeholder:"Rechercher un membre..."}),e.jsxs(ee,{children:[e.jsx(se,{children:"Aucun membre trouvé."}),e.jsx(te,{children:h.filter(t=>t.id!==(s==null?void 0:s.id)).map(t=>e.jsx(q,{value:`${t.first_name} ${t.last_name}`,onSelect:()=>de(t.id),children:E(t.first_name,t.last_name,!0)},t.id))})]})]})]})}),e.jsx(K,{open:V,onOpenChange:N,children:e.jsxs(W,{children:[e.jsx(X,{children:e.jsx(Y,{children:"Sélectionner un contact d'urgence"})}),e.jsxs(Z,{children:[e.jsx(b,{placeholder:"Rechercher un membre..."}),e.jsxs(ee,{children:[e.jsx(se,{children:"Aucun membre trouvé."}),e.jsxs(te,{children:[e.jsx(q,{onSelect:()=>H(null),children:"Aucun"}),h.filter(t=>t.id!==(s==null?void 0:s.id)).map(t=>e.jsx(q,{value:`${t.first_name} ${t.last_name}`,onSelect:()=>H(t.id),children:E(t.first_name,t.last_name,!0)},t.id))]})]})]})]})})]})},qe=()=>{var N;const{id:s}=Ae(),B=Ie(),T=Ue(),{toast:v}=ce(),[u,a]=l.useState(null),[y,M]=l.useState(!0),[P,A]=l.useState(!1),p=(N=T.state)==null?void 0:N.fromTab,h=()=>{const o=p?`/volunteers?tab=${encodeURIComponent(p)}`:"/volunteers";B(o)},{user:I}=Oe();l.useEffect(()=>{s&&(async()=>{var m;M(!0);const x=(m=I==null?void 0:I.user_metadata)==null?void 0:m.role,r=x==="admin"||x==="bureau";let O="*, profiles(role)";r&&(O+=`,
          emergency_contact_1:members!emergency_contact_1_id(id, first_name, last_name, phone),
          emergency_contact_2:members!emergency_contact_2_id(id, first_name, last_name, phone)
        `);const{data:j,error:C}=await F.from("secure_members").select(O).eq("id",s).single();if(C){console.error("Erreur chargement membre:",C),v({title:"Erreur",description:"Impossible de charger les informations du membre",variant:"destructive"}),h();return}a(j),M(!1)})()},[s,B,v]);const J=async(o,x)=>{const r=await Re(o,{first_name:x.first_name,last_name:x.last_name});if(!r.success)throw new Error(r.error||"Erreur lors de l'upload de l'image");return r.filePath},U=async(o,x)=>{A(!0);try{let r=o.photo_url;x?r=await J(x,o):o.photo_url===null&&(r=null);const{profiles:O,dynamic_roles:j,isEmergencyContactFor:C,emergency_contact_1:m,emergency_contact_2:w,...d}={...o,photo_url:r};d.passeport===""&&(d.passeport=null),d.sexe===""&&(d.sexe=null);const{error:$}=await F.from("members").update(d).eq("id",s);if($)throw $;v({title:"Succès",description:"Membre modifié avec succès"})}catch(r){console.error("Erreur lors de la sauvegarde:",r),v({title:"Erreur",description:"Erreur lors de la modification du membre",variant:"destructive"})}finally{A(!1)}},V=()=>{h()};return y?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(ie,{className:"w-12 h-12 animate-spin text-primary"})}):u?e.jsx(ke,{pageTitle:"Édition de membre",message:"Vous n'avez pas les droits nécessaires pour modifier cette page. Seuls les administrateurs et les membres du bureau peuvent éditer les informations des membres.",children:e.jsxs("div",{className:"p-4 max-w-4xl mx-auto",children:[e.jsx(De,{children:e.jsxs("title",{children:["Modifier ",u.first_name," ",u.last_name," - Club d'Escalade"]})}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(_,{variant:"ghost",onClick:()=>h(),className:"mb-2",children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Retour aux adhérents"]}),e.jsxs("h1",{className:"text-xl font-bold",children:["Modifier ",u.first_name," ",u.last_name]})]}),e.jsx(Te,{member:u,onSave:U,onCancel:V,isSaving:P})]})}):e.jsxs("div",{className:"text-center",children:[e.jsx("p",{children:"Membre non trouvé"}),e.jsx(_,{onClick:()=>h(),className:"mt-4",children:"Retour aux adhérents"})]})};export{qe as default};

import{c as Y,r as n,Q as Ne,O as ee,af as be,t as g,j as e,R as _,U as ye,m as z,B as j,P as ke,C as U,b as O,d as H,Z as B,e as V,F as $,G,H as u,J as m,K as J,M as t,x as K,an as W,X as se,N as Ce,n as te,o as ae,p as re,q as ie,s as ne,E as we,g as r,f as Z,W as Se,ao as Ae,ap as Ee,aq as _e,S as ce,I as Q,D as Le,h as De,i as Me,k as Pe,l as Re,L as I,$ as qe,ar as Fe}from"./index-1760361243512.js";import{A as ze,h as Ie,a as Te,b as Ue,c as Oe,d as He,e as Be,f as Ve,g as $e}from"./alert-dialog-1760361243512.js";import{S as Ge}from"./save-1760361243512.js";const Je=Y("MailCheck",[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m16 19 2 2 4-4",key:"1b14m6"}]]),Ke=Y("UserCog",[["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m21.7 16.4-.9-.3",key:"12j9ji"}],["path",{d:"m15.2 13.9-.9-.3",key:"1fdjdi"}],["path",{d:"m16.6 18.7.3-.9",key:"heedtr"}],["path",{d:"m19.1 12.2.3-.9",key:"1af3ki"}],["path",{d:"m19.6 18.7-.4-1",key:"1x9vze"}],["path",{d:"m16.8 12.3-.4-1",key:"vqeiwj"}],["path",{d:"m14.3 16.6 1-.4",key:"1qlj63"}],["path",{d:"m20.7 13.8 1-.4",key:"1v5t8k"}]]),le=["admin","bureau","encadrant","adherent","user"],Qe=[{to:"/news",text:"Actualités"},{to:"/schedule",text:"Planning"},{to:"/inscriptions",text:"Inscription"},{to:"/contact",text:"Contact"},{to:"/volunteers",text:"Bénévoles"},{to:"/members",text:"Adhérents"},{to:"/competitors",text:"Compétiteurs"},{to:"/competitions",text:"Compétitions"},{to:"/agenda",text:"Agenda"},{to:"/session-log",text:"Séances"},{to:"/cycles",text:"Cycles"},{to:"/passeport-validation",text:"Validation Passeports"}],de=({onSelect:C,children:w,existingLinks:L})=>{const[f,v]=n.useState(!1),[x,N]=n.useState(""),[l,P]=n.useState([]),[c,p]=n.useState(!1),[S,b]=n.useState([]);n.useEffect(()=>{(async()=>{const{data:d}=await g.from("members").select("id, first_name, last_name");d&&b(d)})()},[]),n.useEffect(()=>{if(!f)return;p(!0);const o=S.filter(d=>!L.includes(d.id)&&(x===""||`${d.first_name} ${d.last_name}`.toLowerCase().includes(x.toLowerCase()))).slice(0,10);P(o),p(!1)},[x,f,L,S]);const D=o=>{C(o),v(!1),N("")};return e.jsxs(Ae,{open:f,onOpenChange:v,children:[e.jsx(Ee,{asChild:!0,children:w}),e.jsxs(_e,{className:"w-80 p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Q,{placeholder:"Rechercher un membre...",value:x,onChange:o=>N(o.target.value),className:"pl-8"})]})}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:c?e.jsx("div",{className:"flex justify-center p-4",children:e.jsx(_,{className:"h-5 w-5 animate-spin"})}):l.length>0?l.map(o=>e.jsx("div",{onClick:()=>D(o),className:"p-2 hover:bg-accent cursor-pointer text-sm",children:W(o.first_name,o.last_name,!0)},o.id)):e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"Aucun membre trouvé."})})]})]})},We=({isOpen:C,onClose:w,onUserCreated:L})=>{const[f,v]=n.useState(""),[x,N]=n.useState(""),[l,P]=n.useState("user"),[c,p]=n.useState(null),[S,b]=n.useState(!1),{toast:D}=ee(),o=async d=>{d.preventDefault(),b(!0);try{const{data:y,error:R}=await g.functions.invoke("admin-create-user",{body:{email:f,password:x,role:l,member_id:(c==null?void 0:c.id)||null}});if(R||!y||!y.user)throw new Error("La création de l'utilisateur a échoué.");const T=y.user;D({title:"Succès",description:"Utilisateur créé avec succès."}),L(),w()}catch(y){D({title:"Erreur",description:y.message,variant:"destructive"})}finally{b(!1)}};return e.jsx(Le,{open:C,onOpenChange:w,children:e.jsxs(De,{children:[e.jsxs(Me,{children:[e.jsx(Pe,{children:"Créer un nouvel utilisateur"}),e.jsx(Re,{children:"Créez un compte et liez-le à un profil de membre existant. Le compte sera validé automatiquement."})]}),e.jsxs("form",{onSubmit:o,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"email",children:"Email"}),e.jsx(Q,{id:"email",type:"email",value:f,onChange:d=>v(d.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"password",children:"Mot de passe"}),e.jsx(Q,{id:"password",type:"password",value:x,onChange:d=>N(d.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(I,{children:"Rôle"}),e.jsxs(te,{value:l,onValueChange:P,children:[e.jsx(ae,{children:e.jsx(re,{})}),e.jsx(ie,{children:le.map(d=>e.jsx(ne,{value:d,children:e.jsx("span",{className:"capitalize",children:d})},d))})]})]}),e.jsxs("div",{children:[e.jsx(I,{children:"Lier à un membre"}),c?e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-md",children:[e.jsx("span",{children:W(c.first_name,c.last_name,!0)}),e.jsx(j,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>p(null),children:e.jsx(se,{className:"h-4 w-4"})})]}):e.jsx(de,{onSelect:p,existingLinks:[],children:e.jsxs(j,{variant:"outline",className:"w-full justify-start font-normal",children:[e.jsx(ce,{className:"mr-2 h-4 w-4"})," Rechercher un membre..."]})})]}),e.jsxs(qe,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:w,children:"Annuler"}),e.jsxs(j,{type:"submit",disabled:S,children:[S?e.jsx(_,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Créer l'utilisateur"]})]})]})]})})},es=()=>{const[C,w]=n.useState([]),[L,f]=n.useState(!0),[v,x]=n.useState(null),{isAdmin:N,user:l,loading:P}=Ne(),{toast:c}=ee(),{config:p,updateConfig:S,loadingConfig:b}=be(),D=s=>{switch(s){case"/news":case"/schedule":case"/inscriptions":case"/contact":case"/agenda":return["public","user","adherent","bureau","encadrant","admin"];case"/volunteers":case"/members":case"/competitors":case"/competitions":case"/session-log":case"/cycles":return["adherent","bureau","encadrant","admin"];case"/passeport-validation":return["encadrant","admin"];default:return["adherent","bureau","encadrant","admin"]}},[o,d]=n.useState(Qe.map(s=>({to:s.to,text:s.text,roles:D(s.to)}))),[y,R]=n.useState(!1),[T,X]=n.useState(!1),[oe,q]=n.useState(null),A=n.useCallback(async()=>{if(l){f(!0);try{const{data:s,error:a}=await g.from("profiles").select("*, members(id, first_name, last_name)");if(a)throw a;const{data:i,error:h}=await g.functions.invoke("get-users",{body:{userId:l.id}});if(h)throw h;if(i.error)throw new Error(i.error);const k=i.users,E=s.map(F=>{const M=k.find(ve=>ve.id===F.id);return{...F,email:M==null?void 0:M.email,email_confirmed_at:M==null?void 0:M.email_confirmed_at}});w(E)}catch(s){c({title:"Erreur",description:`Impossible de charger les utilisateurs: ${s.message}`,variant:"destructive"})}finally{f(!1)}}},[l==null?void 0:l.id]);n.useEffect(()=>{N&&(l!=null&&l.id)&&A()},[N,l==null?void 0:l.id]);const me=n.useMemo(()=>C.map(s=>s.member_id).filter(Boolean),[C]),xe=async(s,a)=>{q(s);const{error:i}=await g.from("profiles").update({member_id:a.id}).eq("id",s);i?c({title:"Erreur",description:"Impossible de lier le membre.",variant:"destructive"}):(c({title:"Succès",description:"Membre lié au profil."}),A()),q(null)},he=async s=>{q(s);const{error:a}=await g.from("profiles").update({member_id:null}).eq("id",s);a?c({title:"Erreur",description:"Impossible de délier le membre.",variant:"destructive"}):(c({title:"Succès",description:"Membre délié du profil."}),A()),q(null)};n.useEffect(()=>{if(!b&&p.nav_config)try{const s=JSON.parse(p.nav_config);d(a=>{const i=[...a];return s.forEach(h=>{const k=i.findIndex(E=>E.to===h.to);k!==-1&&(i[k].roles=h.roles)}),i})}catch(s){console.error("Failed to parse nav_config:",s)}},[p.nav_config,b]);const ue=async(s,a)=>{x(s);try{const{data:i,error:h}=await g.functions.invoke("set-user-role",{body:{userId:s,role:a}});if(h)throw h;if(i.error)throw new Error(i.error);c({title:"Succès",description:"Le rôle a été mis à jour."}),A()}catch(i){c({title:"Erreur",description:i.message,variant:"destructive"})}finally{x(null)}},je=(s,a,i)=>{d(h=>{const k=[...h],E=k[s].roles;return i?E.includes(a)||E.push(a):k[s].roles=E.filter(F=>F!==a),k})},fe=async()=>{R(!0);const{error:s}=await S("nav_config",JSON.stringify(o));c(s?{title:"Erreur",description:"Impossible de sauvegarder la configuration du menu.",variant:"destructive"}:{title:"Succès",description:"Configuration du menu sauvegardée."}),R(!1)},pe=async(s,a)=>{x(s);try{const{error:i}=await g.functions.invoke("confirm-user",{body:{userId:s}});if(i)throw i;c({title:"Succès",description:`L'email de ${a} a été confirmé.`}),A()}catch(i){c({title:"Erreur",description:i.message,variant:"destructive"})}finally{x(null)}},ge=async s=>{x(s.id);try{const{data:a,error:i}=await g.functions.invoke("delete-user",{body:{userId:s.id}});if(i)throw new Error(`Function error: ${i.message}`);if(a.error)throw new Error(`Function returned error: ${a.error}`);c({title:"Succès",description:`L'utilisateur ${s.email} a été supprimé.`}),A()}catch(a){c({title:"Erreur",description:a.message,variant:"destructive"})}finally{x(null)}};return P||b?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(_,{className:"w-12 h-12 animate-spin text-primary"})}):N?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-8",children:[e.jsx(ye,{children:e.jsx("title",{children:"Gestion des Rôles et Accès"})}),e.jsxs(z.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(Ke,{className:"w-10 h-10 text-primary"}),"Gestion des Rôles & Accès"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Gérez les rôles des utilisateurs et les accès aux pages."})]}),e.jsxs(j,{onClick:()=>X(!0),children:[e.jsx(ke,{className:"mr-2 h-4 w-4"})," Créer un utilisateur"]})]}),e.jsx(z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},children:e.jsxs(U,{children:[e.jsxs(O,{children:[e.jsx(H,{children:"Rôles des Utilisateurs"}),e.jsx(B,{children:"Liste de tous les utilisateurs inscrits."})]}),e.jsx(V,{children:L?e.jsx("div",{className:"flex justify-center items-center py-16",children:e.jsx(_,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs($,{children:[e.jsx(G,{children:e.jsxs(u,{children:[e.jsx(m,{children:"Email"}),e.jsx(m,{children:"Adhérent Lié"}),e.jsx(m,{children:"Rôle"}),e.jsx(m,{className:"text-right",children:"Actions"})]})}),e.jsx(J,{children:C.map(s=>e.jsxs(u,{children:[e.jsxs(t,{className:"font-medium truncate max-w-[200px]",children:[s.email,!s.email_confirmed_at&&e.jsx(K,{variant:"outline",className:"ml-2",children:"Non confirmé"})]}),e.jsx(t,{children:oe===s.id?e.jsx(_,{className:"h-4 w-4 animate-spin"}):s.members?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{variant:"secondary",className:"truncate",children:W(s.members.first_name,s.members.last_name,!0)}),e.jsx(j,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>he(s.id),children:e.jsx(se,{className:"h-4 w-4"})})]}):e.jsx(de,{onSelect:a=>xe(s.id,a),existingLinks:me,children:e.jsxs(j,{variant:"outline",size:"sm",children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"})," Lier"]})})}),e.jsx(t,{children:s.id===l.id?e.jsx(K,{children:"Vous (Admin)"}):v===s.id?e.jsx("div",{className:"flex justify-start",children:e.jsx(_,{className:"w-5 h-5 animate-spin"})}):e.jsxs(te,{value:s.role||"user",onValueChange:a=>ue(s.id,a),children:[e.jsx(ae,{className:"w-[120px]",children:e.jsx(re,{placeholder:"Rôle"})}),e.jsx(ie,{children:le.map(a=>e.jsx(ne,{value:a,children:e.jsx("span",{className:"capitalize",children:a})},a))})]})}),e.jsx(t,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.id!==l.id&&!s.email_confirmed_at&&e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>pe(s.id,s.email),disabled:v===s.id,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"})," Confirmer"]}),s.id!==l.id&&e.jsxs(ze,{children:[e.jsx(Ie,{asChild:!0,children:e.jsx(j,{variant:"destructive",size:"icon",disabled:v===s.id,children:e.jsx(we,{className:"h-4 w-4"})})}),e.jsxs(Te,{children:[e.jsxs(Ue,{children:[e.jsx(Oe,{children:"Êtes-vous sûr ?"}),e.jsxs(He,{children:["Cette action est irréversible. Elle supprimera définitivement le compte de ",e.jsx("strong",{children:s.email}),"."]})]}),e.jsxs(Be,{children:[e.jsx(Ve,{children:"Annuler"}),e.jsx($e,{onClick:()=>ge(s),children:"Supprimer"})]})]})]})]})})]},s.id))})]})})]})}),e.jsx(z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsxs(U,{children:[e.jsxs(O,{children:[e.jsx(H,{children:"Accès aux Pages du Menu"}),e.jsx(B,{children:"Définissez quels rôles peuvent voir chaque page dans le menu principal."})]}),e.jsx(V,{children:e.jsxs($,{children:[e.jsx(G,{children:e.jsxs(u,{children:[e.jsx(m,{children:"Page"}),e.jsx(m,{className:"text-center",children:"Public"}),e.jsx(m,{className:"text-center",children:"Utilisateur"}),e.jsx(m,{className:"text-center",children:"Adhérent"}),e.jsx(m,{className:"text-center",children:"Bureau"}),e.jsx(m,{className:"text-center",children:"Encadrant"}),e.jsx(m,{className:"text-center",children:"Admin"})]})}),e.jsx(J,{children:o.map((s,a)=>e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:s.text}),["public","user","adherent","bureau","encadrant","admin"].map(i=>e.jsx(t,{className:"text-center",children:e.jsx(r,{checked:s.roles.includes(i),onCheckedChange:h=>je(a,i,h)})},i))]},s.to))})]})}),e.jsx(Z,{children:e.jsxs(j,{onClick:fe,disabled:y,children:[y?e.jsx(_,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx(Ge,{className:"w-4 h-4 mr-2"}),"Sauvegarder les Accès du Menu"]})})]})}),e.jsx(z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},children:e.jsxs(U,{children:[e.jsxs(O,{children:[e.jsx(H,{children:"Permissions Spéciales"}),e.jsx(B,{children:"Définissez les permissions avancées pour chaque rôle."})]}),e.jsx(V,{children:e.jsxs($,{children:[e.jsx(G,{children:e.jsxs(u,{children:[e.jsx(m,{children:"Permission"}),e.jsx(m,{className:"text-center",children:"Adhérent"}),e.jsx(m,{className:"text-center",children:"Bureau"}),e.jsx(m,{className:"text-center",children:"Encadrant"}),e.jsx(m,{className:"text-center",children:"Admin"})]})}),e.jsxs(J,{children:[e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:"Voir le nom de famille en entier"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:"Éditer la fiche d'un membre"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:"Supprimer un membre"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:"Accéder aux logs de connexion"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:"Gestion des rôles & accès"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:"Ajouter une fiche pédagogique"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:"Créer/modifier une compétition"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]})]})]})}),e.jsx(Z,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"Note :"})," Ces permissions sont définies dans le code et ne peuvent pas être modifiées ici. Ce tableau sert de référence pour comprendre les droits de chaque rôle."]})})]})})]}),e.jsx(Se,{children:T&&e.jsx(We,{isOpen:T,onClose:()=>X(!1),onUserCreated:A})})]}):e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Accès non autorisé"}),e.jsx("p",{className:"text-muted-foreground",children:"Cette page est réservée aux administrateurs."})]})};export{es as default};

import{x as U,r as i,w as W,l as q,y as C,j as e,z as F,H as G,D as h,G as y,J as B,K as H,aa as K,W as N,N as Q,O as X,Q as Y,U as Z,V as ee,B as te,o as se,p as ae,q as I,s as T,t as ne,v as k,az as re,aB as ie,X as ce}from"./index-1760781166799.js";import{C as le}from"./calendar-check-1760781166799.js";import{C as oe}from"./check-circle-2-1760781166799.js";const xe=()=>{const{isAdmin:v,isEncadrant:b,loading:w}=U(),[o,V]=i.useState([]),[n,D]=i.useState(""),[E,z]=i.useState([]),[u,J]=i.useState([]),[L,f]=i.useState(!0),{toast:p}=W(),A=q();i.useEffect(()=>{if(!w&&!v&&!b){A("/schedule");return}},[v,b,w,A]);const R=i.useCallback(async()=>{try{const{data:t,error:a}=await C.from("schedules").select("id, type, age_category, day, start_time, end_time").order("day").order("start_time");if(a)throw a;V(t||[]),t&&t.length>0&&!n&&D(t[0].id)}catch(t){console.error("Error fetching schedules:",t),p({title:"Erreur",description:"Impossible de charger les plannings.",variant:"destructive"})}},[n,p]),M=(t,a,d)=>{const c=[`${t} ${a}`,`${a} ${t}`,a,t].map(r=>r.toLowerCase().trim());console.log("Termes de recherche:",c);for(const r of d){const m=r.toLowerCase();for(const l of c)if(m===l||m.includes(l)||l.includes(m))return console.log(`Match trouvé: "${r}" correspond à "${l}"`),r}return null},P=i.useCallback(async()=>{if(!n){f(!1);return}f(!0);try{const t=o.find(s=>s.id===n);if(!t){z([]),f(!1);return}console.log("Schedule sélectionné:",t);const{data:a,error:d}=await C.from("sessions").select("id, date, start_time, students, schedule_id").not("date","is",null).order("date",{ascending:!0}).order("start_time",{ascending:!0});if(d)throw d;console.log("Toutes les sessions récupérées:",a);const c=a.filter(s=>{if(s.schedule_id===n)return!0;if(s.date&&s.start_time){const g=new Date(s.date),_=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"][g.getDay()],O=s.start_time.substring(0,5);return _===t.day&&O===t.start_time.substring(0,5)}return!1});console.log("Sessions filtrées pour le schedule:",c),J(c||[]);const{data:r}=await C.from("secure_members").select("id, first_name, last_name, title").not("title","is",null),m=[...new Set((r==null?void 0:r.map(s=>s.title))||[])];console.log("Titles disponibles:",m);const l=M(t.type,t.age_category,m);console.log("Title correspondant trouvé:",l);let S=[];l&&(S=r.filter(s=>s.title===l)),console.log("Membres trouvés:",S);const $=(S||[]).map(s=>{const g={member:s,sessions:{}};return(c||[]).forEach(j=>{const _=j.students&&j.students.includes(s.id);g.sessions[j.id]=_}),g});console.log("Données de présence construites:",$),z($)}catch(t){console.error("Error fetching attendance data:",t),p({title:"Erreur",description:"Impossible de charger les données de présence.",variant:"destructive"})}finally{f(!1)}},[n,o,p]);if(i.useEffect(()=>{R()},[R]),i.useEffect(()=>{n&&o.length>0&&P()},[n,o.length,P]),w||L)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(F,{className:"w-12 h-12 animate-spin text-primary"})});if(!v&&!b)return e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Accès non autorisé"}),e.jsx("p",{className:"text-muted-foreground",children:"Cette page est réservée aux administrateurs et encadrants."})]});const x=o.find(t=>t.id===n);return e.jsxs("div",{className:"space-y-8",children:[e.jsxs(G,{children:[e.jsx("title",{children:"Récapitulatif de Présence - ALJ Escalade Jonage"}),e.jsx("meta",{name:"description",content:"Récapitulatif des présences des élèves aux séances d'entraînement."})]}),e.jsx(h.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(le,{className:"w-10 h-10 text-primary"}),"Récapitulatif de Présence"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Consultez les présences des élèves par planning"})]})}),e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},children:e.jsxs(y,{children:[e.jsx(B,{children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-6 h-6"}),"Sélectionner un Planning"]})}),e.jsx(N,{children:e.jsxs(Q,{value:n,onValueChange:D,children:[e.jsx(X,{className:"w-full",children:e.jsx(Y,{placeholder:"Choisissez un planning..."})}),e.jsx(Z,{children:o.map(t=>e.jsx(ee,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{variant:"outline",children:t.type}),e.jsx("span",{children:t.age_category}),e.jsxs("span",{className:"text-muted-foreground",children:["- ",t.day," ",t.start_time]})]})},t.id))})]})})]})}),x&&u.length>0&&e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsxs(y,{children:[e.jsx(B,{children:e.jsxs(H,{children:["Présences - ",x.type," ",x.age_category]})}),e.jsx(N,{className:"overflow-x-auto",children:E.length>0?e.jsxs(se,{children:[e.jsx(ae,{children:e.jsxs(I,{children:[e.jsx(T,{className:"sticky left-0 bg-background z-10 min-w-[180px]",children:"Élève"}),u.map(t=>e.jsx(T,{className:"text-center min-w-[120px]",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"font-semibold",children:new Date(t.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit"})}),e.jsx("span",{className:"text-xs text-muted-foreground font-normal",children:t.start_time})]})},t.id)),e.jsx(T,{className:"text-center font-bold sticky right-0 bg-background z-10 min-w-[100px]",children:"Total"})]})}),e.jsx(ne,{children:E.map(({member:t,sessions:a})=>{const d=Object.values(a).filter(Boolean).length;return e.jsxs(I,{children:[e.jsx(k,{className:"font-medium sticky left-0 bg-background z-10",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-4 h-4 text-primary"}),e.jsx("span",{children:ie(t.first_name,t.last_name,!0)})]})}),u.map(c=>e.jsx(k,{className:"text-center",children:a[c.id]?e.jsx(oe,{className:"w-5 h-5 text-green-500 mx-auto"}):e.jsx(ce,{className:"w-5 h-5 text-gray-300 mx-auto"})},c.id)),e.jsxs(k,{className:"text-center font-bold sticky right-0 bg-background z-10 text-primary",children:[d," / ",u.length]})]},t.id)})})]}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"Aucun élève trouvé pour ce planning."})})]})}),x&&u.length===0&&!L&&e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsx(y,{children:e.jsx(N,{className:"py-12",children:e.jsx("p",{className:"text-muted-foreground text-center",children:"Aucune séance enregistrée pour ce planning."})})})}),!x&&e.jsx(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsx(y,{children:e.jsx(N,{className:"py-12",children:e.jsx("p",{className:"text-muted-foreground text-center",children:"Veuillez sélectionner un planning pour afficher les présences."})})})})]})};export{xe as default};

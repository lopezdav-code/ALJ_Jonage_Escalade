import{aE as xe,r,O as ne,a_ as ge,j as e,a$ as _e,b0 as je,b1 as pe,ai as fe,B as j,L as c,E as ve,I as N,n as F,o as U,p as I,q as A,s as f,g as ye,ak as w,ap as Ce,a2 as Ne,R as ce,D as z,h as W,i as X,k as K,l as we,aS as Q,aT as Y,aV as Z,aU as b,aW as ee,aX as J,t as S,b2 as Se,b3 as Ee,b4 as me,aj as Fe,a8 as se,a0 as Ue,u as Ie,ah as Ae,U as ke,a1 as De,b5 as Le}from"./index-1760370975611.js";import{U as Oe}from"./upload-cloud-1760370975611.js";import{C as te}from"./chevrons-up-down-1760370975611.js";const ae={"Loisir enfants":["mercredi 13h Groupe A","mercredi 13h Groupe B","mercredi 16h","vendredi"],"Loisir collége":["Mardi 18h","Jeudi 18h"],"Loisir lycée":[],"Loisir adulte":[],"Adultes autonomes":[],"Compétition U11-U15":[],"Compétition U15-U19":[],Bénévole:[],Bureau:[],emergency_contact:[]},$e=["U11","U13","U15","U17","U19"],Be=["Blanc","Jaune","Orange","Vert","Bleu","Violet","Rouge"],Me=["Initiateur SAE","Juge Bloc 1","Juge Bloc 2","Juge Bloc 3","Juge de difficulté 1","Juge de difficulté 2","Juge de difficulté 3","Gestionanaire EPI","Entraineur d'escalade 1","Entraineur d'escalade 2"],Pe=({member:s,onSave:k,onCancel:M,isSaving:v})=>{const d=xe.useMemo(()=>(s==null?void 0:s.id)||`new-${Date.now()}`,[s==null?void 0:s.id]),[a,y]=r.useState({first_name:(s==null?void 0:s.first_name)||"",last_name:(s==null?void 0:s.last_name)||"",title:(s==null?void 0:s.title)||"",sub_group:(s==null?void 0:s.sub_group)||"",category:(s==null?void 0:s.category)||"",phone:(s==null?void 0:s.phone)||"",photo_url:(s==null?void 0:s.photo_url)||null,sexe:(s==null?void 0:s.sexe)||"",licence:(s==null?void 0:s.licence)||"",email:(s==null?void 0:s.email)||"",passeport:(s==null?void 0:s.passeport)||"",emergency_contact_1_id:(s==null?void 0:s.emergency_contact_1_id)||null,emergency_contact_2_id:(s==null?void 0:s.emergency_contact_2_id)||null,brevet_federaux:(s==null?void 0:s.brevet_federaux)||[]}),[D,L]=r.useState(null),[E,p]=r.useState(null),[u,P]=r.useState([]),[R,m]=r.useState(!1),[O,o]=r.useState(!1),[g,i]=r.useState(null),[T,q]=r.useState([]),{toast:C}=ne();r.useEffect(()=>{(async()=>{const{data:n,error:l}=await S.from("members").select("id, first_name, last_name").order("last_name").order("first_name");l||P(n)})(),s!=null&&s.id&&(async()=>{const{data:l,error:x}=await S.from("members").select("id, first_name, last_name").or(`emergency_contact_1_id.eq.${s.id},emergency_contact_2_id.eq.${s.id}`);x||q(l)})(),s!=null&&s.photo_url?ge(s.photo_url).then(n=>p(n)).catch(n=>{console.error("Erreur chargement image:",n),p(null)}):p(null)},[s]);const $=r.useMemo(()=>s!=null&&s.emergency_contact_1&&typeof s.emergency_contact_1=="object"&&s.emergency_contact_1.id===a.emergency_contact_1_id?s.emergency_contact_1:u.find(t=>t.id===a.emergency_contact_1_id),[u,a.emergency_contact_1_id,s==null?void 0:s.emergency_contact_1]),B=r.useMemo(()=>s!=null&&s.emergency_contact_2&&typeof s.emergency_contact_2=="object"&&s.emergency_contact_2.id===a.emergency_contact_2_id?s.emergency_contact_2:u.find(t=>t.id===a.emergency_contact_2_id),[u,a.emergency_contact_2_id,s==null?void 0:s.emergency_contact_2]),h=t=>{const{name:n,value:l}=t.target;y(x=>({...x,[n]:l}))},_=(t,n)=>{const l={...a,[t]:n};t==="title"&&(l.sub_group=""),y(l)},ie=t=>{y(n=>{const l=n.brevet_federaux.includes(t)?n.brevet_federaux.filter(x=>x!==t):[...n.brevet_federaux,t];return{...n,brevet_federaux:l}})},le=t=>{if(t.target.files&&t.target.files[0]){const n=t.target.files[0];L(n),p(URL.createObjectURL(n)),y(l=>({...l,photo_url:URL.createObjectURL(n)}))}},re=()=>{L(null),p(null),y(t=>({...t,photo_url:null}))},oe=t=>{t.preventDefault();const{isEmergencyContactFor:n,is_emergency_contact_for_others:l,...x}=a;k({...x},D)},de=async t=>{if(!s||!s.id){C({title:"Erreur",description:"Le membre actuel doit être sauvegardé avant de pouvoir être défini comme contact d'urgence.",variant:"destructive"});return}const{data:n,error:l}=await S.from("members").select("emergency_contact_1_id, emergency_contact_2_id").eq("id",t).single();if(l){C({title:"Erreur",description:"Impossible de récupérer les informations du membre cible.",variant:"destructive"});return}let x;if(!n.emergency_contact_1_id)x={emergency_contact_1_id:s.id};else if(!n.emergency_contact_2_id)x={emergency_contact_2_id:s.id};else{C({title:"Information",description:"Ce membre a déjà deux contacts d'urgence.",variant:"default"});return}const{error:he}=await S.from("members").update(x).eq("id",t);he?C({title:"Erreur",description:"Échec de la mise à jour du contact d'urgence.",variant:"destructive"}):(C({title:"Succès",description:"Contact d'urgence défini avec succès.",variant:"success"}),m(!1))},V=t=>{i(t),o(!0)},G=t=>{g&&_(g,t),o(!1),i(null)},H=a.title?ae[a.title]||[]:[],ue=t=>t.includes("Initiateur")?e.jsx(Se,{className:"h-4 w-4"}):t.includes("Juge Bloc")?e.jsx(Ee,{className:"h-4 w-4"}):t.includes("Juge de difficulté")?e.jsx(me,{className:"h-4 w-4"}):t.includes("Gestionnaire")?e.jsx(Fe,{className:"h-4 w-4"}):t.includes("Entraîneur")?e.jsx(se,{className:"h-4 w-4"}):e.jsx(se,{className:"h-4 w-4"});return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:oe,children:[e.jsxs("div",{className:"grid gap-3 py-2 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsxs(_e,{className:"w-20 h-20",children:[e.jsx(je,{src:E,alt:"Avatar"}),e.jsx(pe,{className:"text-3xl",children:e.jsx(fe,{className:"w-12 h-12"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"button",asChild:!0,variant:"outline",children:e.jsxs(c,{htmlFor:`photo-upload-${d}`,className:"cursor-pointer",children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"})," Changer"]})}),E&&e.jsxs(j,{type:"button",variant:"destructive",onClick:re,children:[e.jsx(ve,{className:"mr-2 h-4 w-4"})," Supprimer"]})]}),e.jsx(N,{id:`photo-upload-${d}`,type:"file",className:"hidden",onChange:le,accept:"image/*"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Prénom"}),e.jsx(N,{name:"first_name",value:a.first_name,onChange:h,required:!0})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Nom"}),e.jsx(N,{name:"last_name",value:a.last_name,onChange:h,required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Email"}),e.jsx(N,{name:"email",type:"email",value:a.email||"",onChange:h})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Téléphone"}),e.jsx(N,{name:"phone",type:"tel",value:a.phone||"",onChange:h})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Sexe"}),e.jsxs(F,{name:"sexe",value:a.sexe||"",onValueChange:t=>_("sexe",t),children:[e.jsx(U,{children:e.jsx(I,{placeholder:"Sexe"})}),e.jsxs(A,{children:[e.jsx(f,{value:"H",children:"Homme"}),e.jsx(f,{value:"F",children:"Femme"})]})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Licence"}),e.jsx(N,{name:"licence",value:a.licence||"",onChange:h})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Titre/Catégorie"}),e.jsxs(F,{name:"title",value:a.title,onValueChange:t=>_("title",t),children:[e.jsx(U,{children:e.jsx(I,{placeholder:"Catégorie"})}),e.jsx(A,{children:Object.keys(ae).map(t=>e.jsx(f,{value:t,children:t},t))})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Sous-groupe"}),e.jsxs(F,{name:"sub_group",value:a.sub_group,onValueChange:t=>_("sub_group",t),disabled:H.length===0,children:[e.jsx(U,{children:e.jsx(I,{placeholder:"Sous-groupe"})}),e.jsx(A,{children:H.map(t=>e.jsx(f,{value:t,children:t},t))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(c,{children:"Catégorie d'âge (Compétition)"}),e.jsxs(F,{name:"category",value:a.category||"",onValueChange:t=>_("category",t),children:[e.jsx(U,{children:e.jsx(I,{placeholder:"Catégorie d'âge"})}),e.jsxs(A,{children:[e.jsx(f,{value:"",children:"Aucune"}),$e.map(t=>e.jsx(f,{value:t,children:t},t))]})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Passeport"}),e.jsxs(F,{name:"passeport",value:a.passeport||"",onValueChange:t=>_("passeport",t),children:[e.jsx(U,{children:e.jsx(I,{placeholder:"Passeport"})}),e.jsxs(A,{children:[e.jsx(f,{value:"",children:"Aucun"}),Be.map(t=>e.jsx(f,{value:t,children:t},t))]})]})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Brevets Fédéraux"}),e.jsx("div",{className:"grid grid-cols-2 gap-1 mt-2",children:Me.map(t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{id:`b-${d}-${t}`,checked:a.brevet_federaux.includes(t),onCheckedChange:()=>ie(t)})," ",ue(t)," ",e.jsx(c,{htmlFor:`b-${d}-${t}`,className:"font-normal text-sm",children:t})]},t))})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Contact d'urgence 1"}),e.jsxs(j,{variant:"outline",type:"button",className:"w-full justify-between",onClick:()=>V("emergency_contact_1_id"),children:[$?w($.first_name,$.last_name,!0):"Sélectionner un contact",e.jsx(te,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Contact d'urgence 2"}),e.jsxs(j,{variant:"outline",type:"button",className:"w-full justify-between",onClick:()=>V("emergency_contact_2_id"),children:[B?w(B.first_name,B.last_name,!0):"Sélectionner un contact",e.jsx(te,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})]}),(s==null?void 0:s.id)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(j,{type:"button",variant:"secondary",onClick:()=>m(!0),className:"w-full",children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"})," Je suis le contact de..."]}),T.length>0&&e.jsxs("div",{children:[e.jsxs(c,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"})," Contact d'urgence pour :"]}),e.jsx("ul",{className:"text-sm list-disc list-inside mt-1",children:T.map(t=>e.jsx("li",{children:w(t.first_name,t.last_name,!0)},t.id))})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(j,{type:"button",variant:"outline",onClick:M,children:"Annuler"}),e.jsxs(j,{type:"submit",disabled:v,children:[v&&e.jsx(ce,{className:"mr-2 h-4 w-4 animate-spin"}),"Enregistrer"]})]})]}),e.jsx(z,{open:R,onOpenChange:m,children:e.jsxs(W,{children:[e.jsxs(X,{children:[e.jsx(K,{children:"Définir comme contact d'urgence"}),e.jsxs(we,{children:["Sélectionnez le membre pour lequel ",w(a.first_name,a.last_name,!0)," sera le contact d'urgence."]})]}),e.jsxs(Q,{children:[e.jsx(Y,{placeholder:"Rechercher un membre..."}),e.jsxs(Z,{children:[e.jsx(b,{children:"Aucun membre trouvé."}),e.jsx(ee,{children:u.filter(t=>t.id!==(s==null?void 0:s.id)).map(t=>e.jsx(J,{value:`${t.first_name} ${t.last_name}`,onSelect:()=>de(t.id),children:w(t.first_name,t.last_name,!0)},t.id))})]})]})]})}),e.jsx(z,{open:O,onOpenChange:o,children:e.jsxs(W,{children:[e.jsx(X,{children:e.jsx(K,{children:"Sélectionner un contact d'urgence"})}),e.jsxs(Q,{children:[e.jsx(Y,{placeholder:"Rechercher un membre..."}),e.jsxs(Z,{children:[e.jsx(b,{children:"Aucun membre trouvé."}),e.jsxs(ee,{children:[e.jsx(J,{onSelect:()=>G(null),children:"Aucun"}),u.filter(t=>t.id!==(s==null?void 0:s.id)).map(t=>e.jsx(J,{value:`${t.first_name} ${t.last_name}`,onSelect:()=>G(t.id),children:w(t.first_name,t.last_name,!0)},t.id))]})]})]})]})})]})},qe=()=>{var O;const{id:s}=Ue(),k=Ie(),M=Ae(),{toast:v}=ne(),[d,a]=r.useState(null),[y,D]=r.useState(!0),[L,E]=r.useState(!1),p=(O=M.state)==null?void 0:O.fromTab,u=()=>{const o=p?`/volunteers?tab=${encodeURIComponent(p)}`:"/volunteers";k(o)};r.useEffect(()=>{s&&(async()=>{D(!0);const{data:g,error:i}=await S.from("members").select(`
          *,
          emergency_contact_1:emergency_contact_1_id(id, first_name, last_name, phone),
          emergency_contact_2:emergency_contact_2_id(id, first_name, last_name, phone)
        `).eq("id",s).single();if(i){console.error("Erreur chargement membre:",i),v({title:"Erreur",description:"Impossible de charger les informations du membre",variant:"destructive"}),u();return}a(g),D(!1)})()},[s,k,v]);const P=async(o,g)=>{const i=await Le(o,{first_name:g.first_name,last_name:g.last_name});if(!i.success)throw new Error(i.error||"Erreur lors de l'upload de l'image");return i.filePath},R=async(o,g)=>{E(!0);try{let i=o.photo_url;g?i=await P(g,o):o.photo_url===null&&(i=null);const{profiles:T,dynamic_roles:q,isEmergencyContactFor:C,emergency_contact_1:$,emergency_contact_2:B,...h}={...o,photo_url:i};h.passeport===""&&(h.passeport=null),h.sexe===""&&(h.sexe=null);const{error:_}=await S.from("members").update(h).eq("id",s);if(_)throw _;v({title:"Succès",description:"Membre modifié avec succès"})}catch(i){console.error("Erreur lors de la sauvegarde:",i),v({title:"Erreur",description:"Erreur lors de la modification du membre",variant:"destructive"})}finally{E(!1)}},m=()=>{u()};return y?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(ce,{className:"w-12 h-12 animate-spin text-primary"})}):d?e.jsxs("div",{className:"p-4 max-w-4xl mx-auto",children:[e.jsx(ke,{children:e.jsxs("title",{children:["Modifier ",d.first_name," ",d.last_name," - Club d'Escalade"]})}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(j,{variant:"ghost",onClick:()=>u(),className:"mb-2",children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Retour aux adhérents"]}),e.jsxs("h1",{className:"text-xl font-bold",children:["Modifier ",d.first_name," ",d.last_name]})]}),e.jsx(Pe,{member:d,onSave:R,onCancel:m,isSaving:L})]}):e.jsxs("div",{className:"text-center",children:[e.jsx("p",{children:"Membre non trouvé"}),e.jsx(j,{onClick:()=>u(),className:"mt-4",children:"Retour aux adhérents"})]})};export{qe as default};

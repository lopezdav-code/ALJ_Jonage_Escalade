import{Y as X,r as t,x as Y,w as z,y as f,j as e,af as Z,H as ee,D as T,m as v,F as se,G as ae,J as te,K as re,ah as ie,W as ne,z as L,o as le,p as ce,q as $,s as k,t as oe,v as E,B as _,X as F,L as de,N as P,O as I,Q as O,U as H,V as q,T as me,ag as ue,aO as he,aP as xe,aQ as je,S as V,I as R,a1 as pe,a2 as fe,a3 as ve,a4 as ge,a5 as be,M as A,aj as we,aR as ye}from"./index-1760862795448.js";import{A as Ce,h as Ne,a as Se,b as Le,c as ke,d as Ee,e as _e,f as Ae,g as De}from"./alert-dialog-1760862795448.js";import{U as Re}from"./user-cog-1760862795448.js";const Me=X("MailCheck",[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m16 19 2 2 4-4",key:"1b14m6"}]]);function M(m,u,g=!1){if(!m)return u||"";if(!u)return m||"";const h=m.charAt(0).toUpperCase()+m.slice(1).toLowerCase();if(g){const c=u.toUpperCase();return`${h} ${c}`}const j=`${u.charAt(0).toUpperCase()}.`;return`${h} ${j}`}const B=["admin","bureau","encadrant","adherent","user"],G=({onSelect:m,children:u,existingLinks:g})=>{const[h,j]=t.useState(!1),[c,r]=t.useState(""),[i,w]=t.useState([]),[x,b]=t.useState(!1),[p,d]=t.useState([]);t.useEffect(()=>{(async()=>{const{data:n}=await f.from("secure_members").select("id, first_name, last_name");n&&d(n)})()},[]),t.useEffect(()=>{if(!h)return;b(!0);const o=p.filter(n=>!g.includes(n.id)&&(c===""||`${n.first_name} ${n.last_name}`.toLowerCase().includes(c.toLowerCase()))).slice(0,10);w(o),b(!1)},[c,h,g,p]);const y=o=>{m(o),j(!1),r("")};return e.jsxs(he,{open:h,onOpenChange:j,children:[e.jsx(xe,{asChild:!0,children:u}),e.jsxs(je,{className:"w-80 p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(V,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(R,{placeholder:"Rechercher un membre...",value:c,onChange:o=>r(o.target.value),className:"pl-8"})]})}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:x?e.jsx("div",{className:"flex justify-center p-4",children:e.jsx(L,{className:"h-5 w-5 animate-spin"})}):i.length>0?i.map(o=>e.jsx("div",{onClick:()=>y(o),className:"p-2 hover:bg-accent cursor-pointer text-sm",children:M(o.first_name,o.last_name,!0)},o.id)):e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"Aucun membre trouvé."})})]})]})},Ue=({isOpen:m,onClose:u,onUserCreated:g})=>{const[h,j]=t.useState(""),[c,r]=t.useState(""),[i,w]=t.useState("user"),[x,b]=t.useState(null),[p,d]=t.useState(!1),{toast:y}=z(),o=async n=>{n.preventDefault(),d(!0);try{const{data:C,error:D}=await f.functions.invoke("admin-create-user",{body:{email:h,password:c,role:i,member_id:(x==null?void 0:x.id)||null}});if(D||!C||!C.user)throw new Error("La création de l'utilisateur a échoué.");y({title:"Succès",description:"Utilisateur créé avec succès."}),g(),u()}catch(C){y({title:"Erreur",description:C.message,variant:"destructive"})}finally{d(!1)}};return e.jsx(pe,{open:m,onOpenChange:u,children:e.jsxs(fe,{children:[e.jsxs(ve,{children:[e.jsx(ge,{children:"Créer un nouvel utilisateur"}),e.jsx(be,{children:"Créez un compte et liez-le à un profil de membre existant. Le compte sera validé automatiquement."})]}),e.jsxs("form",{onSubmit:o,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"email",children:"Email"}),e.jsx(R,{id:"email",type:"email",value:h,onChange:n=>j(n.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"password",children:"Mot de passe"}),e.jsx(R,{id:"password",type:"password",value:c,onChange:n=>r(n.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Rôle"}),e.jsxs(P,{value:i,onValueChange:w,children:[e.jsx(I,{children:e.jsx(O,{})}),e.jsx(H,{children:B.map(n=>e.jsx(q,{value:n,children:e.jsx("span",{className:"capitalize",children:n})},n))})]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Lier à un membre"}),x?e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-md",children:[e.jsx("span",{children:M(x.first_name,x.last_name,!0)}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>b(null),children:e.jsx(F,{className:"h-4 w-4"})})]}):e.jsx(G,{onSelect:b,existingLinks:[],children:e.jsxs(v,{variant:"outline",className:"w-full justify-start font-normal",children:[e.jsx(V,{className:"mr-2 h-4 w-4"})," Rechercher un membre..."]})})]}),e.jsxs(we,{children:[e.jsx(v,{type:"button",variant:"outline",onClick:u,children:"Annuler"}),e.jsxs(v,{type:"submit",disabled:p,children:[p?e.jsx(L,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Créer l'utilisateur"]})]})]})]})})},Fe=()=>{const[m,u]=t.useState([]),[g,h]=t.useState(!0),[j,c]=t.useState(null),{user:r}=Y(),{toast:i}=z(),[w,x]=t.useState(!1),[b,p]=t.useState(null),d=t.useCallback(async()=>{if(r){h(!0);try{const{data:s,error:a}=await f.from("profiles").select("*, members(id, first_name, last_name)");if(a)throw a;const{data:l,error:S}=await f.functions.invoke("get-users",{body:{userId:r.id}});if(S)throw S;if(l.error)throw new Error(l.error);const J=l.users,K=s.map(U=>{const N=J.find(W=>W.id===U.id);return{...U,email:N==null?void 0:N.email,email_confirmed_at:N==null?void 0:N.email_confirmed_at}});u(K)}catch(s){i({title:"Erreur",description:`Impossible de charger les utilisateurs: ${s.message}`,variant:"destructive"})}finally{h(!1)}}},[r==null?void 0:r.id,i]);t.useEffect(()=>{r!=null&&r.id&&d()},[r==null?void 0:r.id,d]);const y=t.useMemo(()=>m.map(s=>s.member_id).filter(Boolean),[m]),o=async(s,a)=>{p(s);const{error:l}=await f.from("profiles").update({member_id:a.id}).eq("id",s);l?i({title:"Erreur",description:"Impossible de lier le membre.",variant:"destructive"}):(i({title:"Succès",description:"Membre lié au profil."}),d()),p(null)},n=async s=>{p(s);const{error:a}=await f.from("profiles").update({member_id:null}).eq("id",s);a?i({title:"Erreur",description:"Impossible de délier le membre.",variant:"destructive"}):(i({title:"Succès",description:"Membre délié du profil."}),d()),p(null)},C=async(s,a)=>{c(s);try{const{data:l,error:S}=await f.functions.invoke("set-user-role",{body:{userId:s,role:a}});if(S)throw S;if(l.error)throw new Error(l.error);i({title:"Succès",description:"Le rôle a été mis à jour."}),d()}catch(l){i({title:"Erreur",description:l.message,variant:"destructive"})}finally{c(null)}},D=async(s,a)=>{c(s);try{const{error:l}=await f.functions.invoke("confirm-user",{body:{userId:s}});if(l)throw l;i({title:"Succès",description:`L'email de ${a} a été confirmé.`}),d()}catch(l){i({title:"Erreur",description:l.message,variant:"destructive"})}finally{c(null)}},Q=async s=>{c(s.id);try{const{data:a,error:l}=await f.functions.invoke("delete-user",{body:{userId:s.id}});if(l)throw new Error(`Function error: ${l.message}`);if(a.error)throw new Error(`Function returned error: ${a.error}`);i({title:"Succès",description:`L'utilisateur ${s.email} a été supprimé.`}),d()}catch(a){i({title:"Erreur",description:a.message,variant:"destructive"})}finally{c(null)}};return e.jsxs(Z,{pageTitle:"Gestion des Rôles",children:[e.jsxs("div",{className:"space-y-8",children:[e.jsx(ee,{children:e.jsx("title",{children:"Gestion des Rôles"})}),e.jsxs(T.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(Re,{className:"w-10 h-10 text-primary"}),"Gestion des Rôles Utilisateurs"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Gérez les rôles des utilisateurs et leurs comptes."})]}),e.jsxs(v,{onClick:()=>x(!0),children:[e.jsx(se,{className:"mr-2 h-4 w-4"})," Créer un utilisateur"]})]}),e.jsx(T.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},children:e.jsxs(ae,{children:[e.jsxs(te,{children:[e.jsx(re,{children:"Rôles des Utilisateurs"}),e.jsx(ie,{children:"Liste de tous les utilisateurs inscrits."})]}),e.jsx(ne,{children:g?e.jsx("div",{className:"flex justify-center items-center py-16",children:e.jsx(L,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs(le,{children:[e.jsx(ce,{children:e.jsxs($,{children:[e.jsx(k,{children:"Email"}),e.jsx(k,{children:"Adhérent Lié"}),e.jsx(k,{children:"Rôle"}),e.jsx(k,{className:"text-right",children:"Actions"})]})}),e.jsx(oe,{children:m.map(s=>e.jsxs($,{children:[e.jsxs(E,{className:"font-medium truncate max-w-[200px]",children:[s.email,s.email_confirmed_at?e.jsx(_,{variant:"outline",className:"ml-2 border-green-500 text-green-500",children:"Confirmé"}):e.jsx(_,{variant:"destructive",className:"ml-2",children:"Non confirmé"})]}),e.jsx(E,{children:b===s.id?e.jsx(L,{className:"h-4 w-4 animate-spin"}):s.members?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:"secondary",className:"truncate",children:M(s.members.first_name,s.members.last_name,!0)}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>n(s.id),children:e.jsx(F,{className:"h-4 w-4"})})]}):e.jsx(G,{onSelect:a=>o(s.id,a),existingLinks:y,children:e.jsxs(v,{variant:"outline",size:"sm",children:[e.jsx(de,{className:"mr-2 h-4 w-4"})," Lier"]})})}),e.jsx(E,{children:s.id===r.id?e.jsx(_,{children:"Vous (Admin)"}):j===s.id?e.jsx("div",{className:"flex justify-start",children:e.jsx(L,{className:"w-5 h-5 animate-spin"})}):e.jsxs(P,{value:s.role||"user",onValueChange:a=>C(s.id,a),children:[e.jsx(I,{className:"w-[120px]",children:e.jsx(O,{placeholder:"Rôle"})}),e.jsx(H,{children:B.map(a=>e.jsx(q,{value:a,children:e.jsx("span",{className:"capitalize",children:a})},a))})]})}),e.jsx(E,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.id!==r.id&&!s.email_confirmed_at&&e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>D(s.id,s.email),disabled:j===s.id,children:[e.jsx(Me,{className:"h-4 w-4 mr-1"})," Confirmer"]}),s.id!==r.id&&e.jsxs(Ce,{children:[e.jsx(Ne,{asChild:!0,children:e.jsx(v,{variant:"destructive",size:"icon",disabled:j===s.id,children:e.jsx(me,{className:"h-4 w-4"})})}),e.jsxs(Se,{children:[e.jsxs(Le,{children:[e.jsx(ke,{children:"Êtes-vous sûr ?"}),e.jsxs(Ee,{children:["Cette action est irréversible. Elle supprimera définitivement le compte de ",e.jsx("strong",{children:s.email}),"."]})]}),e.jsxs(_e,{children:[e.jsx(Ae,{children:"Annuler"}),e.jsx(De,{onClick:()=>Q(s),children:"Supprimer"})]})]})]})]})})]},s.id))})]})})]})})]}),e.jsx(ue,{children:w&&e.jsx(Ue,{isOpen:w,onClose:()=>x(!1),onUserCreated:d})})]})};export{Fe as default};

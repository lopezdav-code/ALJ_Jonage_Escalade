import{l as ee,a6 as te,w as se,r as d,y as N,j as e,af as ae,m,a9 as ie,G as f,J as j,K as v,W as _,M as r,I as c,z as L,aH as P,N as D,O as I,Q as A,U as V,V as R,ae as re,_ as T,aI as le,X as oe,aJ as ne}from"./index-1760860133980.js";import{I as b}from"./info-1760860133980.js";import{U as C}from"./upload-1760860133980.js";import{S as ce}from"./save-1760860133980.js";const ge=()=>{const y=ee(),{id:g}=te(),{toast:o}=se(),h=!!g,z={Bloc:"Escalade sur murs de 4,5m sans corde, résolution de problèmes courts et intenses",Difficulté:"Escalade en hauteur (15m+) avec corde, un seul essai pour monter le plus haut possible",Vitesse:"Duel sur voie standardisée de 15m, objectif: temps le plus rapide",Combiné:"Format olympique combinant Bloc et Difficulté en un seul classement"},[s,u]=d.useState({name:"",short_title:"",start_date:"",end_date:"",location:"",prix:"",niveau:"",nature:"",disciplines:[],categories:[],more_info_link:"",details_description:"",details_format:"",details_schedule:"",image_url:"",photo_gallery:[]}),[O,w]=d.useState(!1),[S,E]=d.useState(!1),[de,q]=d.useState(null),[p,x]=d.useState(!1),[F,U]=d.useState([]),B=["Départemental","Régional","Inter-régional","National","International"],$=["Contest","Open","Coupe","Championnat"],J=["Bloc","Difficulté","Vitesse","Combiné"],M=["U11","U13","U15","U17","U19","Sénior","Vétéran"];d.useEffect(()=>{h&&G()},[g]),d.useEffect(()=>{(async()=>{if(s.photo_gallery&&s.photo_gallery.length>0){const a=await Promise.all(s.photo_gallery.map(i=>ne(i)));U(a.filter(Boolean))}else U([])})()},[s.photo_gallery]);const G=async()=>{w(!0);try{const{data:t,error:a}=await N.from("competitions").select("*").eq("id",g).single();if(a)throw a;u({name:t.name||"",short_title:t.short_title||"",start_date:t.start_date||"",end_date:t.end_date||"",location:t.location||"",prix:t.prix||"",niveau:t.niveau||"",nature:t.nature||"",disciplines:t.disciplines||[],categories:t.categories||[],more_info_link:t.more_info_link||"",details_description:t.details_description||"",details_format:t.details_format||"",details_schedule:t.details_schedule||"",image_url:t.image_url||"",photo_gallery:t.photo_gallery||[]})}catch(t){console.error("Erreur lors du chargement:",t),o({title:"Erreur",description:"Impossible de charger la compétition.",variant:"destructive"})}finally{w(!1)}},n=(t,a)=>{u(i=>({...i,[t]:a}))},H=t=>{u(a=>({...a,disciplines:a.disciplines.includes(t)?a.disciplines.filter(i=>i!==t):[...a.disciplines,t]}))},Q=t=>{u(a=>({...a,categories:a.categories.includes(t)?a.categories.filter(i=>i!==t):[...a.categories,t]}))},K=()=>{const t=prompt("URL de la photo:");if(t){const a=new URL(t).pathname.split("/").pop();u(i=>({...i,photo_gallery:[...i.photo_gallery,a]}))}},W=t=>{u(a=>({...a,photo_gallery:a.photo_gallery.filter((i,l)=>l!==t)}))},X=async t=>{var i;console.log("handleAddPhotoFile appelé");const a=(i=t.target.files)==null?void 0:i[0];if(!a){console.log("Aucun fichier sélectionné");return}if(console.log("Fichier sélectionné:",a.name,"Taille:",a.size,"bytes"),!s.name||s.name.trim()===""){o({title:"Erreur",description:"Veuillez d'abord saisir le nom de la compétition avant d'uploader une photo.",variant:"destructive"}),t.target.value="";return}x(!0);try{console.log("Début de l'upload...");const l=await P(a,s.name);if(!l.success)throw new Error(l.error);console.log("Upload réussi, URL:",l.url),u(k=>({...k,photo_gallery:[...k.photo_gallery,l.url]})),o({title:"Succès",description:`Photo "${a.name}" ajoutée à la galerie !`,variant:"default"}),t.target.value="",q(null)}catch(l){console.error("Erreur lors de l'upload:",l),o({title:"Erreur",description:`Impossible d'uploader la photo: ${l.message}`,variant:"destructive"}),t.target.value=""}finally{x(!1)}},Y=()=>s.name.trim()?s.start_date?s.location.trim()?s.end_date&&s.end_date<s.start_date?(o({title:"Erreur",description:"La date de fin ne peut pas être antérieure à la date de début.",variant:"destructive"}),!1):!0:(o({title:"Erreur",description:"Le lieu est obligatoire.",variant:"destructive"}),!1):(o({title:"Erreur",description:"La date de début est obligatoire.",variant:"destructive"}),!1):(o({title:"Erreur",description:"Le nom de la compétition est obligatoire.",variant:"destructive"}),!1),Z=async()=>{if(Y()){E(!0);try{const t={name:s.name||"",short_title:s.short_title||"",start_date:s.start_date||"",end_date:s.end_date||null,location:s.location||"",prix:s.prix?parseFloat(s.prix):null,niveau:s.niveau||null,nature:s.nature||null,disciplines:Array.isArray(s.disciplines)&&s.disciplines.length>0?s.disciplines:[],categories:Array.isArray(s.categories)&&s.categories.length>0?s.categories:[],more_info_link:s.more_info_link||null,details_description:s.details_description||null,details_format:s.details_format||null,details_schedule:s.details_schedule||null,image_url:s.image_url||null,photo_gallery:Array.isArray(s.photo_gallery)&&s.photo_gallery.length>0?s.photo_gallery:[]};if(console.log("Sauvegarde des données:",t),console.log("Type de disciplines:",typeof t.disciplines,"Valeur:",JSON.stringify(t.disciplines)),console.log("Type de categories:",typeof t.categories,"Valeur:",JSON.stringify(t.categories)),console.log("Type de photo_gallery:",typeof t.photo_gallery,"Valeur:",JSON.stringify(t.photo_gallery)),h){const{error:a}=await N.from("competitions").update(t).eq("id",g);if(a)throw console.error("Erreur Supabase lors de la mise à jour:",a),a;o({title:"Succès",description:"Compétition modifiée avec succès !",variant:"default"})}else{const{error:a}=await N.from("competitions").insert([t]);if(a)throw console.error("Erreur Supabase lors de l'insertion:",a),a;o({title:"Succès",description:"Compétition créée avec succès !",variant:"default"})}console.log("Sauvegarde réussie, navigation vers /competitions"),y("/competitions")}catch(t){console.error("Erreur lors de la sauvegarde:",t),o({title:"Erreur",description:`Impossible de sauvegarder la compétition: ${t.message||"Erreur inconnue"}`,variant:"destructive"})}finally{console.log("Fin de la sauvegarde, setSaving(false)"),E(!1)}}};return O?e.jsx("div",{className:"flex justify-center items-center py-16",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"})}):e.jsx(ae,{pageTitle:"Éditeur de compétition",message:"Vous n'avez pas les droits nécessaires pour accéder à cette page.",children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(m,{variant:"outline",onClick:()=>y("/competitions"),children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Retour"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:h?"Modifier la compétition":"Créer une compétition"}),e.jsx("p",{className:"text-muted-foreground",children:h?"Modifiez les informations de la compétition":"Ajoutez une nouvelle compétition au club"})]})]}),e.jsxs(f,{children:[e.jsx(j,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5"}),"Informations générales"]})}),e.jsxs(_,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"name",children:"Nom de la compétition *"}),e.jsx(c,{id:"name",value:s.name,onChange:t=>n("name",t.target.value),placeholder:"Ex: Championnat Régional d'Escalade"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"short_title",children:"Titre court"}),e.jsx(c,{id:"short_title",value:s.short_title,onChange:t=>n("short_title",t.target.value),placeholder:"Ex: Régional Escalade 2024"})]})]}),e.jsxs("div",{children:[e.jsx(r,{children:"Image principale"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{id:"image_url",type:"text",value:s.image_url||"",onChange:t=>n("image_url",t.target.value),placeholder:"Chemin de l'image ou URL"}),e.jsxs(r,{htmlFor:"main-image-upload",className:`flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-md border border-input bg-background hover:bg-accent hover:text-accent-foreground ${p?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,children:[p?e.jsx(L,{className:"w-4 h-4 animate-spin"}):e.jsx(C,{className:"w-4 h-4"}),e.jsx("span",{children:"Choisir"}),e.jsx(c,{id:"main-image-upload",type:"file",className:"sr-only",onChange:async t=>{var i;const a=(i=t.target.files)==null?void 0:i[0];if(a){x(!0);try{const l=await P(a,s.name);if(!l.success)throw new Error(l.error);n("image_url",l.filePath),o({title:"Succès",description:"Image principale téléversée."})}catch(l){o({title:"Erreur",description:l.message,variant:"destructive"})}finally{x(!1)}}},accept:"image/*",disabled:p})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"start_date",children:"Date de début *"}),e.jsx(c,{id:"start_date",type:"date",value:s.start_date,onChange:t=>n("start_date",t.target.value)})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"end_date",children:"Date de fin"}),e.jsx(c,{id:"end_date",type:"date",value:s.end_date,onChange:t=>n("end_date",t.target.value)})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"location",children:"Lieu *"}),e.jsx(c,{id:"location",value:s.location,onChange:t=>n("location",t.target.value),placeholder:"Ex: Salle d'escalade de Lyon"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"prix",children:"Prix d'entrée (€)"}),e.jsx(c,{id:"prix",type:"number",step:"0.01",value:s.prix,onChange:t=>n("prix",t.target.value),placeholder:"Ex: 25.00"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"niveau",children:"Niveau"}),e.jsxs(D,{value:s.niveau,onValueChange:t=>n("niveau",t),children:[e.jsx(I,{children:e.jsx(A,{placeholder:"Sélectionner un niveau"})}),e.jsx(V,{children:B.map(t=>e.jsx(R,{value:t,children:t},t))})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(r,{htmlFor:"nature",children:"Nature"}),e.jsx(b,{className:"w-4 h-4 text-muted-foreground cursor-help",title:"Contest: Compétition locale ou régionale | Open: Compétition ouverte à tous | Coupe: Compétition officielle d'un circuit | Championnat: Compétition de haut niveau"})]}),e.jsxs(D,{value:s.nature,onValueChange:t=>n("nature",t),children:[e.jsx(I,{children:e.jsx(A,{placeholder:"Sélectionner une nature"})}),e.jsx(V,{children:$.map(t=>e.jsx(R,{value:t,children:t},t))})]})]})]})]})]}),e.jsxs(f,{children:[e.jsx(j,{children:e.jsx(v,{children:"Disciplines et catégories"})}),e.jsxs(_,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(r,{children:"Disciplines"}),e.jsx(b,{className:"w-4 h-4 text-muted-foreground cursor-help",title:"Bloc: Sprint sur 4,5m, résolution de problèmes | Difficulté: Marathon en hauteur, un essai | Vitesse: Duel rapide sur voie standardisée | Combiné: Format olympique bloc + difficulté"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:J.map(t=>e.jsx(m,{variant:s.disciplines.includes(t)?"default":"outline",size:"sm",onClick:()=>H(t),title:z[t],children:t},t))})]}),e.jsxs("div",{children:[e.jsx(r,{children:"Catégories"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:M.map(t=>e.jsx(m,{variant:s.categories.includes(t)?"default":"outline",size:"sm",onClick:()=>Q(t),children:t},t))})]})]})]}),e.jsxs(f,{children:[e.jsx(j,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5"}),"Liens et informations pratiques"]})}),e.jsxs(_,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"more_info_link",children:"Lien pour plus d'informations"}),e.jsx(c,{id:"more_info_link",type:"url",value:s.more_info_link,onChange:t=>n("more_info_link",t.target.value),placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"details_description",children:"Informations pratiques"}),e.jsx(T,{id:"details_description",value:s.details_description,onChange:t=>n("details_description",t.target.value),placeholder:"Horaires, matériel requis, consignes...",rows:3})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"details_format",children:"Format de la compétition"}),e.jsx(T,{id:"details_format",value:s.details_format,onChange:t=>n("details_format",t.target.value),placeholder:"Qualification, demi-finales, finales...",rows:3})]})]})]}),e.jsxs(f,{children:[e.jsx(j,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5"}),"Images"]})}),e.jsx(_,{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(r,{children:"Galerie photo"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{variant:"outline",size:"sm",onClick:K,children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"Ajouter URL"]}),e.jsxs(r,{htmlFor:"local-photo-upload",className:`flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-md border border-input bg-background hover:bg-accent hover:text-accent-foreground ${p?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,children:[p?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-4 h-4 animate-spin"}),"Upload en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"w-4 h-4"}),"Choisir un fichier"]}),e.jsx(c,{id:"local-photo-upload",type:"file",className:"sr-only",onChange:X,accept:"image/*",disabled:p})]})]})]}),F.length>0&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 mt-4",children:F.map((t,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:t,alt:`Photo ${a+1}`,className:"w-full h-20 object-cover rounded border"}),e.jsx(m,{variant:"destructive",size:"sm",className:"absolute top-1 right-1 w-6 h-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>W(a),children:e.jsx(oe,{className:"w-3 h-3"})})]},a))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-2 pb-8",children:[e.jsx(m,{variant:"outline",onClick:()=>y("/competitions"),children:"Annuler"}),e.jsx(m,{onClick:Z,disabled:S,children:S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Sauvegarde..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),h?"Modifier":"Créer"]})})]})]})})};export{ge as default};

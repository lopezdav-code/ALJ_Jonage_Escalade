import{x as Y,r as h,u as Q,j as e,C as W,d as I,X as Z,I as b,y as ee,o as R,t as se,v as te,w as ae,z as $,D as V,E as B,F as H,G as J,J as O,K as P,q as re,M as ne,N as ie,O as le,Q as ce,R as oe,U as de,V as me,S as ue,s as E,W as he,Y as pe,l as ge,m as xe,n as je,H as fe,p as ve}from"./index-1760451543780.js";import{B as ye}from"./book-marked-1760451543780.js";import{L as _e,a as Se}from"./lock-1760451543780.js";import{U as be}from"./upload-1760451543780.js";import{S as we}from"./save-1760451543780.js";const Ne=Y("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]),Ce=Y("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),Ee=({exercise:t,index:c,total:x,onExerciseChange:j,onRemove:n,onMove:d,onImport:f})=>{const[m,y]=h.useState(null),[v,w]=h.useState(t.image_url||null),F=Q();h.useEffect(()=>{w(t.image_url),t.image_url&&m&&t.image_url!==URL.createObjectURL(m)&&y(null)},[t.image_url]);const a=(i,N)=>{j(c,{...t,[i]:N})},u=i=>{const N=i.target.files[0];if(N){y(N);const q=URL.createObjectURL(N);w(q),j(c,{...t,newImageFile:N,image_url:q})}},k=()=>{t.pedagogy_sheet_id&&F(`/pedagogy#sheet-${t.pedagogy_sheet_id}`)};return e.jsxs(W,{className:"p-4 relative bg-muted/40",children:[e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1",children:[e.jsx(I,{type:"button",variant:"ghost",size:"icon",onClick:()=>d(c,-1),disabled:c===0,children:e.jsx(Ce,{className:"w-4 h-4"})}),e.jsx(I,{type:"button",variant:"ghost",size:"icon",onClick:()=>d(c,1),disabled:c===x-1,children:e.jsx(Ne,{className:"w-4 h-4"})}),e.jsx(I,{type:"button",variant:"ghost",size:"icon",onClick:()=>n(c),children:e.jsx(Z,{className:"w-4 h-4 text-destructive"})})]}),e.jsxs("div",{className:"absolute top-2 left-2 flex items-center gap-2",children:[e.jsxs(I,{type:"button",variant:"outline",size:"sm",onClick:f,children:[e.jsx(ye,{className:"w-4 h-4 mr-2"})," Importer"]}),t.pedagogy_sheet_id&&e.jsxs(I,{type:"button",variant:"secondary",size:"sm",onClick:k,title:"Voir la fiche pédagogique",children:[e.jsx(_e,{className:"w-4 h-4 mr-2"})," Fiche"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-12",children:[e.jsx(b,{placeholder:"Objectifs opérationnels",value:t.operational_objective||"",onChange:i=>a("operational_objective",i.target.value)}),e.jsx(b,{placeholder:"Situation",value:t.situation||"",onChange:i=>a("situation",i.target.value)}),e.jsx(b,{placeholder:"Organisation Temps/volume",value:t.organisation||"",onChange:i=>a("organisation",i.target.value)}),e.jsx(b,{placeholder:"Consigne",value:t.consigne||"",onChange:i=>a("consigne",i.target.value)}),e.jsx(b,{placeholder:"Temps (ex: 10min)",value:t.time||"",onChange:i=>a("time",i.target.value)}),e.jsx(b,{placeholder:"Critère de réussite",value:t.success_criteria||"",onChange:i=>a("success_criteria",i.target.value)}),e.jsx(b,{placeholder:"Régulation",value:t.regulation||"",onChange:i=>a("regulation",i.target.value)}),e.jsx(b,{placeholder:"Lien support",value:t.support_link||"",onChange:i=>a("support_link",i.target.value)}),e.jsxs("div",{className:"md:col-span-2 flex items-center gap-4",children:[e.jsx("div",{className:"w-24 h-24 border rounded-md flex items-center justify-center bg-background",children:v?e.jsx("img",{src:v,alt:"Aperçu",className:"w-full h-full object-cover rounded-md"}):e.jsx(ee,{className:"w-8 h-8 text-muted-foreground"})}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("label",{htmlFor:`image-upload-${c}`,children:e.jsx(I,{type:"button",variant:"outline",size:"sm",asChild:!0,className:"cursor-pointer",children:e.jsxs("span",{children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),m?"Changer l'image":"Téléverser une image"]})})}),e.jsx(b,{id:`image-upload-${c}`,type:"file",className:"hidden",accept:"image/*",onChange:u}),t.image_url&&!m&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Image actuelle. Téléversez pour remplacer."})]})]})]})]})},Ie={all:"Toutes les fiches",educational_game:"Jeu éducatif",warm_up_exercise:"Exercice d'échauffement",strength_exercise:"Exercice de renfo",review_sheet:"Fiche de révision"},G=({title:t,options:c,selected:x,onChange:j})=>{const n=x||[],d=c||[],f=()=>{n.length===d.length?j([]):j(d)};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx($,{children:t}),e.jsx(I,{type:"button",variant:"link",size:"sm",onClick:f,className:"p-0 h-auto",children:n.length===d.length?"Tout désélectionner":"Tout sélectionner"})]}),e.jsx("div",{className:"max-h-40 overflow-y-auto rounded-md border p-2 space-y-2",children:d.map(m=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ie,{id:`${t}-${m}`,checked:n.includes(m),onCheckedChange:y=>{const v=y?[...n,m]:n.filter(w=>w!==m);j(v)}}),e.jsx("label",{htmlFor:`${t}-${m}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:m})]},m))})]})},Te=({onSelect:t,onCancel:c})=>{const[x,j]=h.useState([]),[n,d]=h.useState(""),[f,m]=h.useState("all"),[y,v]=h.useState("all");h.useEffect(()=>{(async()=>{const{data:u}=await E.from("pedagogy_sheets").select("*").order("title");j(u||[])})()},[]);const w=h.useMemo(()=>{const a=x.filter(u=>u.sheet_type==="educational_game"&&u.theme).map(u=>u.theme);return["all",...Array.from(new Set(a))]},[x]),F=x.filter(a=>{const u=a.title.toLowerCase().includes(n.toLowerCase()),k=f==="all"||a.sheet_type===f,i=y==="all"||a.theme===y;return u&&k&&i});return e.jsx(le,{open:!0,onOpenChange:c,children:e.jsxs(ce,{className:"sm:max-w-[725px]",children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Importer depuis une Fiche Pédagogique"}),e.jsx(me,{children:"Sélectionnez une fiche pour remplir automatiquement l'exercice."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 mt-4",children:[e.jsxs("div",{className:"relative md:col-span-1",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground"}),e.jsx(b,{placeholder:"Rechercher une fiche...",className:"pl-10",value:n,onChange:a=>d(a.target.value)})]}),e.jsxs(V,{value:f,onValueChange:m,children:[e.jsx(B,{children:e.jsx(H,{placeholder:"Filtrer par type"})}),e.jsx(J,{children:Object.entries(Ie).map(([a,u])=>e.jsx(O,{value:a,children:u},a))})]}),e.jsxs(V,{value:y,onValueChange:v,disabled:w.length<=1,children:[e.jsx(B,{children:e.jsx(H,{placeholder:"Filtrer par thème"})}),e.jsx(J,{children:w.map(a=>e.jsx(O,{value:a,children:a==="all"?"Tous les thèmes":a},a))})]})]}),e.jsx("div",{className:"max-h-[400px] overflow-y-auto space-y-2 mt-4 pr-2",children:F.map(a=>e.jsxs("div",{className:"p-3 border rounded-md hover:bg-accent cursor-pointer",onClick:()=>t(a),children:[e.jsx("p",{className:"font-semibold",children:a.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:a.description||a.game_goal})]},a.id))})]})})},Fe=({session:t,onSave:c,onCancel:x,isSaving:j})=>{const[n,d]=h.useState(t?{...t,date:t.date||"",start_time:t.start_time||"18:30",instructors:t.instructors||[],students:t.students||[],cycle_id:t.cycle_id||null,session_objective:t.session_objective||"",equipment:t.equipment||"",comment:t.comment||"",exercises:t.exercises||[]}:{date:"",start_time:"18:30",instructors:[],students:[],cycle_id:null,session_objective:"",equipment:"",comment:"",exercises:[]}),[f,m]=h.useState(!1),[y,v]=h.useState(null),[w,F]=h.useState([]),[a,u]=h.useState([]);h.useEffect(()=>{const s=async()=>{try{const{data:r,error:o}=await E.from("members").select("first_name, last_name").eq("title","Loisir lycée").order("last_name");if(o)throw o;const p=r.map(g=>`${g.first_name} ${g.last_name}`);F(p)}catch{F([])}},l=async()=>{try{const{data:r,error:o}=await E.from("cycles").select("id, name, short_description").order("name");if(o)throw o;u(r||[])}catch{u([])}};s(),l()},[]);const k=["David","Magali","Olivier","Clement"],i=s=>{const{name:l,value:r}=s.target;d(o=>({...o,[l]:r}))},N=(s,l)=>{d(r=>({...r,[s]:l}))},q=(s,l)=>{const r=[...n.exercises];r[s]=l,d(o=>({...o,exercises:r}))},S=()=>{d(s=>({...s,exercises:[...s.exercises,{id:`new-${Date.now()}`,operational_objective:"",situation:"",organisation:"",consigne:"",time:"",success_criteria:"",regulation:"",support_link:"",image_url:"",newImageFile:null,pedagogy_sheet_id:null}]}))},C=s=>{const l=n.exercises.filter((r,o)=>o!==s);d(r=>({...r,exercises:l}))},U=(s,l)=>{const r=[...n.exercises],o=s+l;o<0||o>=r.length||([r[s],r[o]]=[r[o],r[s]],d(p=>({...p,exercises:r})))},D=s=>{v(s),m(!0)},L=s=>{const l=[...n.exercises],r=l[y];r.pedagogy_sheet_id=s.id,s.sheet_type==="educational_game"?(r.operational_objective=`Jeu: ${s.title}`,r.situation=s.starting_situation,r.consigne=`But: ${s.game_goal}. Évolution: ${s.evolution}`,r.image_url=s.url,r.support_link=""):(r.operational_objective=s.title,r.situation=s.description,r.consigne="",s.type==="image_file"?(r.image_url=s.url,r.support_link=""):(r.support_link=s.url,r.image_url=s.thumbnail_url||"")),d(o=>({...o,exercises:l})),m(!1),v(null)},A=s=>{s.preventDefault();const l={...n,date:n.date||null,start_time:n.start_time||null};c(l)};return e.jsxs(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx(W,{children:e.jsxs("form",{onSubmit:A,children:[e.jsx(se,{children:e.jsx(te,{children:t?"Modifier la séance":"Ajouter une nouvelle séance"})}),e.jsxs(ae,{className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"date",children:"Date du cours (optionnel)"}),e.jsx(b,{id:"date",name:"date",type:"date",value:n.date,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"start_time",children:"Heure de début"}),e.jsx(b,{id:"start_time",name:"start_time",type:"time",value:n.start_time,onChange:i})]}),e.jsx(G,{title:"Encadrants",options:k,selected:n.instructors,onChange:s=>N("instructors",s)}),e.jsx(G,{title:"Élèves présents",options:w,selected:n.students,onChange:s=>N("students",s)})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"cycle_id",children:"Cycle associé"}),e.jsxs(V,{value:n.cycle_id?n.cycle_id.toString():"",onValueChange:s=>d(l=>({...l,cycle_id:s?parseInt(s):null})),children:[e.jsx(B,{id:"cycle_id",children:e.jsx(H,{placeholder:"Sélectionner un cycle (optionnel)"})}),e.jsxs(J,{children:[e.jsx(O,{value:"",children:"Aucun cycle"}),a.map(s=>e.jsxs(O,{value:s.id.toString(),children:[s.name,s.short_description&&` - ${s.short_description}`]},s.id))]})]}),n.cycle_id&&(t==null?void 0:t.cycles)&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Cycle actuel: ",t.cycles.name]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"session_objective",children:"Objectif de séance"}),e.jsx(P,{id:"session_objective",name:"session_objective",value:n.session_objective,onChange:i})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"equipment",children:"Matériel"}),e.jsx(P,{id:"equipment",name:"equipment",value:n.equipment,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"comment",children:"Commentaire"}),e.jsx(P,{id:"comment",name:"comment",value:n.comment,onChange:i})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Déroulé de la séance"}),e.jsx("div",{className:"space-y-4",children:n.exercises.map((s,l)=>e.jsx(Ee,{exercise:s,index:l,total:n.exercises.length,onExerciseChange:q,onRemove:C,onMove:U,onImport:()=>D(l)},s.id))}),e.jsxs(I,{type:"button",variant:"outline",className:"mt-4",onClick:S,children:[e.jsx(re,{className:"w-4 h-4 mr-2"})," Ajouter un exercice"]})]})]}),e.jsxs(ne,{className:"flex justify-end gap-2",children:[e.jsx(I,{type:"button",variant:"ghost",onClick:x,disabled:j,children:"Annuler"}),e.jsx(I,{type:"submit",disabled:j,children:j?"Sauvegarde...":e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-4 h-4 mr-2"})," Sauvegarder"]})})]})]})}),f&&e.jsx(Te,{onSelect:L,onCancel:()=>m(!1)})]})},K="exercise_images",Ue=()=>{const{id:t}=he(),c=Q(),[x]=pe(),[j,n]=h.useState(null),[d,f]=h.useState(!0),[m,y]=h.useState(!1),{toast:v}=ge(),{user:w,isAdmin:F,loading:a}=xe(),u=!a&&F,k=h.useCallback(async()=>{if(!t){f(!1);return}f(!0);const{data:S,error:C}=await E.from("sessions").select(`
        *,
        exercises (*),
        cycles (
          id,
          name,
          short_description
        )
      `).eq("id",t).order("order",{foreignTable:"exercises",ascending:!0}).single();C?(v({title:"Erreur",description:"Impossible de charger la séance.",variant:"destructive"}),c("/session-log")):n({...S,start_time:S.start_time?S.start_time.substring(0,5):"18:30"}),f(!1)},[t,v,c]);h.useEffect(()=>{u?k():a||f(!1)},[k,u,a]);const i=async S=>{const C=S.name.split(".").pop(),D=`${`${Math.random()}.${C}`}`;let{error:L}=await E.storage.from(K).upload(D,S);if(L)throw L;const{data:A}=E.storage.from(K).getPublicUrl(D);return A.publicUrl},N=async S=>{if(u){y(!0);try{const{id:C,exercises:U,...D}=S,L=await Promise.all(U.map(async p=>{let g=p.image_url;p.newImageFile&&(g=await i(p.newImageFile));const{newImageFile:T,..._}=p;return{..._,image_url:g}})),{cycles:A,...s}=D,l=Object.entries(s).reduce((p,[g,T])=>(p[g]=T===""?null:T,p),{});if(t){const{data:p,error:g}=await E.from("sessions").update(l).eq("id",t).select().single();if(g)throw console.error("Supabase Update Error:",g),g;await E.from("exercises").delete().eq("session_id",p.id);const T=L.map((_,M)=>{const{id:X,...z}=_;return{...z,session_id:p.id,order:M}});if(T.length>0){const{error:_}=await E.from("exercises").insert(T);if(_)throw console.error("Supabase Insert Error:",_),_}}else{const{data:p,error:g}=await E.from("sessions").insert(l).select().single();if(g)throw console.error("Supabase Insert Error:",g),g;const T=L.map((_,M)=>{const{id:X,...z}=_;return{...z,session_id:p.id,order:M}});if(T.length>0){const{error:_}=await E.from("exercises").insert(T);if(_)throw console.error("Supabase Insert Error:",_),_}}v({title:"Séance sauvegardée !",description:"La séance a été enregistrée avec succès."});const r=x.get("from"),o=x.get("cycleId");c(r==="cycle"&&o?`/cycles/${o}`:"/session-log")}catch(C){v({title:"Erreur de sauvegarde",description:C.message,variant:"destructive"})}finally{y(!1)}}},q=()=>{const S=x.get("from"),C=x.get("cycleId");c(S==="cycle"&&C?`/cycles/${C}`:"/session-log")};return a||d?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(je,{className:"w-12 h-12 animate-spin text-primary"})}):u?e.jsxs("div",{className:"space-y-8",children:[e.jsxs(fe,{children:[e.jsxs("title",{children:[t?"Modifier la séance":"Nouvelle séance"," - ALJ Escalade Jonage"]}),e.jsx("meta",{name:"description",content:"Édition d'une séance d'escalade du club."})]}),e.jsx(R.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(ve,{className:"w-10 h-10 text-primary"}),t?"Modifier la séance":"Nouvelle séance"]})}),e.jsx(R.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:e.jsx(Fe,{session:j,onSave:N,onCancel:q,isSaving:m})})]}):e.jsxs("div",{className:"text-center py-16",children:[e.jsx(Se,{className:"w-12 h-12 mx-auto text-muted-foreground"}),e.jsx("h1",{className:"text-2xl font-bold mt-4",children:"Accès restreint"}),e.jsx("p",{className:"text-muted-foreground",children:"Vous devez être un administrateur pour modifier les séances."}),!w&&e.jsx("p",{className:"mt-4",children:"Veuillez vous connecter."})]})};export{Ue as default};

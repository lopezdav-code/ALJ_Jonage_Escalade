import{r as l,j as e,C as w,b as E,d as L,a as _,Z as C,e as y,aM as A,Q as R,O as U,t as p,R as M,U as q,m as T,f as G,B as P,N as $,al as I,S as F,I as z}from"./index-1760361243512.js";import{A as H,a as O}from"./alert-1760361243512.js";const Q=()=>{const[t,i]=l.useState([]);return l.useEffect(()=>{const c=o=>{if(o.target.tagName==="IMG"){const s=o.target.src;s.includes("/assets/members/")&&i(r=>{if(!r.some(a=>a.url===s)){const a={url:s,timestamp:new Date().toISOString(),alt:o.target.alt||"Image sans alt"};return console.warn("Image de membre manquante:",a),[...r,a]}return r})}};return document.addEventListener("error",c,!0),()=>{document.removeEventListener("error",c,!0)}},[]),{reportedErrors:t}},V=()=>{const{reportedErrors:t}=Q();return t.length===0?e.jsxs(w,{children:[e.jsxs(E,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5"}),"Images manquantes"]}),e.jsx(C,{children:"Aucune erreur d'image d√©tect√©e pour le moment"})]}),e.jsx(y,{children:e.jsx("div",{className:"text-sm text-green-600",children:"‚úÖ Toutes les images semblent se charger correctement"})})]}):e.jsxs(w,{children:[e.jsxs(E,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-orange-500"}),"Images manquantes (",t.length,")"]}),e.jsx(C,{children:"Images qui n'ont pas pu √™tre charg√©es"})]}),e.jsxs(y,{children:[e.jsx("div",{className:"space-y-3",children:t.map((i,c)=>e.jsxs(H,{variant:"destructive",children:[e.jsx(A,{className:"h-4 w-4"}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:i.alt}),e.jsxs("div",{className:"text-xs opacity-75",children:["URL: ",i.url]}),e.jsxs("div",{className:"text-xs opacity-75",children:["D√©tect√©: ",new Date(i.timestamp).toLocaleString("fr-FR")]})]})})]},c))}),e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"üí° Solution :"})," V√©rifiez que les fichiers images existent dans le dossier",e.jsx("code",{className:"mx-1 px-1 bg-blue-100 rounded",children:"public/assets/members/"}),"avec les noms exacts list√©s ci-dessus."]})})]})]})},Z=({members:t,onSelect:i,onClear:c})=>{const[o,s]=l.useState(""),[r,a]=l.useState([]),x=n=>{const d=n.target.value;if(s(d),d.length>1){const j=t.filter(N=>`${N.first_name} ${N.last_name}`.toLowerCase().includes(d.toLowerCase()));a(j)}else a([])},f=n=>{s(I(n.first_name,n.last_name,!0)),a([]),i(n)};return l.useEffect(()=>{o===""&&c()},[o,c]),e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"relative",children:[e.jsx(F,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(z,{type:"text",value:o,onChange:x,placeholder:"Rechercher un membre...",className:"pl-10"})]}),r.length>0&&e.jsx("ul",{className:"absolute z-10 w-full bg-background border rounded-md mt-1 max-h-60 overflow-y-auto",children:r.map(n=>e.jsx("li",{onClick:()=>f(n),className:"px-3 py-2 hover:bg-accent cursor-pointer",children:I(n.first_name,n.last_name,!0)},n.id))})]})},J=({image:t,members:i,onLink:c,linkingState:o})=>{const[s,r]=l.useState(null),{isLinking:a,linkedMemberId:x}=o,f=()=>{s&&c(t,s)};return e.jsxs(w,{className:"overflow-hidden",children:[e.jsx(y,{className:"p-0",children:e.jsx("img",{src:t.publicUrl,alt:t.name,className:"w-full h-48 object-cover"})}),e.jsxs(G,{className:"p-4 flex flex-col gap-4",children:[e.jsx(Z,{members:i,onSelect:r,onClear:()=>r(null)}),e.jsxs(P,{onClick:f,disabled:!s||a,className:"w-full",children:[a&&x===(s==null?void 0:s.id)?e.jsx(M,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx($,{className:"w-4 h-4 mr-2"}),"Lier au membre"]})]})]})},Y=()=>{const[t,i]=l.useState([]),[c,o]=l.useState([]),[s,r]=l.useState(!0),[a,x]=l.useState({isLinking:!1,linkedMemberId:null}),{isAdmin:f,loading:n}=R(),{toast:d}=U(),j=l.useCallback(async()=>{r(!0);try{const{data:m,error:u}=await p.storage.listBuckets();if(u)throw u;const g=m.map(async h=>{const{data:v,error:S}=await p.storage.from(h.name).list(void 0,{limit:1e3,offset:0,sortBy:{column:"created_at",order:"desc"}});return S?(console.warn(`Could not list files from bucket ${h.name}:`,S.message),[]):v.filter(b=>b.name!==".emptyFolderPlaceholder").map(b=>({...b,bucketName:h.name,publicUrl:p.storage.from(h.name).getPublicUrl(b.name).data.publicUrl}))}),B=(await Promise.all(g)).flat().sort((h,v)=>new Date(v.created_at)-new Date(h.created_at)),{data:D,error:k}=await p.from("members").select("*");if(k)throw k;i(B),o(D)}catch{d({title:"Erreur",description:"Impossible de charger les donn√©es.",variant:"destructive"})}finally{r(!1)}},[d]);l.useEffect(()=>{j()},[j]);const N=async(m,u)=>{x({isLinking:!0,linkedMemberId:u.id});try{const{error:g}=await p.from("members").update({photo_url:m.publicUrl}).eq("id",u.id);if(g)throw g;d({title:"Succ√®s",description:`Image li√©e √† ${I(u.first_name,u.last_name,!0)}.`})}catch(g){d({title:"Erreur",description:g.message,variant:"destructive"})}finally{x({isLinking:!1,linkedMemberId:null})}};return n||s?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(M,{className:"w-12 h-12 animate-spin text-primary"})}):f?e.jsxs("div",{className:"space-y-8",children:[e.jsxs(q,{children:[e.jsx("title",{children:"Gestion des Images - Admin"}),e.jsx("meta",{name:"description",content:"G√©rer et lier les images du site."})]}),e.jsx(T.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},children:e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(_,{className:"w-10 h-10 text-primary"}),"Gestion des Images"]})}),e.jsx(V,{}),t.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-16",children:"Aucune image trouv√©e dans les buckets de stockage."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6",children:t.map(m=>e.jsx(J,{image:m,members:c,onLink:N,linkingState:a},m.id))})]}):e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Acc√®s non autoris√©"}),e.jsx("p",{className:"text-muted-foreground",children:"Cette page est r√©serv√©e aux administrateurs."})]})};export{Y as default};

import{a0 as J,u as M,Q,O as Y,r as n,t as h,j as e,R as S,U as Z,m as I,B as o,a1 as G,P as R,C as u,b as j,d as p,e as y,Z as K,Y as W,x as X,a2 as F,a3 as ee,E as se,D as ae,h as te,i as re,k as ce,l as ne,n as ie,o as le,p as de,q as oe,s as me,$ as xe}from"./index-1760370975611.js";const je=()=>{var _,L;const{id:m}=J(),b=M(),{user:he,isAdmin:$,isEncadrant:T}=Q(),{toast:i}=Y(),[c,q]=n.useState(null),[t,O]=n.useState([]),[C,P]=n.useState([]),[A,D]=n.useState(!0),[z,x]=n.useState(!1),[g,f]=n.useState(""),[E,k]=n.useState(!1),d=$||T;n.useEffect(()=>{m&&(B(),N(),d&&v())},[m,d]);const B=async()=>{try{const{data:s,error:a}=await h.from("cycles").select("*").eq("id",m).single();if(a)throw a;q(s)}catch(s){i({title:"Erreur",description:`Impossible de charger le cycle: ${s.message}`,variant:"destructive"}),b("/cycles")}},N=async()=>{D(!0);try{const{data:s,error:a}=await h.from("sessions").select("*").eq("cycle_id",m).order("date",{ascending:!1});if(a)throw a;O(s||[])}catch(s){i({title:"Erreur",description:`Impossible de charger les séances: ${s.message}`,variant:"destructive"})}finally{D(!1)}},v=async()=>{try{const{data:s,error:a}=await h.from("sessions").select("id, date, start_time, instructors").is("cycle_id",null).order("date",{ascending:!1}).limit(50);if(a)throw a;P(s||[])}catch(s){console.error("Erreur lors du chargement des séances disponibles:",s)}},H=async()=>{if(!g){i({title:"Erreur",description:"Veuillez sélectionner une séance",variant:"destructive"});return}k(!0);try{const{error:s}=await h.from("sessions").update({cycle_id:m}).eq("id",g);if(s)throw s;i({title:"Succès",description:"Séance ajoutée au cycle"}),x(!1),f(""),N(),v()}catch(s){i({title:"Erreur",description:`Impossible d'ajouter la séance: ${s.message}`,variant:"destructive"})}finally{k(!1)}},V=async s=>{try{const{error:a}=await h.from("sessions").update({cycle_id:null}).eq("id",s);if(a)throw a;i({title:"Succès",description:"Séance retirée du cycle"}),N(),d&&v()}catch(a){i({title:"Erreur",description:`Impossible de retirer la séance: ${a.message}`,variant:"destructive"})}},U=s=>new Date(s).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"});return A&&!c?e.jsx("div",{className:"flex justify-center items-center min-h-[60vh]",children:e.jsx(S,{className:"h-8 w-8 animate-spin text-primary"})}):c?e.jsxs(e.Fragment,{children:[e.jsx(Z,{children:e.jsxs("title",{children:[c.name," - Cycles - ALJ Escalade"]})}),e.jsx("div",{className:"container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl",children:e.jsxs(I.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(o,{variant:"ghost",onClick:()=>b("/cycles"),className:"mb-4",children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"Retour aux cycles"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2",children:c.name}),c.short_description&&e.jsx("p",{className:"text-lg sm:text-xl text-gray-600 mb-4",children:c.short_description}),c.long_description&&e.jsx("p",{className:"text-gray-600 max-w-3xl",children:c.long_description})]}),d&&e.jsxs(o,{onClick:()=>x(!0),className:"w-full sm:w-auto",children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Ajouter une séance"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8",children:[e.jsxs(u,{children:[e.jsx(j,{className:"pb-3",children:e.jsx(p,{className:"text-sm font-medium text-gray-600",children:"Nombre de séances"})}),e.jsx(y,{children:e.jsx("div",{className:"text-3xl font-bold",children:t.length})})]}),e.jsxs(u,{children:[e.jsx(j,{className:"pb-3",children:e.jsx(p,{className:"text-sm font-medium text-gray-600",children:"Élèves participants"})}),e.jsx(y,{children:e.jsx("div",{className:"space-y-1",children:(()=>{const s=new Set;t.forEach(l=>{var r;(r=l.students)==null||r.forEach(w=>s.add(w))});const a=Array.from(s).sort();return a.length>0?e.jsx("div",{className:"text-sm max-h-32 overflow-y-auto",children:a.map((l,r)=>e.jsxs("div",{className:"py-0.5",children:["• ",l]},r))}):e.jsx("div",{className:"text-sm text-gray-400",children:"Aucun élève"})})()})})]}),e.jsxs(u,{children:[e.jsx(j,{className:"pb-3",children:e.jsx(p,{className:"text-sm font-medium text-gray-600",children:"Encadrants"})}),e.jsx(y,{children:e.jsx("div",{className:"space-y-1",children:(()=>{const s=new Set;t.forEach(l=>{var r;(r=l.instructors)==null||r.forEach(w=>s.add(w))});const a=Array.from(s).sort();return a.length>0?e.jsx("div",{className:"text-sm",children:a.map((l,r)=>e.jsxs("div",{className:"py-0.5",children:["• ",l]},r))}):e.jsx("div",{className:"text-sm text-gray-400",children:"Aucun encadrant"})})()})})]}),e.jsxs(u,{children:[e.jsx(j,{className:"pb-3",children:e.jsx(p,{className:"text-sm font-medium text-gray-600",children:"Période"})}),e.jsx(y,{children:e.jsx("div",{className:"text-sm break-words",children:t.length>0?e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1",children:[e.jsx("span",{children:new Date((_=t[t.length-1])==null?void 0:_.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}),e.jsx("span",{className:"hidden sm:inline",children:"→"}),e.jsx("span",{className:"sm:hidden",children:"↓"}),e.jsx("span",{children:new Date((L=t[0])==null?void 0:L.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})})]}):"Aucune séance"})})]})]}),e.jsxs(u,{children:[e.jsxs(j,{children:[e.jsx(p,{children:"Séances du cycle"}),e.jsx(K,{children:"Liste de toutes les séances associées à ce cycle"})]}),e.jsx(y,{children:A?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(S,{className:"h-6 w-6 animate-spin"})}):t.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(W,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Aucune séance dans ce cycle"}),d&&e.jsxs(o,{onClick:()=>x(!0),children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Ajouter une séance"]})]}):e.jsx("div",{className:"space-y-4",children:t.map(s=>{var a;return e.jsx(I.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2",children:[e.jsx("h3",{className:"font-semibold text-base sm:text-lg",children:U(s.date)}),e.jsxs(X,{variant:"secondary",className:"w-fit",children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),((a=s.students)==null?void 0:a.length)||0," participants"]})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[s.start_time&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.start_time})]}),s.instructors&&s.instructors.length>0&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(F,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("span",{className:"break-words",children:["Encadrants: ",s.instructors.join(", ")]})]})]})]}),d&&e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>V(s.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(se,{className:"w-4 h-4"})})]})},s.id)})})})]})]})}),e.jsx(ae,{open:z,onOpenChange:x,children:e.jsxs(te,{children:[e.jsxs(re,{children:[e.jsx(ce,{children:"Ajouter une séance au cycle"}),e.jsx(ne,{children:"Sélectionnez une séance existante à ajouter à ce cycle"})]}),e.jsx("div",{className:"py-4",children:e.jsxs(ie,{value:g,onValueChange:f,children:[e.jsx(le,{children:e.jsx(de,{placeholder:"Sélectionner une séance"})}),e.jsx(oe,{children:C.length===0?e.jsx("div",{className:"p-4 text-center text-sm text-gray-500",children:"Aucune séance disponible"}):C.map(s=>e.jsxs(me,{value:s.id,children:[new Date(s.date).toLocaleDateString("fr-FR"),s.start_time&&` - ${s.start_time}`,s.instructors&&s.instructors.length>0&&` (${s.instructors[0]})`]},s.id))})]})}),e.jsxs(xe,{children:[e.jsx(o,{variant:"outline",onClick:()=>{x(!1),f("")},children:"Annuler"}),e.jsxs(o,{onClick:H,disabled:E||!g,children:[E&&e.jsx(S,{className:"w-4 h-4 mr-2 animate-spin"}),"Ajouter"]})]})]})})]}):null};export{je as default};

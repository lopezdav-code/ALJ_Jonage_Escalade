import{W as Le,u as Pe,m as $e,l as qe,r as c,j as e,n as y,H as Oe,o as ie,d as n,a3 as ze,a4 as Ue,a1 as oe,q as Z,C as _,t as D,v as E,w as k,$ as Re,_ as de,B as Te,a5 as me,a6 as Be,a7 as He,T as Me,O as z,Q as U,R,U as T,V as B,D as Ve,E as Je,F as We,G as Ge,J as Ke,a2 as H,I as h,a8 as ee,z as N,s as m}from"./index-1760451543780.js";import{U as xe}from"./upload-1760451543780.js";const ue="cycle_documents",Ze=()=>{const{id:o}=Le(),M=Pe(),{user:Qe,isAdmin:he,isEncadrant:pe}=$e(),{toast:i}=qe(),[t,je]=c.useState(null),[g,ge]=c.useState([]),[se,fe]=c.useState([]),[ae,V]=c.useState(!0),[ve,w]=c.useState(!1),[ye,J]=c.useState(!1),[Ne,F]=c.useState(!1),[we,A]=c.useState(!1),[I,W]=c.useState(""),[f,v]=c.useState(!1),[te,re]=c.useState(!1),[x,L]=c.useState(null),[P,G]=c.useState(null),[$,K]=c.useState(null),[ce,Q]=c.useState(null),[b,S]=c.useState("center"),[p,q]=c.useState({instructors:[],session_objective:"",equipment:"",comment:""}),[j,O]=c.useState({session_objective:"Séance fictive",instructors:[],equipment:"",comment:"Cette séance est fictive et n'a pas de date."}),u=he||pe,be=s=>{M(`/session-log/edit/${s.id}?from=cycle&cycleId=${o}`)},Se=()=>{L({name:t.name||"",short_description:t.short_description||"",long_description:t.long_description||""}),Q(t.image_url||null),S(t.image_position||"center"),A(!0)},Ce=s=>{var l;const a=(l=s.target.files)==null?void 0:l[0];if(a){K(a);const r=new FileReader;r.onloadend=()=>{Q(r.result)},r.readAsDataURL(a)}},le=async(s,a)=>{const l=s.name.split(".").pop(),r=`${a}/${o}_${Date.now()}.${l}`,{error:d}=await m.storage.from(ue).upload(r,s);if(d)throw console.error("Upload error:",d),new Error(`Erreur d'upload: ${d.message||`Le bucket "cycle_documents" n'existe peut-être pas dans Supabase Storage`}`);const{data:X}=m.storage.from(ue).getPublicUrl(r);return X.publicUrl},_e=async()=>{re(!0);try{const s={...x,image_position:b};if(P){const l=await le(P,"pdfs");s.pdf_url=l}if($){const l=await le($,"images");s.image_url=l}const{error:a}=await m.from("cycles").update(s).eq("id",o);if(a)throw a;i({title:"Succès",description:"Le cycle a été mis à jour avec succès."}),A(!1),G(null),K(null),Q(null),S("center"),ne()}catch(s){i({title:"Erreur",description:`Impossible de mettre à jour le cycle: ${s.message}`,variant:"destructive"})}finally{re(!1)}},ne=async()=>{try{const{data:s,error:a}=await m.from("cycles").select("*").eq("id",o).single();if(console.log("Détails du cycle récupérés :",s),a)throw a;je(s),V(!1)}catch(s){i({title:"Erreur",description:`Impossible de charger le cycle: ${s.message}`,variant:"destructive"}),M("/cycles")}},Y=async()=>{try{const{data:s,error:a}=await m.from("sessions").select("id, date, start_time, instructors").is("cycle_id",null).order("date",{ascending:!1}).limit(50);if(a)throw a;fe(s||[])}catch(s){console.error("Erreur lors du chargement des séances disponibles:",s)}},C=async()=>{try{const{data:s,error:a}=await m.from("sessions").select("*").eq("cycle_id",o).order("date",{ascending:!1,nullsFirst:!1});if(console.log("Séances du cycle récupérées :",s),a)throw a;ge(s||[]),V(!1)}catch(s){console.error("Erreur lors du chargement des séances du cycle:",s),i({title:"Erreur",description:`Impossible de charger les séances: ${s.message}`,variant:"destructive"}),V(!1)}},De=async()=>{if(!I){i({title:"Erreur",description:"Veuillez sélectionner une séance",variant:"destructive"});return}v(!0);try{const{error:s}=await m.from("sessions").update({cycle_id:o}).eq("id",I);if(s)throw s;i({title:"Succès",description:"Séance ajoutée au cycle"}),w(!1),W(""),C(),Y()}catch(s){i({title:"Erreur",description:`Impossible d'ajouter la séance: ${s.message}`,variant:"destructive"})}finally{v(!1)}},Ee=async s=>{try{const{error:a}=await m.from("sessions").update({cycle_id:null}).eq("id",s);if(a)throw a;i({title:"Succès",description:"Séance retirée du cycle"}),C(),u&&Y()}catch(a){i({title:"Erreur",description:`Impossible de retirer la séance: ${a.message}`,variant:"destructive"})}},ke=async()=>{v(!0);try{const{error:s}=await m.from("sessions").insert({...p,cycle_id:o,date:null});if(s)throw s;i({title:"Succès",description:"Séance créée avec succès."}),J(!1),q({instructors:[],session_objective:"",equipment:"",comment:""}),C()}catch(s){i({title:"Erreur",description:`Impossible de créer la séance: ${s.message}`,variant:"destructive"})}finally{v(!1)}},Fe=async()=>{v(!0);try{const{error:s}=await m.from("sessions").insert({...j,cycle_id:o,date:null});if(s)throw s;i({title:"Succès",description:"Séance fictive créée avec succès."}),F(!1),O({session_objective:"Séance fictive",instructors:[],equipment:"",comment:"Cette séance est fictive et n'a pas de date."}),C()}catch(s){i({title:"Erreur",description:`Impossible de créer la séance fictive: ${s.message}`,variant:"destructive"})}finally{v(!1)}},Ae=s=>new Date(s).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"});c.useEffect(()=>{o&&(ne(),C(),u&&Y())},[o,u]);const Ie=g;return ae&&!t?e.jsx("div",{className:"flex justify-center items-center min-h-[60vh]",children:e.jsx(y,{className:"h-8 w-8 animate-spin text-primary"})}):t?e.jsxs(e.Fragment,{children:[e.jsx(Oe,{children:e.jsxs("title",{children:[t.name," - Cycles - ALJ Escalade"]})}),e.jsx("div",{className:"container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl",children:e.jsxs(ie.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(n,{variant:"ghost",onClick:()=>M("/cycles"),className:"mb-4",children:[e.jsx(ze,{className:"w-4 h-4 mr-2"}),"Retour aux cycles"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-start gap-4",children:[t.image_url&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx("a",{href:t.image_url,target:"_blank",rel:"noopener noreferrer",className:"block",children:e.jsx("img",{src:t.image_url,alt:t.name,className:"w-24 h-24 sm:w-32 sm:h-32 object-cover rounded-lg shadow-md hover:shadow-lg transition-shadow border-2 border-gray-200"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 flex-wrap",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900",children:t.name}),u&&e.jsxs(n,{variant:"outline",size:"sm",onClick:Se,className:"flex-shrink-0",children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"Modifier"]})]}),t.short_description&&e.jsx("p",{className:"text-lg sm:text-xl text-gray-600 mb-4",children:t.short_description}),t.long_description&&e.jsx("p",{className:"text-gray-600 max-w-3xl",children:t.long_description}),t.pdf_url&&e.jsx("div",{className:"mt-4",children:e.jsxs("a",{href:t.pdf_url,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100 transition-colors",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Document PDF"})]})})]})]})}),u&&e.jsxs(n,{onClick:()=>w(!0),className:"w-full sm:w-auto flex-shrink-0",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Ajouter une séance"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8",children:[e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Nombre de séances"})}),e.jsx(k,{children:e.jsx("div",{className:"text-3xl font-bold",children:g.length})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Élèves participants"})}),e.jsx(k,{children:e.jsx("div",{className:"space-y-1",children:(()=>{const s=new Set;g.forEach(l=>{var r;(r=l.students)==null||r.forEach(d=>s.add(d))});const a=Array.from(s).sort();return a.length>0?e.jsx("div",{className:"text-sm max-h-32 overflow-y-auto",children:a.map((l,r)=>e.jsxs("div",{className:"py-0.5",children:["• ",l]},r))}):e.jsx("div",{className:"text-sm text-gray-400",children:"Aucun élève"})})()})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Encadrants"})}),e.jsx(k,{children:e.jsx("div",{className:"space-y-1",children:(()=>{const s=new Set;g.forEach(l=>{var r;(r=l.instructors)==null||r.forEach(d=>s.add(d))});const a=Array.from(s).sort();return a.length>0?e.jsx("div",{className:"text-sm",children:a.map((l,r)=>e.jsxs("div",{className:"py-0.5",children:["• ",l]},r))}):e.jsx("div",{className:"text-sm text-gray-400",children:"Aucun encadrant"})})()})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Période"})}),e.jsx(k,{children:e.jsx("div",{className:"text-sm break-words",children:(()=>{var r,d;const s=g.filter(X=>X.date);if(s.length===0)return"Aucune date";const a=(r=s[s.length-1])==null?void 0:r.date,l=(d=s[0])==null?void 0:d.date;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1",children:[e.jsx("span",{children:new Date(a).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}),e.jsx("span",{className:"hidden sm:inline",children:"→"}),e.jsx("span",{className:"sm:hidden",children:"↓"}),e.jsx("span",{children:new Date(l).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})})]})})()})})]})]}),e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsx(E,{children:"Séances du cycle"}),e.jsx(Re,{children:"Liste de toutes les séances associées à ce cycle"})]}),e.jsx(k,{children:ae?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(y,{className:"h-6 w-6 animate-spin"})}):g.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(de,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Aucune séance dans ce cycle"}),u&&e.jsxs(n,{onClick:()=>w(!0),children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Ajouter une séance"]})]}):e.jsx("div",{className:"space-y-4",children:Ie.map(s=>{var a;return e.jsx(ie.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2",children:[e.jsx("h3",{className:"font-semibold text-base sm:text-lg",children:s.session_objective||"Séance sans objectif"}),e.jsxs(Te,{variant:"secondary",className:"w-fit",children:[e.jsx(me,{className:"w-3 h-3 mr-1"}),((a=s.students)==null?void 0:a.length)||0," participants"]})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[s.date&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:Ae(s.date)})]}),s.start_time&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.start_time})]}),s.instructors&&s.instructors.length>0&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(me,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("span",{className:"break-words",children:["Encadrants: ",s.instructors.join(", ")]})]})]})]}),u&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>be(s),className:"text-blue-600 hover:text-blue-700 hover:bg-blue-50",children:e.jsx(He,{className:"w-4 h-4"})}),e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>Ee(s.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(Me,{className:"w-4 h-4"})})]})]})},s.id)})})})]}),u&&e.jsx("div",{className:"mt-4",children:e.jsxs(n,{onClick:()=>F(!0),className:"w-full sm:w-auto",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"})," Créer une séance fictive"]})})]})}),e.jsx(z,{open:ve,onOpenChange:w,children:e.jsxs(U,{children:[e.jsxs(R,{children:[e.jsx(T,{children:"Ajouter une séance au cycle"}),e.jsx(B,{children:"Sélectionnez une séance existante à ajouter à ce cycle"})]}),e.jsx("div",{className:"py-4",children:e.jsxs(Ve,{value:I,onValueChange:W,children:[e.jsx(Je,{children:e.jsx(We,{placeholder:"Sélectionner une séance"})}),e.jsx(Ge,{children:se.length===0?e.jsx("div",{className:"p-4 text-center text-sm text-gray-500",children:"Aucune séance disponible"}):se.map(s=>e.jsxs(Ke,{value:s.id,children:[s.date?new Date(s.date).toLocaleDateString("fr-FR"):"Sans date",s.start_time&&` - ${s.start_time}`,s.instructors&&s.instructors.length>0&&` (${s.instructors[0]})`]},s.id))})]})}),e.jsxs(H,{children:[e.jsx(n,{variant:"outline",onClick:()=>{w(!1),W("")},children:"Annuler"}),e.jsxs(n,{onClick:De,disabled:f||!I,children:[f&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"}),"Ajouter"]})]})]})}),e.jsx(z,{open:ye,onOpenChange:J,children:e.jsxs(U,{children:[e.jsxs(R,{children:[e.jsx(T,{children:"Créer une nouvelle séance"}),e.jsx(B,{children:"Remplissez les informations pour créer une nouvelle séance sans date."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(h,{placeholder:"Objectif de la séance",value:p.session_objective,onChange:s=>q({...p,session_objective:s.target.value})}),e.jsx(h,{placeholder:"Équipement",value:p.equipment,onChange:s=>q({...p,equipment:s.target.value})}),e.jsx(ee,{placeholder:"Commentaire",value:p.comment,onChange:s=>q({...p,comment:s.target.value})})]}),e.jsxs(H,{children:[e.jsx(n,{variant:"outline",onClick:()=>J(!1),children:"Annuler"}),e.jsxs(n,{onClick:ke,disabled:f,children:[f&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"})," Créer"]})]})]})}),e.jsx(z,{open:Ne,onOpenChange:F,children:e.jsxs(U,{children:[e.jsxs(R,{children:[e.jsx(T,{children:"Créer une séance fictive"}),e.jsx(B,{children:"Remplissez les informations pour créer une séance fictive."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(h,{placeholder:"Objectif de la séance",value:j.session_objective,onChange:s=>O({...j,session_objective:s.target.value})}),e.jsx(h,{placeholder:"Équipement",value:j.equipment,onChange:s=>O({...j,equipment:s.target.value})}),e.jsx(ee,{placeholder:"Commentaire",value:j.comment,onChange:s=>O({...j,comment:s.target.value})})]}),e.jsxs(H,{children:[e.jsx(n,{variant:"outline",onClick:()=>F(!1),children:"Annuler"}),e.jsxs(n,{onClick:Fe,disabled:f,children:[f&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"})," Créer"]})]})]})}),e.jsx(z,{open:we,onOpenChange:A,children:e.jsxs(U,{className:"sm:max-w-[600px]",children:[e.jsxs(R,{children:[e.jsx(T,{children:"Modifier le cycle"}),e.jsx(B,{children:"Modifiez les informations générales du cycle et ajoutez des documents."})]}),x&&e.jsxs("div",{className:"space-y-4 max-h-[60vh] overflow-y-auto pr-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-name",children:"Nom du cycle"}),e.jsx(h,{id:"cycle-name",value:x.name,onChange:s=>L({...x,name:s.target.value}),placeholder:"Nom du cycle"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-short-desc",children:"Description courte"}),e.jsx(h,{id:"cycle-short-desc",value:x.short_description,onChange:s=>L({...x,short_description:s.target.value}),placeholder:"Description courte"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-long-desc",children:"Description longue"}),e.jsx(ee,{id:"cycle-long-desc",value:x.long_description,onChange:s=>L({...x,long_description:s.target.value}),placeholder:"Description détaillée du cycle",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-pdf",children:"Document PDF"}),t.pdf_url&&e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(oe,{className:"w-4 h-4 text-red-600"}),e.jsx("a",{href:t.pdf_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline",children:"Document actuel"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{id:"cycle-pdf",type:"file",accept:".pdf",onChange:s=>{var a;return G(((a=s.target.files)==null?void 0:a[0])||null)},className:"flex-1"}),P&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:P?"Un nouveau PDF sera téléchargé":"Laisser vide pour conserver le PDF actuel"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-image",children:"Image illustrative"}),ce&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative w-full h-48 overflow-hidden bg-gray-100 rounded-lg border-2 border-gray-200",children:e.jsx("img",{src:ce,alt:"Aperçu",className:"w-full h-full object-cover",style:{objectPosition:b}})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"text-sm",children:"Position de l'image"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(n,{type:"button",variant:b==="top"?"default":"outline",size:"sm",onClick:()=>S("top"),className:"text-xs",children:"Haut"}),e.jsx(n,{type:"button",variant:b==="center"?"default":"outline",size:"sm",onClick:()=>S("center"),className:"text-xs",children:"Centre"}),e.jsx(n,{type:"button",variant:b==="bottom"?"default":"outline",size:"sm",onClick:()=>S("bottom"),className:"text-xs",children:"Bas"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{id:"cycle-image",type:"file",accept:"image/*",onChange:Ce,className:"flex-1"}),$&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:$?"Une nouvelle image sera téléchargée":t.image_url?"Laisser vide pour conserver l'image actuelle":"Format recommandé: 16:9 (1200x675px)"})]})]}),e.jsxs(H,{children:[e.jsx(n,{variant:"outline",onClick:()=>{A(!1),G(null),K(null)},children:"Annuler"}),e.jsxs(n,{onClick:_e,disabled:te,children:[te&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"}),"Sauvegarder"]})]})]})})]}):null};export{Ze as default};

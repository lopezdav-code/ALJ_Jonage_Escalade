import{l as F,w as M,x as P,r as a,y as o,j as e,z as J,H as K,D as G,m as n,a9 as U,F as W,G as b,J as E,K as A,W as T,o as $,p as O,q as y,s as N,t as Q,v as m,n as V,T as X,M as R,I as L}from"./index-1760862795448.js";import{S as Y}from"./save-1760862795448.js";const re=()=>{const x=F(),{toast:i}=M(),{isAdmin:c,loading:g}=P(),[j,D]=a.useState([]),[I,w]=a.useState(!0),[Z,_]=a.useState(null),[l,d]=a.useState(null),[u,h]=a.useState(""),[f,p]=a.useState(""),[C,S]=a.useState(!1);a.useEffect(()=>{if(!g&&!c){x("/");return}c&&v()},[c,g,x]);const v=async()=>{w(!0);try{try{const t=await o.auth.getSession(),B=await o.auth.getUser();console.log("[GroupeAdmin] auth sessionRes:",t),console.log("[GroupeAdmin] auth userRes:",B)}catch(t){console.warn("[GroupeAdmin] could not get auth session/user",t)}const{data:s,error:r}=await o.from("groupe").select("id, category, sous_category");if(console.log("[GroupeAdmin] fetchGroupes response:",{data:s,error:r}),_({data:s,error:r}),r)throw r;D(s||[])}catch(s){console.error("Erreur chargement groupes:",s),i({title:"Erreur",description:"Impossible de charger les groupes.",variant:"destructive"})}finally{w(!1)}},k=s=>{d(s),h(s.category||""),p(s.sous_category||"")},q=()=>{d({id:null}),h(""),p("")},H=async s=>{if(s.preventDefault(),!u.trim()){i({title:"Erreur",description:"La catégorie est requise.",variant:"destructive"});return}S(!0);try{if(l&&l.id){const{data:r,error:t}=await o.from("groupe").update({category:u.trim(),sous_category:f.trim()||null}).eq("id",l.id).select();if(console.log("[GroupeAdmin] update response:",{data:r,error:t}),t)throw t;i({title:"Groupe modifié"})}else{const{data:r,error:t}=await o.from("groupe").insert([{category:u.trim(),sous_category:f.trim()||null}]).select();if(console.log("[GroupeAdmin] insert response:",{data:r,error:t}),t)throw t;i({title:"Groupe créé"})}d(null),h(""),p(""),v()}catch(r){console.error("Erreur sauvegarde groupe:",r),i({title:"Erreur",description:r.message||"Impossible de sauvegarder.",variant:"destructive"})}finally{S(!1)}},z=async s=>{if(confirm("Supprimer ce groupe ?"))try{const{data:r,error:t}=await o.from("groupe").delete().eq("id",s).select();if(console.log("[GroupeAdmin] delete response:",{data:r,error:t}),t)throw t;i({title:"Groupe supprimé"}),v()}catch(r){console.error("Erreur suppression groupe:",r),i({title:"Erreur",description:"Impossible de supprimer le groupe.",variant:"destructive"})}};return g||I?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(J,{className:"w-12 h-12 animate-spin text-primary"})}):c?e.jsxs("div",{className:"space-y-8 max-w-4xl mx-auto p-6",children:[e.jsx(K,{children:e.jsx("title",{children:"Gestion des groupes"})}),e.jsx(G.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(n,{variant:"ghost",onClick:()=>x(-1),children:[e.jsx(U,{className:"w-4 h-4 mr-2"})," Retour"]}),e.jsx("h1",{className:"text-3xl font-bold",children:"Gestion des groupes"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(n,{onClick:q,children:[e.jsx(W,{className:"w-4 h-4 mr-2"})," Nouveau groupe"]})})]})}),e.jsxs(b,{children:[e.jsx(E,{children:e.jsxs(A,{children:["Liste des groupes (",j.length,")"]})}),e.jsx(T,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs($,{children:[e.jsx(O,{children:e.jsxs(y,{children:[e.jsx(N,{children:"ID"}),e.jsx(N,{children:"Description"}),e.jsx(N,{className:"text-right",children:"Actions"})]})}),e.jsx(Q,{children:j.length===0?e.jsx(y,{children:e.jsx(m,{colSpan:3,className:"text-center py-8 text-muted-foreground",children:"Aucun groupe"})}):j.map(s=>e.jsxs(y,{children:[e.jsx(m,{className:"font-mono text-sm",children:s.id}),e.jsxs(m,{children:[s.category,s.sous_category?` — ${s.sous_category}`:""]}),e.jsx(m,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(n,{variant:"outline",size:"sm",onClick:()=>k(s),children:e.jsx(V,{className:"w-4 h-4"})}),e.jsx(n,{variant:"destructive",size:"sm",onClick:()=>z(s.id),children:e.jsx(X,{className:"w-4 h-4"})})]})})]},s.id))})]})})})]}),l!==null&&e.jsx(G.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},children:e.jsxs(b,{children:[e.jsx(E,{children:e.jsx(A,{children:l.id?"Modifier le groupe":"Nouveau groupe"})}),e.jsx(T,{children:e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(R,{children:"Catégorie"}),e.jsx(L,{value:u,onChange:s=>h(s.target.value)})]}),e.jsxs("div",{children:[e.jsx(R,{children:"Sous-catégorie"}),e.jsx(L,{value:f,onChange:s=>p(s.target.value)})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(n,{variant:"ghost",onClick:()=>{d(null),setDescription("")},children:"Annuler"}),e.jsxs(n,{type:"submit",disabled:C,children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),C?"Enregistrement...":"Enregistrer"]})]})]})})]})})]}):null};export{re as default};

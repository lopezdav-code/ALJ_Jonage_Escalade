import{W as ie,u as ae,m as le,l as re,r as l,j as e,n as U,C as L,w as R,H as ne,o as ce,d as _,a3 as oe,t as de,v as ue,z as r,I as v,D as N,E as b,F as C,G as w,J as h,K as x,N as me,s as f}from"./index-1760451543780.js";import{B as he}from"./book-marked-1760451543780.js";import{U as z}from"./upload-cloud-1760451543780.js";import{S as xe}from"./save-1760451543780.js";const M="pedagogy_files",ge=["Sécurité","Noeud","Secours","Manip","Information"],pe={educational_game:"Jeu éducatif",warm_up_exercise:"Exercice d'échauffement",strength_exercise:"Exercice de renfo",review_sheet:"Fiche de révision",technical_sheet:"Fiche technique",safety_sheet:"Fiche sécurité",meeting_report:"Compte rendu de réunion"},_e=()=>{var P,D;const{id:c}=ie(),j=ae(),{isAdmin:S}=le(),{toast:g}=re(),[V,$]=l.useState(!!c),[y,F]=l.useState(!1),[G,B]=l.useState([]),[d,W]=l.useState(null),[u,H]=l.useState(null),[E,k]=l.useState(null),[T,I]=l.useState(null),[t,p]=l.useState({title:"",sheet_type:"",type:"",theme:"",starting_situation:"",game_goal:"",evolution:"",skill_to_develop:"",success_criteria:"",remarks:"",description:"",structure:"SAE",categories:[],url:"",illustration_image:""});l.useEffect(()=>{(async()=>{try{const{data:s,error:a}=await f.from("pedagogy_sheets").select("theme").not("theme","is",null).neq("theme","");if(a)throw a;const m=[...new Set(s.map(n=>n.theme))];B(m)}catch(s){console.error("Erreur lors du chargement des thèmes:",s)}})()},[]),l.useEffect(()=>{c&&(async()=>{try{const{data:s,error:a}=await f.from("pedagogy_sheets").select("*").eq("id",c).single();if(a)throw a;p({title:s.title||"",sheet_type:s.sheet_type||"",type:s.type||"",theme:s.theme||"",starting_situation:s.starting_situation||"",game_goal:s.game_goal||"",evolution:s.evolution||"",skill_to_develop:s.skill_to_develop||"",success_criteria:s.success_criteria||"",remarks:s.remarks||"",description:s.description||"",structure:s.structure||"SAE",categories:s.categories||[],url:s.url||"",illustration_image:s.illustration_image||""})}catch(s){g({title:"Erreur",description:`Impossible de charger la fiche: ${s.message}`,variant:"destructive"}),j("/pedagogy")}finally{$(!1)}})()},[c,j,g]),l.useEffect(()=>{(async()=>{if(t.url&&!d&&t.type==="image_file"){const s=await A(t.url);I(s)}})()},[t.url,t.type,d]),l.useEffect(()=>{(async()=>{if(t.illustration_image&&!u){const s=await A(t.illustration_image);k(s)}})()},[t.illustration_image,u]);const o=l.useCallback(i=>{const{name:s,value:a}=i.target;p(m=>({...m,[s]:a}))},[]),J=l.useCallback(i=>{p(s=>({...s,sheet_type:i}))},[]),K=l.useCallback(i=>{p(s=>({...s,type:i}))},[]),Y=l.useCallback(i=>{p(s=>({...s,structure:i}))},[]),Q=l.useCallback(i=>{p(s=>({...s,categories:s.categories.includes(i)?s.categories.filter(a=>a!==i):[...s.categories,i]}))},[]),X=l.useCallback(i=>{const s=i.target.files[0];if(s&&(W(s),s.type.startsWith("image/"))){const a=new FileReader;a.onloadend=()=>{I(a.result)},a.readAsDataURL(s)}},[]),Z=l.useCallback(i=>{const s=i.target.files[0];if(s&&(H(s),s.type.startsWith("image/"))){const a=new FileReader;a.onloadend=()=>{k(a.result)},a.readAsDataURL(s)}},[]),q=async i=>{const s=i.name.split(".").pop(),a=`${Date.now()}-${Math.random().toString(36).substring(2)}.${s}`,{data:m,error:n}=await f.storage.from(M).upload(a,i);if(n)throw n;return a},A=async i=>{if(!i)return null;try{if(i.startsWith("http://")||i.startsWith("https://"))return i;const{data:s,error:a}=await f.storage.from(M).createSignedUrl(i,3600);if(a)throw a;return s.signedUrl}catch(s){return console.error("Erreur lors de la génération de l'URL signée:",s),null}},O=async i=>{if(i.preventDefault(),!S){g({title:"Accès refusé",description:"Vous n'avez pas les permissions nécessaires.",variant:"destructive"});return}F(!0);try{let s=t.url,a=t.illustration_image;d&&(s=await q(d)),u&&(a=await q(u));const m={title:t.title,sheet_type:t.sheet_type,type:t.type,theme:t.theme||null,starting_situation:t.starting_situation||null,game_goal:t.game_goal||null,evolution:t.evolution||null,skill_to_develop:t.skill_to_develop||null,success_criteria:t.success_criteria||null,remarks:t.remarks||null,description:t.description||null,structure:t.structure,categories:t.categories||[],url:s,illustration_image:a||null,updated_at:new Date().toISOString()};if(c){const{error:n}=await f.from("pedagogy_sheets").update(m).eq("id",c);if(n)throw console.error("Erreur Supabase détaillée lors de la mise à jour:",n),n;g({title:"Succès",description:"Fiche pédagogique mise à jour avec succès."})}else{const{error:n}=await f.from("pedagogy_sheets").insert(m);if(n)throw console.error("Erreur Supabase détaillée lors de la création:",n),n;g({title:"Succès",description:"Fiche pédagogique créée avec succès."})}j("/pedagogy")}catch(s){g({title:"Erreur",description:`Impossible de sauvegarder la fiche: ${s.message}`,variant:"destructive"})}finally{F(!1)}},ee=t.sheet_type==="educational_game",se=(P=t.type)==null?void 0:P.includes("url"),te=(D=t.type)==null?void 0:D.includes("file");return V?e.jsx("div",{className:"flex justify-center items-center min-h-[60vh]",children:e.jsx(U,{className:"h-8 w-8 animate-spin text-primary"})}):S?e.jsxs(e.Fragment,{children:[e.jsx(ne,{children:e.jsxs("title",{children:[c?"Modifier la fiche":"Nouvelle fiche pédagogique"," - ALJ Escalade"]})}),e.jsx("div",{className:"container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-4xl",children:e.jsxs(ce.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(_,{variant:"ghost",onClick:()=>j("/pedagogy"),className:"mb-4",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Retour à la pédagogie"]}),e.jsx("h1",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2",children:c?"Modifier la fiche pédagogique":"Nouvelle fiche pédagogique"}),e.jsx("p",{className:"text-lg text-gray-600",children:c?"Modifiez les informations de la fiche":"Créez une nouvelle fiche pédagogique"})]}),e.jsxs(L,{children:[e.jsx(de,{children:e.jsx(ue,{children:"Informations de la fiche"})}),e.jsx(R,{children:e.jsxs("form",{onSubmit:O,className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"title",children:"Titre *"}),e.jsx(v,{id:"title",name:"title",value:t.title,onChange:o,required:!0,placeholder:"Titre de la fiche"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"sheet_type",children:"Type de Fiche *"}),e.jsxs(N,{value:t.sheet_type,onValueChange:J,children:[e.jsx(b,{id:"sheet_type",children:e.jsx(C,{placeholder:"Sélectionner un type de fiche"})}),e.jsx(w,{children:Object.entries(pe).map(([i,s])=>e.jsx(h,{value:i,children:s},i))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"type",children:"Type de Média *"}),e.jsxs(N,{value:t.type,onValueChange:K,children:[e.jsx(b,{id:"type",children:e.jsx(C,{placeholder:"Sélectionner un type"})}),e.jsxs(w,{children:[e.jsx(h,{value:"video_url",children:"Vidéo (URL)"}),e.jsx(h,{value:"image_file",children:"Image (Fichier)"}),e.jsx(h,{value:"document_file",children:"Document (Fichier)"}),e.jsx(h,{value:"document_url",children:"Document (URL)"})]})]})]})]}),ee?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"theme",children:"Thème"}),e.jsx(v,{id:"theme",name:"theme",value:t.theme||"",onChange:o,list:"existing-themes",placeholder:"Choisir ou créer un thème"}),e.jsx("datalist",{id:"existing-themes",children:G.map(i=>e.jsx("option",{value:i},i))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"illustration-upload",children:"Image d'illustration"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Cette image sera affichée comme illustration de la fiche (distincte de l'image de l'exercice)"}),e.jsx("div",{className:"flex items-center justify-center w-full",children:e.jsxs(r,{htmlFor:"illustration-upload",className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-muted/50 hover:bg-muted/80",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:[e.jsx(z,{className:"w-10 h-10 mb-3 text-muted-foreground"}),e.jsxs("p",{className:"mb-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Cliquez pour téléverser"})," une image"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u?u.name:"PNG, JPG, GIF..."})]}),e.jsx(v,{id:"illustration-upload",type:"file",accept:"image/*",className:"hidden",onChange:Z})]})}),E&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Prévisualisation :"}),e.jsx("img",{src:E,alt:"Prévisualisation illustration",className:"max-w-full h-48 object-cover rounded-lg border"})]}),c&&!u&&t.illustration_image&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Fichier actuel : ",t.illustration_image.split("/").pop()]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"starting_situation",children:"Situation de départ"}),e.jsx(x,{id:"starting_situation",name:"starting_situation",value:t.starting_situation||"",onChange:o,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"game_goal",children:"But du jeu"}),e.jsx(x,{id:"game_goal",name:"game_goal",value:t.game_goal||"",onChange:o,rows:3})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"evolution",children:"Évolution"}),e.jsx(x,{id:"evolution",name:"evolution",value:t.evolution||"",onChange:o,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"skill_to_develop",children:"Capacité à développer"}),e.jsx(x,{id:"skill_to_develop",name:"skill_to_develop",value:t.skill_to_develop||"",onChange:o,rows:3})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"success_criteria",children:"Critères de réussite"}),e.jsx(x,{id:"success_criteria",name:"success_criteria",value:t.success_criteria||"",onChange:o,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"remarks",children:"Remarques"}),e.jsx(x,{id:"remarks",name:"remarks",value:t.remarks||"",onChange:o,rows:3})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"description",children:"Description"}),e.jsx(x,{id:"description",name:"description",value:t.description||"",onChange:o,rows:4,placeholder:"Description de la fiche pédagogique"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"structure",children:"Structure"}),e.jsxs(N,{value:t.structure||"SAE",onValueChange:Y,children:[e.jsx(b,{id:"structure",children:e.jsx(C,{placeholder:"Sélectionner une structure"})}),e.jsxs(w,{children:[e.jsx(h,{value:"SAE",children:"SAE"}),e.jsx(h,{value:"SNE",children:"SNE"})]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:"Catégories"}),e.jsx("div",{className:"flex flex-wrap gap-4",children:ge.map(i=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(me,{id:`category-${i}`,checked:(t.categories||[]).includes(i),onCheckedChange:()=>Q(i)}),e.jsx(r,{htmlFor:`category-${i}`,className:"font-normal",children:i})]},i))})]})]}),se?e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"url",children:"URL du média *"}),e.jsx(v,{id:"url",name:"url",value:t.url,onChange:o,placeholder:"https://example.com/...",required:!0})]}):te?e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"file-upload",children:"Fichier de l'exercice"}),e.jsx("div",{className:"flex items-center justify-center w-full",children:e.jsxs(r,{htmlFor:"file-upload",className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-muted/50 hover:bg-muted/80",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:[e.jsx(z,{className:"w-10 h-10 mb-3 text-muted-foreground"}),e.jsxs("p",{className:"mb-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Cliquez pour téléverser"})," ou glissez-déposez"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:d?d.name:"Image, PDF, PPT..."})]}),e.jsx(v,{id:"file-upload",type:"file",className:"hidden",onChange:X})]})}),t.type==="image_file"&&T&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Prévisualisation :"}),e.jsx("img",{src:T,alt:"Prévisualisation fichier",className:"max-w-full h-48 object-cover rounded-lg border"})]}),c&&!d&&t.url&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Fichier actuel : ",t.url.split("/").pop()]})]}):null]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t",children:[e.jsx(_,{type:"button",variant:"outline",onClick:()=>j("/pedagogy"),disabled:y,children:"Annuler"}),e.jsxs(_,{type:"submit",disabled:y,children:[y&&e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Enregistrer"]})]})]})})]})]})})]}):e.jsx("div",{className:"flex justify-center items-center min-h-[60vh]",children:e.jsx(L,{className:"w-full max-w-md",children:e.jsx(R,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(he,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Accès refusé"}),e.jsx("p",{className:"text-muted-foreground",children:"Vous n'avez pas les permissions nécessaires pour accéder à cette page."})]})})})})};export{_e as default};

import{m as ae,l as ne,r as p,j as e,d as k,aP as le,T as ce,C as b,t as L,v as I,w as _,a5 as z,a0 as G,I as ie,D as X,E as Y,F as P,G as R,J as j,aQ as oe,a6 as de,s as $,B as ue,al as J}from"./index-1760451543780.js";import{t as D,c as me,n as B,g as fe,e as he,a as Q,d as K,h as E,A as T,G as xe,f as je}from"./fr-1760451543780.js";function O(r,a){const t=+D(r)-+D(a);return t<0?-1:t>0?1:t}function ge(r){return me(r,Date.now())}function ve(r,a,t){const[c,n]=B(t==null?void 0:t.in,r,a),g=c.getFullYear()-n.getFullYear(),m=c.getMonth()-n.getMonth();return g*12+m}function we(r){return a=>{const c=(r?Math[r]:Math.trunc)(a);return c===0?0:c}}function Ne(r,a){return+D(r)-+D(a)}function pe(r,a){const t=D(r,a==null?void 0:a.in);return t.setHours(23,59,59,999),t}function De(r,a){const t=D(r,a==null?void 0:a.in),c=t.getMonth();return t.setFullYear(t.getFullYear(),c+1,0),t.setHours(23,59,59,999),t}function ye(r,a){const t=D(r,a==null?void 0:a.in);return+pe(t,a)==+De(t,a)}function be(r,a,t){const[c,n,g]=B(t==null?void 0:t.in,r,r,a),m=O(n,g),l=Math.abs(ve(n,g));if(l<1)return 0;n.getMonth()===1&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-m*l);let w=O(n,g)===-m;ye(c)&&l===1&&O(c,g)===1&&(w=!1);const f=m*(l-+w);return f===0?0:f}function _e(r,a,t){const c=Ne(r,a)/1e3;return we(t==null?void 0:t.roundingMethod)(c)}function Me(r,a,t){const c=fe(),n=(t==null?void 0:t.locale)??c.locale??he,g=2520,m=O(r,a);if(isNaN(m))throw new RangeError("Invalid time value");const l=Object.assign({},t,{addSuffix:t==null?void 0:t.addSuffix,comparison:m}),[w,f]=B(t==null?void 0:t.in,...m>0?[a,r]:[r,a]),N=_e(f,w),y=(Q(f)-Q(w))/1e3,d=Math.round((N-y)/60);let h;if(d<2)return t!=null&&t.includeSeconds?N<5?n.formatDistance("lessThanXSeconds",5,l):N<10?n.formatDistance("lessThanXSeconds",10,l):N<20?n.formatDistance("lessThanXSeconds",20,l):N<40?n.formatDistance("halfAMinute",0,l):N<60?n.formatDistance("lessThanXMinutes",1,l):n.formatDistance("xMinutes",1,l):d===0?n.formatDistance("lessThanXMinutes",1,l):n.formatDistance("xMinutes",d,l);if(d<45)return n.formatDistance("xMinutes",d,l);if(d<90)return n.formatDistance("aboutXHours",1,l);if(d<K){const v=Math.round(d/60);return n.formatDistance("aboutXHours",v,l)}else{if(d<g)return n.formatDistance("xDays",1,l);if(d<E){const v=Math.round(d/K);return n.formatDistance("xDays",v,l)}else if(d<E*2)return h=Math.round(d/E),n.formatDistance("aboutXMonths",h,l)}if(h=be(f,w),h<12){const v=Math.round(d/E);return n.formatDistance("xMonths",v,l)}else{const v=h%12,M=Math.trunc(h/12);return v<3?n.formatDistance("aboutXYears",M,l):v<9?n.formatDistance("overXYears",M,l):n.formatDistance("almostXYears",M+1,l)}}function Se(r,a){return Me(r,ge(r),a)}const Le=()=>{const{isAdmin:r,user:a}=ae(),{toast:t}=ne(),[c,n]=p.useState([]),[g,m]=p.useState(!0),[l,w]=p.useState(""),[f,N]=p.useState("all"),[y,d]=p.useState("all"),[h,v]=p.useState("all"),[M,W]=p.useState([]),U=async()=>{try{m(!0);let s=$.from("access_logs").select(`
          *,
          profiles (
            id,
            first_name,
            last_name,
            email
          )
        `).order("created_at",{ascending:!1});if(f!=="all"&&(s=s.eq("action",f)),y!=="all"&&(s=s.eq("user_id",y)),h!=="all"){const x=new Date;let o;switch(h){case"today":o=new Date(x.getFullYear(),x.getMonth(),x.getDate());break;case"week":o=new Date(x.getTime()-7*24*60*60*1e3);break;case"month":o=new Date(x.getFullYear(),x.getMonth(),1);break}o&&(s=s.gte("created_at",o.toISOString()))}const{data:i,error:u}=await s.limit(1e3);if(u)throw u;n(i||[])}catch(s){console.error("Erreur lors du chargement des logs:",s),t({title:"Erreur",description:"Impossible de charger les logs d'accès.",variant:"destructive"})}finally{m(!1)}},Z=async()=>{try{const{data:s,error:i}=await $.from("profiles").select("id, first_name, last_name, email").order("last_name");if(i)throw i;W(s||[])}catch(s){console.error("Erreur lors du chargement des utilisateurs:",s)}};p.useEffect(()=>{r&&(U(),Z())},[r,f,y,h]);const F=c.filter(s=>{var u,x,o,S,C,A,H,V,q;if(!l)return!0;const i=l.toLowerCase();return((u=s.page)==null?void 0:u.toLowerCase().includes(i))||((x=s.user_agent)==null?void 0:x.toLowerCase().includes(i))||((o=s.ip_address)==null?void 0:o.toLowerCase().includes(i))||((C=(S=s.profiles)==null?void 0:S.first_name)==null?void 0:C.toLowerCase().includes(i))||((H=(A=s.profiles)==null?void 0:A.last_name)==null?void 0:H.toLowerCase().includes(i))||((q=(V=s.profiles)==null?void 0:V.email)==null?void 0:q.toLowerCase().includes(i))}),ee=async()=>{if(window.confirm("Êtes-vous sûr de vouloir supprimer les logs de plus de 30 jours ?"))try{const s=new Date;s.setDate(s.getDate()-30);const{error:i}=await $.from("access_logs").delete().lt("created_at",s.toISOString());if(i)throw i;t({title:"Succès",description:"Anciens logs supprimés avec succès."}),U()}catch(s){console.error("Erreur lors de la suppression:",s),t({title:"Erreur",description:"Impossible de supprimer les anciens logs.",variant:"destructive"})}},se=()=>{const s=[["Date","Utilisateur","Email","Action","Page","IP","User Agent"].join(","),...F.map(o=>{var S,C,A;return[new Date(o.created_at).toLocaleString("fr-FR"),`${((S=o.profiles)==null?void 0:S.first_name)||""} ${((C=o.profiles)==null?void 0:C.last_name)||""}`.trim()||"Utilisateur inconnu",((A=o.profiles)==null?void 0:A.email)||"",o.action,o.page||"",o.ip_address||"",`"${o.user_agent||""}"`].join(",")})].join(`
`),i=new Blob([s],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a"),x=URL.createObjectURL(i);u.setAttribute("href",x),u.setAttribute("download",`access-logs-${new Date().toISOString().split("T")[0]}.csv`),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u)},te=s=>{const i={login:"default",logout:"secondary",page_view:"outline",error:"destructive"},u={login:"Connexion",logout:"Déconnexion",page_view:"Page visitée",error:"Erreur"};return e.jsx(ue,{variant:i[s]||"outline",children:u[s]||s})},re=s=>{switch(s){case"login":return e.jsx(J,{className:"w-4 h-4"});case"logout":return e.jsx(J,{className:"w-4 h-4"});case"page_view":return e.jsx(G,{className:"w-4 h-4"});case"error":return e.jsx(T,{className:"w-4 h-4"});default:return e.jsx(T,{className:"w-4 h-4"})}};return r?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Logs d'Accès"}),e.jsx("p",{className:"text-muted-foreground",children:"Suivi des connexions et navigation des utilisateurs"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(k,{onClick:se,variant:"outline",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Exporter CSV"]}),e.jsxs(k,{onClick:ee,variant:"outline",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Nettoyer anciens logs"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(b,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Total logs"}),e.jsx(T,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(_,{children:e.jsx("div",{className:"text-2xl font-bold",children:c.length})})]}),e.jsxs(b,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Connexions"}),e.jsx(z,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(_,{children:e.jsx("div",{className:"text-2xl font-bold",children:c.filter(s=>s.action==="login").length})})]}),e.jsxs(b,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Pages vues"}),e.jsx(G,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(_,{children:e.jsx("div",{className:"text-2xl font-bold",children:c.filter(s=>s.action==="page_view").length})})]}),e.jsxs(b,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Utilisateurs uniques"}),e.jsx(z,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(_,{children:e.jsx("div",{className:"text-2xl font-bold",children:new Set(c.map(s=>s.user_id)).size})})]})]}),e.jsx(b,{children:e.jsx(_,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx("div",{children:e.jsx(ie,{placeholder:"Rechercher...",value:l,onChange:s=>w(s.target.value),className:"w-full"})}),e.jsxs(X,{value:f,onValueChange:N,children:[e.jsx(Y,{children:e.jsx(P,{placeholder:"Action"})}),e.jsxs(R,{children:[e.jsx(j,{value:"all",children:"Toutes les actions"}),e.jsx(j,{value:"login",children:"Connexions"}),e.jsx(j,{value:"logout",children:"Déconnexions"}),e.jsx(j,{value:"page_view",children:"Pages vues"}),e.jsx(j,{value:"error",children:"Erreurs"})]})]}),e.jsxs(X,{value:y,onValueChange:d,children:[e.jsx(Y,{children:e.jsx(P,{placeholder:"Utilisateur"})}),e.jsxs(R,{children:[e.jsx(j,{value:"all",children:"Tous les utilisateurs"}),M.map(s=>e.jsxs(j,{value:s.id,children:[s.first_name," ",s.last_name]},s.id))]})]}),e.jsxs(X,{value:h,onValueChange:v,children:[e.jsx(Y,{children:e.jsx(P,{placeholder:"Période"})}),e.jsxs(R,{children:[e.jsx(j,{value:"all",children:"Toutes les dates"}),e.jsx(j,{value:"today",children:"Aujourd'hui"}),e.jsx(j,{value:"week",children:"Cette semaine"}),e.jsx(j,{value:"month",children:"Ce mois"})]})]}),e.jsxs(k,{onClick:U,variant:"outline",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Actualiser"]})]})})}),e.jsxs(b,{children:[e.jsx(L,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),"Journal d'activité (",F.length," entrées)"]})}),e.jsx(_,{children:g?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Chargement des logs..."})]}):F.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(T,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Aucun log trouvé pour les critères sélectionnés."})]}):e.jsx("div",{className:"space-y-3",children:F.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsx("div",{className:"flex-shrink-0",children:re(s.action)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium",children:s.profiles?`${s.profiles.first_name} ${s.profiles.last_name}`:"Utilisateur inconnu"}),te(s.action)]}),e.jsxs("div",{className:"text-sm text-muted-foreground space-y-1",children:[s.page&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(xe,{className:"w-3 h-3"}),e.jsx("span",{children:s.page})]}),s.ip_address&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs("span",{children:["IP: ",s.ip_address]})}),s.user_agent&&e.jsx("div",{className:"text-xs truncate max-w-md",children:s.user_agent})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{children:Se(new Date(s.created_at),{addSuffix:!0,locale:je})})]})]},s.id))})})]})]}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Accès réservé aux administrateurs."})})};export{Le as default};

import{a6 as B,l as J,w as R,r as l,y as u,j as e,z as A,H as K,M as n,I as p,_ as q,N,O as S,Q as b,U as y,V as h,m as U,bl as Q,bm as G}from"./index-1760781166799.js";const C="exercise_images",X=()=>{const{id:c}=B(),x=J(),{toast:d}=R(),[a,m]=l.useState({title:"",date:new Date().toISOString().split("T")[0],short_description:"",long_description:"",external_link:"",image_url:"",document_url:"",theme:"",is_pinned:!1,is_private:!1,competition_id:null,status:"publie"}),[j,L]=l.useState(null),[f,V]=l.useState(null),[z,v]=l.useState(!1),[F,I]=l.useState(!1),[M,O]=l.useState([]),[D,P]=l.useState(null),H=["Compétition","Information générale","Stage / sortie","Événement au club","Appel au bénévolat"],E=l.useCallback(async()=>{const{data:s,error:t}=await u.from("competitions").select("id, short_title");t?d({title:"Erreur",description:"Impossible de charger les compétitions.",variant:"destructive"}):O(s||[])},[d]);l.useEffect(()=>{E(),c?(v(!0),(async()=>{try{const{data:t,error:r}=await u.from("news").select("*").eq("id",c).single();if(r)throw r;if(m({...t,date:t.date?t.date.split("T")[0]:new Date().toISOString().split("T")[0]}),t.image_url){const i=await Q(t.image_url);P(i)}}catch(t){d({title:"Erreur",description:`Impossible de charger l'actualité : ${t.message}`,variant:"destructive"}),x("/news")}finally{v(!1)}})()):(m({title:"",date:new Date().toISOString().split("T")[0],short_description:"",long_description:"",external_link:"",image_url:"",document_url:"",theme:"",is_pinned:!1,is_private:!1,competition_id:null,status:"publie"}),v(!1))},[c,x,d,E]);const o=s=>{const{name:t,value:r,type:i,checked:g}=s.target;m(_=>({..._,[t]:i==="checkbox"?g:r}))},k=(s,t)=>{s.target.files&&s.target.files[0]&&t(s.target.files[0])},T=async(s,t)=>{if(!s)return null;if(t===C){const w=await G(s);if(!w.success)throw new Error(w.error);return w.path}const r=s.name.split(".").pop(),i=`news/${Date.now()}.${r}`,{error:g}=await u.storage.from(t).upload(i,s);if(g)throw g;const{data:_}=u.storage.from(t).getPublicUrl(i);return _.publicUrl},$=async s=>{s.preventDefault(),I(!0);try{let t={...a};if(j){const i=await T(j,C);t.image_url=i}if(f){const i=await T(f,C);t.document_url=i}delete t.imageFile,delete t.documentFile,t.theme!=="Compétition"&&(t.competition_id=null);let r;if(c){const{error:i}=await u.from("news").update(t).eq("id",c);if(i)throw i;r="Actualité mise à jour avec succès."}else{const{error:i}=await u.from("news").insert(t);if(i)throw i;r="Actualité créée avec succès."}d({title:"Succès",description:r}),x("/news")}catch(t){d({title:"Erreur",description:t.message,variant:"destructive"})}finally{I(!1)}};return z?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(A,{className:"w-12 h-12 animate-spin text-primary"})}):e.jsxs("div",{className:"container mx-auto p-4 md:p-8",children:[e.jsx(K,{children:e.jsxs("title",{children:[c?"Modifier l'actualité":"Créer une actualité"," - ALJ Escalade Jonage"]})}),e.jsx("h1",{className:"text-4xl font-bold headline mb-8 flex items-center gap-3",children:c?"Modifier l'actualité":"Créer une actualité"}),e.jsxs("form",{onSubmit:$,className:"space-y-6 bg-card p-6 rounded-lg shadow-md",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"title",children:"Titre"}),e.jsx(p,{id:"title",name:"title",value:a.title,onChange:o,required:!0,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"date",children:"Date"}),e.jsx(p,{id:"date",name:"date",type:"date",value:a.date,onChange:o,required:!0,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"short_description",children:"Description courte"}),e.jsx(q,{id:"short_description",name:"short_description",value:a.short_description,onChange:o,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"long_description",children:"Description longue"}),e.jsx(q,{id:"long_description",name:"long_description",value:a.long_description,onChange:o,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"external_link",children:"Lien externe"}),e.jsx(p,{id:"external_link",name:"external_link",value:a.external_link,onChange:o,placeholder:"https://...",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"image",children:"Image"}),e.jsx(p,{id:"image",type:"file",onChange:s=>k(s,L),className:"mt-1",accept:"image/*"}),D&&!j&&e.jsxs("div",{className:"mt-2",children:[e.jsx("img",{src:D,alt:"Aperçu actuel",className:"h-20 rounded-md"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Image actuelle. Téléchargez une nouvelle image pour la remplacer."})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"document",children:"Document"}),e.jsx(p,{id:"document",type:"file",onChange:s=>k(s,V),className:"mt-1"}),a.document_url&&!f&&e.jsx("div",{className:"mt-2",children:e.jsx("a",{href:a.document_url,target:"_blank",rel:"noreferrer",className:"text-sm text-primary hover:underline",children:"Voir le document actuel"})})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"theme",children:"Thématique"}),e.jsxs(N,{name:"theme",value:a.theme,onValueChange:s=>m(t=>({...t,theme:s})),required:!0,children:[e.jsx(S,{className:"mt-1",children:e.jsx(b,{placeholder:"Sélectionnez une thématique"})}),e.jsx(y,{children:H.map(s=>e.jsx(h,{value:s,children:s},s))})]})]}),a.theme==="Compétition"&&e.jsxs("div",{children:[e.jsx(n,{htmlFor:"competition_id",children:"Compétition liée"}),e.jsxs(N,{name:"competition_id",value:a.competition_id||"",onValueChange:s=>m(t=>({...t,competition_id:s})),children:[e.jsx(S,{className:"mt-1",children:e.jsx(b,{placeholder:"Sélectionnez une compétition"})}),e.jsxs(y,{children:[e.jsx(h,{value:"",children:"Aucune"}),M.map(s=>e.jsx(h,{value:s.id,children:s.short_title},s.id))]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"is_pinned",name:"is_pinned",checked:a.is_pinned,onChange:o,className:"h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"}),e.jsx(n,{htmlFor:"is_pinned",children:"Épingler cette actualité (affichée en haut)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"is_private",name:"is_private",checked:a.is_private,onChange:o,className:"h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"}),e.jsx(n,{htmlFor:"is_private",children:"Actualité privée (réservée aux adhérents du club)"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"status",children:"Statut de publication"}),e.jsxs(N,{name:"status",value:a.status,onValueChange:s=>m(t=>({...t,status:s})),required:!0,children:[e.jsx(S,{className:"mt-1",children:e.jsx(b,{placeholder:"Sélectionnez un statut"})}),e.jsxs(y,{children:[e.jsx(h,{value:"en_cours_redaction",children:"En cours de rédaction"}),e.jsx(h,{value:"publie",children:"Publié"}),e.jsx(h,{value:"archive",children:"Archivé"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:'Les news "en cours de rédaction" ne sont visibles que par les personnes autorisées.'})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(U,{type:"button",variant:"outline",onClick:()=>x("/news"),children:"Annuler"}),e.jsx(U,{type:"submit",disabled:F,children:F?e.jsx(A,{className:"animate-spin"}):c?"Mettre à jour":"Créer"})]})]})]})};export{X as default};

import{r as l,x as se,w as ae,l as te,y as x,j as e,z as T,af as le,H as re,D as $,m as i,F as O,G as B,W as M,E as ie,ag as ne,J as ce,K as oe,B as de,aa as me,ah as ue,$ as xe,ai as he,n as pe,T as ge,a1 as fe,a2 as je,a3 as ve,a4 as ye,a5 as Ne,M as h,I as v,_ as we,ad as _e,aj as Ce}from"./index-1760781166799.js";import{A as be,a as De,b as Ae,c as Fe,d as Ee,e as Pe,f as Se,g as ke}from"./alert-dialog-1760781166799.js";import{U as q}from"./upload-1760781166799.js";const H="cycle_documents",Ue=()=>{const[E,R]=l.useState([]),[G,P]=l.useState(!0),[V,y]=l.useState(!1),[t,N]=l.useState(null),[o,w]=l.useState(null),[S,k]=l.useState(!1),{user:J,isAdmin:z,isEncadrant:K}=se(),{toast:n}=ae(),W=te(),[r,d]=l.useState({name:"",short_description:"",long_description:""}),[p,_]=l.useState(null),[f,C]=l.useState(null),[I,j]=l.useState(null),[g,m]=l.useState("center"),b=z||K;l.useEffect(()=>{D()},[]);const D=async()=>{P(!0);try{const{data:s,error:a}=await x.from("cycles").select(`
          *,
          sessions:sessions(count)
        `).eq("is_active",!0).order("created_at",{ascending:!1});if(a)throw a;R(s||[])}catch(s){n({title:"Erreur",description:`Impossible de charger les cycles: ${s.message}`,variant:"destructive"})}finally{P(!1)}},A=(s=null)=>{s?(N(s),d({name:s.name,short_description:s.short_description||"",long_description:s.long_description||""}),j(s.image_url||null),m(s.image_position||"center")):(N(null),d({name:"",short_description:"",long_description:""}),j(null),m("center")),_(null),C(null),y(!0)},L=()=>{y(!1),N(null),d({name:"",short_description:"",long_description:""}),_(null),C(null),j(null),m("center")},Y=s=>{var c;const a=(c=s.target.files)==null?void 0:c[0];if(a){C(a);const u=new FileReader;u.onloadend=()=>{j(u.result)},u.readAsDataURL(a)}},U=async(s,a)=>{const c=s.name.split(".").pop(),u=`${a}/${(t==null?void 0:t.id)||"new"}_${Date.now()}.${c}`,{error:F}=await x.storage.from(H).upload(u,s);if(F)throw console.error("Upload error:",F),new Error(`Erreur d'upload: ${F.message}`);const{data:ee}=x.storage.from(H).getPublicUrl(u);return ee.publicUrl},Q=async()=>{if(!r.name.trim()){n({title:"Erreur",description:"Le nom du cycle est obligatoire",variant:"destructive"});return}k(!0);try{const s={name:r.name,short_description:r.short_description,long_description:r.long_description,image_position:g};if(p){const a=await U(p,"pdfs");s.pdf_url=a}if(f){const a=await U(f,"images");s.image_url=a}if(t){const{error:a}=await x.from("cycles").update(s).eq("id",t.id);if(a)throw a;n({title:"Succès",description:"Cycle mis à jour avec succès"})}else{const{error:a}=await x.from("cycles").insert({...s,created_by:J.id});if(a)throw a;n({title:"Succès",description:"Cycle créé avec succès"})}L(),D()}catch(s){n({title:"Erreur",description:`Impossible de sauvegarder le cycle: ${s.message}`,variant:"destructive"})}finally{k(!1)}},X=async()=>{if(o)try{const{error:s}=await x.from("cycles").update({is_active:!1}).eq("id",o.id);if(s)throw s;n({title:"Succès",description:"Cycle archivé avec succès"}),w(null),D()}catch(s){n({title:"Erreur",description:`Impossible d'archiver le cycle: ${s.message}`,variant:"destructive"})}},Z=s=>{W(`/cycles/${s}`)};return G?e.jsx("div",{className:"flex justify-center items-center min-h-[60vh]",children:e.jsx(T,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsx(le,{requireAdherent:!0,pageTitle:"Gestion des cycles",message:"La gestion des cycles est réservée aux adhérents du club. Veuillez vous connecter avec un compte adhérent pour y accéder.",children:e.jsxs(e.Fragment,{children:[e.jsx(re,{children:e.jsx("title",{children:"Gestion des Cycles - ALJ Escalade"})}),e.jsx("div",{className:"container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl",children:e.jsxs($.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2",children:"Gestion des Cycles"}),e.jsx("p",{className:"text-gray-600 text-sm sm:text-base",children:"Organisez vos séances en cycles thématiques"})]}),b&&e.jsxs(i,{onClick:()=>A(),size:"lg",className:"w-full sm:w-auto",children:[e.jsx(O,{className:"w-5 h-5 mr-2"}),"Nouveau Cycle"]})]}),E.length===0?e.jsx(B,{children:e.jsxs(M,{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(ie,{className:"w-16 h-16 text-gray-300 mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg mb-4",children:"Aucun cycle pour le moment"}),b&&e.jsxs(i,{onClick:()=>A(),children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"Créer le premier cycle"]})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:e.jsx(ne,{children:E.map(s=>{var a,c;return e.jsx($.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.3},children:e.jsxs(B,{className:"hover:shadow-lg transition-shadow h-full flex flex-col overflow-hidden",children:[s.image_url&&e.jsx("div",{className:"relative w-full h-48 overflow-hidden bg-gray-100",children:e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-300",style:{objectPosition:s.image_position||"center"}})}),e.jsxs(ce,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 mb-2",children:[e.jsx(oe,{className:"text-lg sm:text-xl break-words",children:s.name}),e.jsxs(de,{variant:"secondary",className:"w-fit flex-shrink-0",children:[e.jsx(me,{className:"w-3 h-3 mr-1"}),((c=(a=s.sessions)==null?void 0:a[0])==null?void 0:c.count)||0," séances"]})]}),s.short_description&&e.jsx(ue,{className:"line-clamp-2 break-words",children:s.short_description})]}),e.jsx(M,{className:"flex-grow",children:s.long_description&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-3 break-words",children:s.long_description})}),e.jsxs(xe,{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>Z(s.id),className:"flex-1 sm:flex-initial w-full sm:w-auto",children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"Voir"]}),b&&e.jsxs("div",{className:"flex gap-2 flex-1 sm:flex-initial",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>A(s),className:"flex-1 sm:flex-initial",children:e.jsx(pe,{className:"w-4 h-4"})}),z&&e.jsx(i,{variant:"outline",size:"sm",onClick:()=>w(s),className:"text-red-600 hover:text-red-700 flex-1 sm:flex-initial",children:e.jsx(ge,{className:"w-4 h-4"})})]})]})]})},s.id)})})})]})}),e.jsx(fe,{open:V,onOpenChange:y,children:e.jsxs(je,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsx(ye,{children:t?"Modifier le cycle":"Créer un nouveau cycle"}),e.jsx(Ne,{children:t?"Modifiez les informations du cycle et ajoutez des documents":"Créez un nouveau cycle pour regrouper vos séances"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"name",children:"Nom du cycle *"}),e.jsx(v,{id:"name",value:r.name,onChange:s=>d({...r,name:s.target.value}),placeholder:"Ex: Initiation Bloc 2025"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"short_description",children:"Description courte"}),e.jsx(v,{id:"short_description",value:r.short_description,onChange:s=>d({...r,short_description:s.target.value}),placeholder:"Résumé en une phrase"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"long_description",children:"Description détaillée"}),e.jsx(we,{id:"long_description",value:r.long_description,onChange:s=>d({...r,long_description:s.target.value}),placeholder:"Décrivez les objectifs et le contenu du cycle...",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"cycle-image",children:"Image illustrative"}),I&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative w-full h-48 overflow-hidden bg-gray-100 rounded-lg border-2 border-gray-200",children:e.jsx("img",{src:I,alt:"Aperçu",className:"w-full h-full object-cover",style:{objectPosition:g}})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm",children:"Position de l'image"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(i,{type:"button",variant:g==="top"?"default":"outline",size:"sm",onClick:()=>m("top"),className:"text-xs",children:"Haut"}),e.jsx(i,{type:"button",variant:g==="center"?"default":"outline",size:"sm",onClick:()=>m("center"),className:"text-xs",children:"Centre"}),e.jsx(i,{type:"button",variant:g==="bottom"?"default":"outline",size:"sm",onClick:()=>m("bottom"),className:"text-xs",children:"Bas"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{id:"cycle-image",type:"file",accept:"image/*",onChange:Y,className:"flex-1"}),f&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(q,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:f?"Une nouvelle image sera téléchargée":t!=null&&t.image_url?"Laisser vide pour conserver l'image actuelle":"Format recommandé: 16:9 (1200x675px)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"cycle-pdf",children:"Document PDF"}),(t==null?void 0:t.pdf_url)&&!p&&e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(_e,{className:"w-4 h-4 text-red-600"}),e.jsx("a",{href:t.pdf_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline",children:"Document actuel"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{id:"cycle-pdf",type:"file",accept:".pdf",onChange:s=>{var a;return _(((a=s.target.files)==null?void 0:a[0])||null)},className:"flex-1"}),p&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(q,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:p?"Un nouveau PDF sera téléchargé":t!=null&&t.pdf_url?"Laisser vide pour conserver le PDF actuel":"Optionnel: ajoutez un document PDF"})]})]}),e.jsxs(Ce,{children:[e.jsx(i,{variant:"outline",onClick:L,children:"Annuler"}),e.jsxs(i,{onClick:Q,disabled:S,children:[S&&e.jsx(T,{className:"w-4 h-4 mr-2 animate-spin"}),t?"Mettre à jour":"Créer"]})]})]})}),e.jsx(be,{open:!!o,onOpenChange:()=>w(null),children:e.jsxs(De,{children:[e.jsxs(Ae,{children:[e.jsx(Fe,{children:"Archiver ce cycle ?"}),e.jsxs(Ee,{children:['Le cycle "',o==null?void 0:o.name,'" sera archivé. Les séances associées ne seront pas supprimées. Cette action peut être annulée en restaurant le cycle depuis les archives.']})]}),e.jsxs(Pe,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(ke,{onClick:X,className:"bg-red-600 hover:bg-red-700",children:"Archiver"})]})]})})]})})};export{Ue as default};

import{c as Y,r as n,Q as Ne,O as ee,af as be,t as b,j as e,R as L,U as ye,m as q,B as v,P as Ce,C as $,b as T,d as O,Z as H,e as V,F as B,G,H as p,J as x,K as J,M as t,x as K,X as se,N as ke,n as te,o as ae,p as re,q as ie,s as ne,E as we,g as r,f as Z,W as Se,am as Ae,an as Ee,ao as _e,S as ce,I as Q,D as Le,h as De,i as Me,k as Pe,l as Re,L as z,$ as Fe,ap as Ue}from"./index-1760371537854.js";import{A as qe,h as ze,a as Ie,b as $e,c as Te,d as Oe,e as He,f as Ve,g as Be}from"./alert-dialog-1760371537854.js";import{S as Ge}from"./save-1760371537854.js";const Je=Y("MailCheck",[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m16 19 2 2 4-4",key:"1b14m6"}]]),Ke=Y("UserCog",[["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m21.7 16.4-.9-.3",key:"12j9ji"}],["path",{d:"m15.2 13.9-.9-.3",key:"1fdjdi"}],["path",{d:"m16.6 18.7.3-.9",key:"heedtr"}],["path",{d:"m19.1 12.2.3-.9",key:"1af3ki"}],["path",{d:"m19.6 18.7-.4-1",key:"1x9vze"}],["path",{d:"m16.8 12.3-.4-1",key:"vqeiwj"}],["path",{d:"m14.3 16.6 1-.4",key:"1qlj63"}],["path",{d:"m20.7 13.8 1-.4",key:"1v5t8k"}]]);function W(h,u,y=!1){if(!h)return u||"";if(!u)return h||"";const j=h.charAt(0).toUpperCase()+h.slice(1).toLowerCase();if(y){const o=u.toUpperCase();return`${j} ${o}`}const g=`${u.charAt(0).toUpperCase()}.`;return`${j} ${g}`}const le=["admin","bureau","encadrant","adherent","user"],Qe=[{to:"/news",text:"Actualités"},{to:"/schedule",text:"Planning"},{to:"/inscriptions",text:"Inscription"},{to:"/contact",text:"Contact"},{to:"/volunteers",text:"Adhérent"},{to:"/competitions",text:"Compétitions"},{to:"/agenda",text:"Agenda"},{to:"/session-log",text:"Séances"},{to:"/cycles",text:"Cycles"},{to:"/passeport-validation",text:"Validation Passeports"}],de=({onSelect:h,children:u,existingLinks:y})=>{const[j,g]=n.useState(!1),[o,C]=n.useState(""),[l,P]=n.useState([]),[c,N]=n.useState(!1),[A,k]=n.useState([]);n.useEffect(()=>{(async()=>{const{data:d}=await b.from("members").select("id, first_name, last_name");d&&k(d)})()},[]),n.useEffect(()=>{if(!j)return;N(!0);const m=A.filter(d=>!y.includes(d.id)&&(o===""||`${d.first_name} ${d.last_name}`.toLowerCase().includes(o.toLowerCase()))).slice(0,10);P(m),N(!1)},[o,j,y,A]);const D=m=>{h(m),g(!1),C("")};return e.jsxs(Ae,{open:j,onOpenChange:g,children:[e.jsx(Ee,{asChild:!0,children:u}),e.jsxs(_e,{className:"w-80 p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Q,{placeholder:"Rechercher un membre...",value:o,onChange:m=>C(m.target.value),className:"pl-8"})]})}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:c?e.jsx("div",{className:"flex justify-center p-4",children:e.jsx(L,{className:"h-5 w-5 animate-spin"})}):l.length>0?l.map(m=>e.jsx("div",{onClick:()=>D(m),className:"p-2 hover:bg-accent cursor-pointer text-sm",children:W(m.first_name,m.last_name,!0)},m.id)):e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"Aucun membre trouvé."})})]})]})},We=({isOpen:h,onClose:u,onUserCreated:y})=>{const[j,g]=n.useState(""),[o,C]=n.useState(""),[l,P]=n.useState("user"),[c,N]=n.useState(null),[A,k]=n.useState(!1),{toast:D}=ee(),m=async d=>{d.preventDefault(),k(!0);try{const{data:w,error:R}=await b.functions.invoke("admin-create-user",{body:{email:j,password:o,role:l,member_id:(c==null?void 0:c.id)||null}});if(R||!w||!w.user)throw new Error("La création de l'utilisateur a échoué.");const I=w.user;D({title:"Succès",description:"Utilisateur créé avec succès."}),y(),u()}catch(w){D({title:"Erreur",description:w.message,variant:"destructive"})}finally{k(!1)}};return e.jsx(Le,{open:h,onOpenChange:u,children:e.jsxs(De,{children:[e.jsxs(Me,{children:[e.jsx(Pe,{children:"Créer un nouvel utilisateur"}),e.jsx(Re,{children:"Créez un compte et liez-le à un profil de membre existant. Le compte sera validé automatiquement."})]}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(z,{htmlFor:"email",children:"Email"}),e.jsx(Q,{id:"email",type:"email",value:j,onChange:d=>g(d.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(z,{htmlFor:"password",children:"Mot de passe"}),e.jsx(Q,{id:"password",type:"password",value:o,onChange:d=>C(d.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(z,{children:"Rôle"}),e.jsxs(te,{value:l,onValueChange:P,children:[e.jsx(ae,{children:e.jsx(re,{})}),e.jsx(ie,{children:le.map(d=>e.jsx(ne,{value:d,children:e.jsx("span",{className:"capitalize",children:d})},d))})]})]}),e.jsxs("div",{children:[e.jsx(z,{children:"Lier à un membre"}),c?e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-md",children:[e.jsx("span",{children:W(c.first_name,c.last_name,!0)}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>N(null),children:e.jsx(se,{className:"h-4 w-4"})})]}):e.jsx(de,{onSelect:N,existingLinks:[],children:e.jsxs(v,{variant:"outline",className:"w-full justify-start font-normal",children:[e.jsx(ce,{className:"mr-2 h-4 w-4"})," Rechercher un membre..."]})})]}),e.jsxs(Fe,{children:[e.jsx(v,{type:"button",variant:"outline",onClick:u,children:"Annuler"}),e.jsxs(v,{type:"submit",disabled:A,children:[A?e.jsx(L,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Créer l'utilisateur"]})]})]})]})})},es=()=>{const[h,u]=n.useState([]),[y,j]=n.useState(!0),[g,o]=n.useState(null),{isAdmin:C,user:l,loading:P}=Ne(),{toast:c}=ee(),{config:N,updateConfig:A,loadingConfig:k}=be(),D=s=>{switch(s){case"/news":case"/schedule":case"/inscriptions":case"/contact":case"/agenda":return["public","user","adherent","bureau","encadrant","admin"];case"/volunteers":case"/competitions":case"/session-log":case"/cycles":return["adherent","bureau","encadrant","admin"];case"/passeport-validation":return["encadrant","admin"];default:return["adherent","bureau","encadrant","admin"]}},[m,d]=n.useState(Qe.map(s=>({to:s.to,text:s.text,roles:D(s.to)}))),[w,R]=n.useState(!1),[I,X]=n.useState(!1),[oe,F]=n.useState(null),E=n.useCallback(async()=>{if(l){j(!0);try{const{data:s,error:a}=await b.from("profiles").select("*, members(id, first_name, last_name)");if(a)throw a;const{data:i,error:f}=await b.functions.invoke("get-users",{body:{userId:l.id}});if(f)throw f;if(i.error)throw new Error(i.error);const S=i.users,_=s.map(U=>{const M=S.find(ve=>ve.id===U.id);return{...U,email:M==null?void 0:M.email,email_confirmed_at:M==null?void 0:M.email_confirmed_at}});u(_)}catch(s){c({title:"Erreur",description:`Impossible de charger les utilisateurs: ${s.message}`,variant:"destructive"})}finally{j(!1)}}},[l==null?void 0:l.id]);n.useEffect(()=>{C&&(l!=null&&l.id)&&E()},[C,l==null?void 0:l.id]);const me=n.useMemo(()=>h.map(s=>s.member_id).filter(Boolean),[h]),xe=async(s,a)=>{F(s);const{error:i}=await b.from("profiles").update({member_id:a.id}).eq("id",s);i?c({title:"Erreur",description:"Impossible de lier le membre.",variant:"destructive"}):(c({title:"Succès",description:"Membre lié au profil."}),E()),F(null)},he=async s=>{F(s);const{error:a}=await b.from("profiles").update({member_id:null}).eq("id",s);a?c({title:"Erreur",description:"Impossible de délier le membre.",variant:"destructive"}):(c({title:"Succès",description:"Membre délié du profil."}),E()),F(null)};n.useEffect(()=>{if(!k&&N.nav_config)try{const s=JSON.parse(N.nav_config);d(a=>{const i=[...a];return s.forEach(f=>{const S=i.findIndex(_=>_.to===f.to);S!==-1&&(i[S].roles=f.roles)}),i})}catch(s){console.error("Failed to parse nav_config:",s)}},[N.nav_config,k]);const ue=async(s,a)=>{o(s);try{const{data:i,error:f}=await b.functions.invoke("set-user-role",{body:{userId:s,role:a}});if(f)throw f;if(i.error)throw new Error(i.error);c({title:"Succès",description:"Le rôle a été mis à jour."}),E()}catch(i){c({title:"Erreur",description:i.message,variant:"destructive"})}finally{o(null)}},je=(s,a,i)=>{d(f=>{const S=[...f],_=S[s].roles;return i?_.includes(a)||_.push(a):S[s].roles=_.filter(U=>U!==a),S})},fe=async()=>{R(!0);const{error:s}=await A("nav_config",JSON.stringify(m));c(s?{title:"Erreur",description:"Impossible de sauvegarder la configuration du menu.",variant:"destructive"}:{title:"Succès",description:"Configuration du menu sauvegardée."}),R(!1)},pe=async(s,a)=>{o(s);try{const{error:i}=await b.functions.invoke("confirm-user",{body:{userId:s}});if(i)throw i;c({title:"Succès",description:`L'email de ${a} a été confirmé.`}),E()}catch(i){c({title:"Erreur",description:i.message,variant:"destructive"})}finally{o(null)}},ge=async s=>{o(s.id);try{const{data:a,error:i}=await b.functions.invoke("delete-user",{body:{userId:s.id}});if(i)throw new Error(`Function error: ${i.message}`);if(a.error)throw new Error(`Function returned error: ${a.error}`);c({title:"Succès",description:`L'utilisateur ${s.email} a été supprimé.`}),E()}catch(a){c({title:"Erreur",description:a.message,variant:"destructive"})}finally{o(null)}};return P||k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(L,{className:"w-12 h-12 animate-spin text-primary"})}):C?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-8",children:[e.jsx(ye,{children:e.jsx("title",{children:"Gestion des Rôles et Accès"})}),e.jsxs(q.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl font-bold headline flex items-center gap-3",children:[e.jsx(Ke,{className:"w-10 h-10 text-primary"}),"Gestion des Rôles & Accès"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Gérez les rôles des utilisateurs et les accès aux pages."})]}),e.jsxs(v,{onClick:()=>X(!0),children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"})," Créer un utilisateur"]})]}),e.jsx(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},children:e.jsxs($,{children:[e.jsxs(T,{children:[e.jsx(O,{children:"Rôles des Utilisateurs"}),e.jsx(H,{children:"Liste de tous les utilisateurs inscrits."})]}),e.jsx(V,{children:y?e.jsx("div",{className:"flex justify-center items-center py-16",children:e.jsx(L,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs(B,{children:[e.jsx(G,{children:e.jsxs(p,{children:[e.jsx(x,{children:"Email"}),e.jsx(x,{children:"Adhérent Lié"}),e.jsx(x,{children:"Rôle"}),e.jsx(x,{className:"text-right",children:"Actions"})]})}),e.jsx(J,{children:h.map(s=>e.jsxs(p,{children:[e.jsxs(t,{className:"font-medium truncate max-w-[200px]",children:[s.email,!s.email_confirmed_at&&e.jsx(K,{variant:"outline",className:"ml-2",children:"Non confirmé"})]}),e.jsx(t,{children:oe===s.id?e.jsx(L,{className:"h-4 w-4 animate-spin"}):s.members?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{variant:"secondary",className:"truncate",children:W(s.members.first_name,s.members.last_name,!0)}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>he(s.id),children:e.jsx(se,{className:"h-4 w-4"})})]}):e.jsx(de,{onSelect:a=>xe(s.id,a),existingLinks:me,children:e.jsxs(v,{variant:"outline",size:"sm",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"})," Lier"]})})}),e.jsx(t,{children:s.id===l.id?e.jsx(K,{children:"Vous (Admin)"}):g===s.id?e.jsx("div",{className:"flex justify-start",children:e.jsx(L,{className:"w-5 h-5 animate-spin"})}):e.jsxs(te,{value:s.role||"user",onValueChange:a=>ue(s.id,a),children:[e.jsx(ae,{className:"w-[120px]",children:e.jsx(re,{placeholder:"Rôle"})}),e.jsx(ie,{children:le.map(a=>e.jsx(ne,{value:a,children:e.jsx("span",{className:"capitalize",children:a})},a))})]})}),e.jsx(t,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.id!==l.id&&!s.email_confirmed_at&&e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>pe(s.id,s.email),disabled:g===s.id,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"})," Confirmer"]}),s.id!==l.id&&e.jsxs(qe,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(v,{variant:"destructive",size:"icon",disabled:g===s.id,children:e.jsx(we,{className:"h-4 w-4"})})}),e.jsxs(Ie,{children:[e.jsxs($e,{children:[e.jsx(Te,{children:"Êtes-vous sûr ?"}),e.jsxs(Oe,{children:["Cette action est irréversible. Elle supprimera définitivement le compte de ",e.jsx("strong",{children:s.email}),"."]})]}),e.jsxs(He,{children:[e.jsx(Ve,{children:"Annuler"}),e.jsx(Be,{onClick:()=>ge(s),children:"Supprimer"})]})]})]})]})})]},s.id))})]})})]})}),e.jsx(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsxs($,{children:[e.jsxs(T,{children:[e.jsx(O,{children:"Accès aux Pages du Menu"}),e.jsx(H,{children:"Définissez quels rôles peuvent voir chaque page dans le menu principal."})]}),e.jsx(V,{children:e.jsxs(B,{children:[e.jsx(G,{children:e.jsxs(p,{children:[e.jsx(x,{children:"Page"}),e.jsx(x,{className:"text-center",children:"Public"}),e.jsx(x,{className:"text-center",children:"Utilisateur"}),e.jsx(x,{className:"text-center",children:"Adhérent"}),e.jsx(x,{className:"text-center",children:"Bureau"}),e.jsx(x,{className:"text-center",children:"Encadrant"}),e.jsx(x,{className:"text-center",children:"Admin"})]})}),e.jsx(J,{children:m.map((s,a)=>e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:s.text}),["public","user","adherent","bureau","encadrant","admin"].map(i=>e.jsx(t,{className:"text-center",children:e.jsx(r,{checked:s.roles.includes(i),onCheckedChange:f=>je(a,i,f)})},i))]},s.to))})]})}),e.jsx(Z,{children:e.jsxs(v,{onClick:fe,disabled:w,children:[w?e.jsx(L,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx(Ge,{className:"w-4 h-4 mr-2"}),"Sauvegarder les Accès du Menu"]})})]})}),e.jsx(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},children:e.jsxs($,{children:[e.jsxs(T,{children:[e.jsx(O,{children:"Permissions Spéciales"}),e.jsx(H,{children:"Définissez les permissions avancées pour chaque rôle."})]}),e.jsx(V,{children:e.jsxs(B,{children:[e.jsx(G,{children:e.jsxs(p,{children:[e.jsx(x,{children:"Permission"}),e.jsx(x,{className:"text-center",children:"Adhérent"}),e.jsx(x,{className:"text-center",children:"Bureau"}),e.jsx(x,{className:"text-center",children:"Encadrant"}),e.jsx(x,{className:"text-center",children:"Admin"})]})}),e.jsxs(J,{children:[e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:"Voir le nom de famille en entier"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:"Éditer la fiche d'un membre"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:"Supprimer un membre"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:"Accéder aux logs de connexion"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:"Gestion des rôles & accès"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:"Ajouter une fiche pédagogique"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]}),e.jsxs(p,{children:[e.jsx(t,{className:"font-medium",children:"Créer/modifier une compétition"}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!1})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})}),e.jsx(t,{className:"text-center",children:e.jsx(r,{disabled:!0,checked:!0})})]})]})]})}),e.jsx(Z,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"Note :"})," Ces permissions sont définies dans le code et ne peuvent pas être modifiées ici. Ce tableau sert de référence pour comprendre les droits de chaque rôle."]})})]})})]}),e.jsx(Se,{children:I&&e.jsx(We,{isOpen:I,onClose:()=>X(!1),onUserCreated:E})})]}):e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Accès non autorisé"}),e.jsx("p",{className:"text-muted-foreground",children:"Cette page est réservée aux administrateurs."})]})};export{es as default};

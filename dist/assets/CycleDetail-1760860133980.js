import{a6 as Le,l as Pe,x as qe,w as Oe,r,j as e,z as y,af as $e,H as ze,D as ie,m as n,a9 as Re,ak as Ue,ad as oe,F as Z,G as _,J as D,K as E,W as k,ah as Te,aa as de,B as Me,ac as me,ab as Be,al as He,T as Ve,a1 as z,a2 as R,a3 as U,a4 as T,a5 as M,N as Je,O as Ke,Q as We,U as Ge,V as Qe,aj as B,I as h,am as ee,M as N,y as d}from"./index-1760860133980.js";import{U as xe}from"./upload-1760860133980.js";const ue="cycle_documents",es=()=>{const{id:o}=Le(),H=Pe(),{user:Ye,isAdmin:he,isEncadrant:pe}=qe(),{toast:i}=Oe(),[t,je]=r.useState(null),[g,ge]=r.useState([]),[se,fe]=r.useState([]),[ae,V]=r.useState(!0),[ve,w]=r.useState(!1),[ye,J]=r.useState(!1),[Ne,A]=r.useState(!1),[we,F]=r.useState(!1),[I,K]=r.useState(""),[f,v]=r.useState(!1),[te,ce]=r.useState(!1),[x,L]=r.useState(null),[P,W]=r.useState(null),[q,G]=r.useState(null),[re,Q]=r.useState(null),[b,S]=r.useState("center"),[p,O]=r.useState({instructors:[],session_objective:"",equipment:"",comment:""}),[j,$]=r.useState({session_objective:"Séance fictive",instructors:[],equipment:"",comment:"Cette séance est fictive et n'a pas de date."}),u=he||pe,be=s=>{H(`/session-log/edit/${s.id}?from=cycle&cycleId=${o}`)},Se=()=>{L({name:t.name||"",short_description:t.short_description||"",long_description:t.long_description||""}),Q(t.image_url||null),S(t.image_position||"center"),F(!0)},Ce=s=>{var l;const a=(l=s.target.files)==null?void 0:l[0];if(a){G(a);const c=new FileReader;c.onloadend=()=>{Q(c.result)},c.readAsDataURL(a)}},le=async(s,a)=>{const l=s.name.split(".").pop(),c=`${a}/${o}_${Date.now()}.${l}`,{error:m}=await d.storage.from(ue).upload(c,s);if(m)throw new Error(`Erreur d'upload: ${m.message||`Le bucket "cycle_documents" n'existe peut-être pas dans Supabase Storage`}`);const{data:X}=d.storage.from(ue).getPublicUrl(c);return X.publicUrl},_e=async()=>{ce(!0);try{const s={...x,image_position:b};if(P){const l=await le(P,"pdfs");s.pdf_url=l}if(q){const l=await le(q,"images");s.image_url=l}const{error:a}=await d.from("cycles").update(s).eq("id",o);if(a)throw a;i({title:"Succès",description:"Le cycle a été mis à jour avec succès."}),F(!1),W(null),G(null),Q(null),S("center"),ne()}catch(s){i({title:"Erreur",description:`Impossible de mettre à jour le cycle: ${s.message}`,variant:"destructive"})}finally{ce(!1)}},ne=async()=>{try{const{data:s,error:a}=await d.from("cycles").select("*").eq("id",o).single();if(a)throw a;je(s),V(!1)}catch(s){i({title:"Erreur",description:`Impossible de charger le cycle: ${s.message}`,variant:"destructive"}),H("/cycles")}},Y=async()=>{try{const{data:s,error:a}=await d.from("sessions").select("id, date, start_time, instructors").is("cycle_id",null).order("date",{ascending:!1}).limit(50);if(a)throw a;fe(s||[])}catch(s){console.error("Erreur lors du chargement des séances disponibles:",s)}},C=async()=>{try{const{data:s,error:a}=await d.from("sessions").select("*").eq("cycle_id",o).order("date",{ascending:!1,nullsFirst:!1});if(a)throw a;ge(s||[]),V(!1)}catch(s){console.error("Erreur lors du chargement des séances du cycle:",s),i({title:"Erreur",description:`Impossible de charger les séances: ${s.message}`,variant:"destructive"}),V(!1)}},De=async()=>{if(!I){i({title:"Erreur",description:"Veuillez sélectionner une séance",variant:"destructive"});return}v(!0);try{const{error:s}=await d.from("sessions").update({cycle_id:o}).eq("id",I);if(s)throw s;i({title:"Succès",description:"Séance ajoutée au cycle"}),w(!1),K(""),C(),Y()}catch(s){i({title:"Erreur",description:`Impossible d'ajouter la séance: ${s.message}`,variant:"destructive"})}finally{v(!1)}},Ee=async s=>{try{const{error:a}=await d.from("sessions").update({cycle_id:null}).eq("id",s);if(a)throw a;i({title:"Succès",description:"Séance retirée du cycle"}),C(),u&&Y()}catch(a){i({title:"Erreur",description:`Impossible de retirer la séance: ${a.message}`,variant:"destructive"})}},ke=async()=>{v(!0);try{const{error:s}=await d.from("sessions").insert({...p,cycle_id:o,date:null});if(s)throw s;i({title:"Succès",description:"Séance créée avec succès."}),J(!1),O({instructors:[],session_objective:"",equipment:"",comment:""}),C()}catch(s){i({title:"Erreur",description:`Impossible de créer la séance: ${s.message}`,variant:"destructive"})}finally{v(!1)}},Ae=async()=>{v(!0);try{const{error:s}=await d.from("sessions").insert({...j,cycle_id:o,date:null});if(s)throw s;i({title:"Succès",description:"Séance fictive créée avec succès."}),A(!1),$({session_objective:"Séance fictive",instructors:[],equipment:"",comment:"Cette séance est fictive et n'a pas de date."}),C()}catch(s){i({title:"Erreur",description:`Impossible de créer la séance fictive: ${s.message}`,variant:"destructive"})}finally{v(!1)}},Fe=s=>new Date(s).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"});r.useEffect(()=>{o&&(ne(),C(),u&&Y())},[o,u]);const Ie=g;return ae&&!t?e.jsx("div",{className:"flex justify-center items-center min-h-[60vh]",children:e.jsx(y,{className:"h-8 w-8 animate-spin text-primary"})}):t?e.jsxs($e,{requireAdherent:!0,pageTitle:"Détail du cycle",message:"Les détails des cycles sont réservés aux adhérents du club. Veuillez vous connecter avec un compte adhérent pour y accéder.",children:[e.jsx(ze,{children:e.jsxs("title",{children:[t.name," - Cycles - ALJ Escalade"]})}),e.jsx("div",{className:"container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl",children:e.jsxs(ie.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(n,{variant:"ghost",onClick:()=>H("/cycles"),className:"mb-4",children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Retour aux cycles"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-start gap-4",children:[t.image_url&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx("a",{href:t.image_url,target:"_blank",rel:"noopener noreferrer",className:"block",children:e.jsx("img",{src:t.image_url,alt:t.name,className:"w-24 h-24 sm:w-32 sm:h-32 object-cover rounded-lg shadow-md hover:shadow-lg transition-shadow border-2 border-gray-200"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 flex-wrap",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900",children:t.name}),u&&e.jsxs(n,{variant:"outline",size:"sm",onClick:Se,className:"flex-shrink-0",children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"Modifier"]})]}),t.short_description&&e.jsx("p",{className:"text-lg sm:text-xl text-gray-600 mb-4",children:t.short_description}),t.long_description&&e.jsx("p",{className:"text-gray-600 max-w-3xl",children:t.long_description}),t.pdf_url&&e.jsx("div",{className:"mt-4",children:e.jsxs("a",{href:t.pdf_url,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100 transition-colors",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Document PDF"})]})})]})]})}),u&&e.jsxs(n,{onClick:()=>w(!0),className:"w-full sm:w-auto flex-shrink-0",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Ajouter une séance"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8",children:[e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Nombre de séances"})}),e.jsx(k,{children:e.jsx("div",{className:"text-3xl font-bold",children:g.length})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Élèves participants"})}),e.jsx(k,{children:e.jsx("div",{className:"space-y-1",children:(()=>{const s=new Set;g.forEach(l=>{var c;(c=l.students)==null||c.forEach(m=>s.add(m))});const a=Array.from(s).sort();return a.length>0?e.jsx("div",{className:"text-sm max-h-32 overflow-y-auto",children:a.map((l,c)=>e.jsxs("div",{className:"py-0.5",children:["• ",l]},c))}):e.jsx("div",{className:"text-sm text-gray-400",children:"Aucun élève"})})()})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Encadrants"})}),e.jsx(k,{children:e.jsx("div",{className:"space-y-1",children:(()=>{const s=new Set;g.forEach(l=>{var c;(c=l.instructors)==null||c.forEach(m=>s.add(m))});const a=Array.from(s).sort();return a.length>0?e.jsx("div",{className:"text-sm",children:a.map((l,c)=>e.jsxs("div",{className:"py-0.5",children:["• ",l]},c))}):e.jsx("div",{className:"text-sm text-gray-400",children:"Aucun encadrant"})})()})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsx(E,{className:"text-sm font-medium text-gray-600",children:"Période"})}),e.jsx(k,{children:e.jsx("div",{className:"text-sm break-words",children:(()=>{var c,m;const s=g.filter(X=>X.date);if(s.length===0)return"Aucune date";const a=(c=s[s.length-1])==null?void 0:c.date,l=(m=s[0])==null?void 0:m.date;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1",children:[e.jsx("span",{children:new Date(a).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}),e.jsx("span",{className:"hidden sm:inline",children:"→"}),e.jsx("span",{className:"sm:hidden",children:"↓"}),e.jsx("span",{children:new Date(l).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})})]})})()})})]})]}),e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsx(E,{children:"Séances du cycle"}),e.jsx(Te,{children:"Liste de toutes les séances associées à ce cycle"})]}),e.jsx(k,{children:ae?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(y,{className:"h-6 w-6 animate-spin"})}):g.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(de,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Aucune séance dans ce cycle"}),u&&e.jsxs(n,{onClick:()=>w(!0),children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Ajouter une séance"]})]}):e.jsx("div",{className:"space-y-4",children:Ie.map(s=>{var a;return e.jsx(ie.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2",children:[e.jsx("h3",{className:"font-semibold text-base sm:text-lg",children:s.session_objective||"Séance sans objectif"}),e.jsxs(Me,{variant:"secondary",className:"w-fit",children:[e.jsx(me,{className:"w-3 h-3 mr-1"}),((a=s.students)==null?void 0:a.length)||0," participants"]})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[s.date&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:Fe(s.date)})]}),s.start_time&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.start_time})]}),s.instructors&&s.instructors.length>0&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(me,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("span",{className:"break-words",children:["Encadrants: ",s.instructors.join(", ")]})]})]})]}),u&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>be(s),className:"text-blue-600 hover:text-blue-700 hover:bg-blue-50",children:e.jsx(He,{className:"w-4 h-4"})}),e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>Ee(s.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(Ve,{className:"w-4 h-4"})})]})]})},s.id)})})})]}),u&&e.jsx("div",{className:"mt-4",children:e.jsxs(n,{onClick:()=>A(!0),className:"w-full sm:w-auto",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"})," Créer une séance fictive"]})})]})}),e.jsx(z,{open:ve,onOpenChange:w,children:e.jsxs(R,{children:[e.jsxs(U,{children:[e.jsx(T,{children:"Ajouter une séance au cycle"}),e.jsx(M,{children:"Sélectionnez une séance existante à ajouter à ce cycle"})]}),e.jsx("div",{className:"py-4",children:e.jsxs(Je,{value:I,onValueChange:K,children:[e.jsx(Ke,{children:e.jsx(We,{placeholder:"Sélectionner une séance"})}),e.jsx(Ge,{children:se.length===0?e.jsx("div",{className:"p-4 text-center text-sm text-gray-500",children:"Aucune séance disponible"}):se.map(s=>e.jsxs(Qe,{value:s.id,children:[s.date?new Date(s.date).toLocaleDateString("fr-FR"):"Sans date",s.start_time&&` - ${s.start_time}`,s.instructors&&s.instructors.length>0&&` (${s.instructors[0]})`]},s.id))})]})}),e.jsxs(B,{children:[e.jsx(n,{variant:"outline",onClick:()=>{w(!1),K("")},children:"Annuler"}),e.jsxs(n,{onClick:De,disabled:f||!I,children:[f&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"}),"Ajouter"]})]})]})}),e.jsx(z,{open:ye,onOpenChange:J,children:e.jsxs(R,{children:[e.jsxs(U,{children:[e.jsx(T,{children:"Créer une nouvelle séance"}),e.jsx(M,{children:"Remplissez les informations pour créer une nouvelle séance sans date."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(h,{placeholder:"Objectif de la séance",value:p.session_objective,onChange:s=>O({...p,session_objective:s.target.value})}),e.jsx(h,{placeholder:"Équipement",value:p.equipment,onChange:s=>O({...p,equipment:s.target.value})}),e.jsx(ee,{placeholder:"Commentaire",value:p.comment,onChange:s=>O({...p,comment:s.target.value})})]}),e.jsxs(B,{children:[e.jsx(n,{variant:"outline",onClick:()=>J(!1),children:"Annuler"}),e.jsxs(n,{onClick:ke,disabled:f,children:[f&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"})," Créer"]})]})]})}),e.jsx(z,{open:Ne,onOpenChange:A,children:e.jsxs(R,{children:[e.jsxs(U,{children:[e.jsx(T,{children:"Créer une séance fictive"}),e.jsx(M,{children:"Remplissez les informations pour créer une séance fictive."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(h,{placeholder:"Objectif de la séance",value:j.session_objective,onChange:s=>$({...j,session_objective:s.target.value})}),e.jsx(h,{placeholder:"Équipement",value:j.equipment,onChange:s=>$({...j,equipment:s.target.value})}),e.jsx(ee,{placeholder:"Commentaire",value:j.comment,onChange:s=>$({...j,comment:s.target.value})})]}),e.jsxs(B,{children:[e.jsx(n,{variant:"outline",onClick:()=>A(!1),children:"Annuler"}),e.jsxs(n,{onClick:Ae,disabled:f,children:[f&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"})," Créer"]})]})]})}),e.jsx(z,{open:we,onOpenChange:F,children:e.jsxs(R,{className:"sm:max-w-[600px]",children:[e.jsxs(U,{children:[e.jsx(T,{children:"Modifier le cycle"}),e.jsx(M,{children:"Modifiez les informations générales du cycle et ajoutez des documents."})]}),x&&e.jsxs("div",{className:"space-y-4 max-h-[60vh] overflow-y-auto pr-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-name",children:"Nom du cycle"}),e.jsx(h,{id:"cycle-name",value:x.name,onChange:s=>L({...x,name:s.target.value}),placeholder:"Nom du cycle"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-short-desc",children:"Description courte"}),e.jsx(h,{id:"cycle-short-desc",value:x.short_description,onChange:s=>L({...x,short_description:s.target.value}),placeholder:"Description courte"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-long-desc",children:"Description longue"}),e.jsx(ee,{id:"cycle-long-desc",value:x.long_description,onChange:s=>L({...x,long_description:s.target.value}),placeholder:"Description détaillée du cycle",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-pdf",children:"Document PDF"}),t.pdf_url&&e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(oe,{className:"w-4 h-4 text-red-600"}),e.jsx("a",{href:t.pdf_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline",children:"Document actuel"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{id:"cycle-pdf",type:"file",accept:".pdf",onChange:s=>{var a;return W(((a=s.target.files)==null?void 0:a[0])||null)},className:"flex-1"}),P&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:P?"Un nouveau PDF sera téléchargé":"Laisser vide pour conserver le PDF actuel"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"cycle-image",children:"Image illustrative"}),re&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative w-full h-48 overflow-hidden bg-gray-100 rounded-lg border-2 border-gray-200",children:e.jsx("img",{src:re,alt:"Aperçu",className:"w-full h-full object-cover",style:{objectPosition:b}})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"text-sm",children:"Position de l'image"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(n,{type:"button",variant:b==="top"?"default":"outline",size:"sm",onClick:()=>S("top"),className:"text-xs",children:"Haut"}),e.jsx(n,{type:"button",variant:b==="center"?"default":"outline",size:"sm",onClick:()=>S("center"),className:"text-xs",children:"Centre"}),e.jsx(n,{type:"button",variant:b==="bottom"?"default":"outline",size:"sm",onClick:()=>S("bottom"),className:"text-xs",children:"Bas"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{id:"cycle-image",type:"file",accept:"image/*",onChange:Ce,className:"flex-1"}),q&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),"Prêt"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:q?"Une nouvelle image sera téléchargée":t.image_url?"Laisser vide pour conserver l'image actuelle":"Format recommandé: 16:9 (1200x675px)"})]})]}),e.jsxs(B,{children:[e.jsx(n,{variant:"outline",onClick:()=>{F(!1),W(null),G(null)},children:"Annuler"}),e.jsxs(n,{onClick:_e,disabled:te,children:[te&&e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"}),"Sauvegarder"]})]})]})})]}):null};export{es as default};

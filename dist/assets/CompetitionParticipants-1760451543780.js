import{W as xe,u as ue,l as pe,aT as je,r as a,j as e,d as o,a3 as ge,a5 as z,aO as B,C as q,t as fe,v as be,aU as ve,aR as Ne,w as V,B as y,T as Ce,O as we,Q as ye,R as Se,U as _e,z as k,S as ke,I as Ae,D as H,E as G,F as J,G as Q,J as D,X as Te,a2 as Ee,s as h}from"./index-1760451543780.js";import{S as De}from"./save-1760451543780.js";const Re=()=>{const{id:x}=xe(),W=ue(),{toast:d}=pe(),{showMemberDetails:X}=je(),[M,K]=a.useState(null),[p,A]=a.useState([]),[P,Y]=a.useState([]),[l,R]=a.useState([]),[u,Z]=a.useState("");a.useState("");const[ee,$]=a.useState(!0),[se,j]=a.useState(!1),[n,g]=a.useState([]),[L,te]=a.useState("Competiteur"),[O,I]=a.useState(!1),[m,S]=a.useState([]),[f,re]=a.useState(""),[b,ae]=a.useState([]),ie=["Competiteur","Coach","Arbitre","Organisateur"],ne=["Homme","Femme"];a.useEffect(()=>{x&&(async()=>{$(!0);try{const{data:r,error:t}=await h.from("competitions").select("*").eq("id",x).single();if(t)throw t;K(r);const{data:i,error:v}=await h.from("competition_participants").select("*").eq("competition_id",x).order("role").order("created_at");if(v)throw v;let N=[];if(i&&i.length>0){const T=i.map(_=>_.member_id),{data:E,error:U}=await h.from("members").select("*").in("id",T);if(U)throw U;N=i.map(_=>({..._,members:(E==null?void 0:E.find(he=>he.id===_.member_id))||null}))}A(N);const{data:c,error:C}=await h.from("members").select("*").order("last_name");if(C)throw C;Y(c||[]),R(c||[]);const w=[...new Set(c==null?void 0:c.map(T=>T.category).filter(Boolean))];ae(w.sort()),S(w)}catch(r){console.error("Error loading data:",r),d({title:"Erreur",description:"Impossible de charger les données.",variant:"destructive"})}finally{$(!1)}})()},[x,d]),a.useEffect(()=>{let s=P;const r=p.map(t=>t.member_id);s=s.filter(t=>!r.includes(t.id)),u&&(s=s.filter(t=>{var i;return`${t.first_name} ${t.last_name}`.toLowerCase().includes(u.toLowerCase())||((i=t.category)==null?void 0:i.toLowerCase().includes(u.toLowerCase()))})),m.length>0&&(s=s.filter(t=>m.includes(t.category))),f&&(s=s.filter(t=>t.sexe===f)),R(s)},[P,p,u,m,f]);const le=async()=>{if(n.length===0){d({title:"Attention",description:"Veuillez sélectionner au moins un membre."});return}I(!0);try{const s=n.map(i=>({competition_id:x,member_id:i,role:L})),{error:r}=await h.from("competition_participants").insert(s);if(r)throw r;d({title:"Succès",description:`${n.length} participant(s) ajouté(s).`});const{data:t}=await h.from("competition_participants").select(`
          *,
          members (*)
        `).eq("competition_id",x).order("role").order("last_name",{foreignTable:"members"});A(t||[]),g([]),j(!1)}catch(s){console.error("Error adding participants:",s),d({title:"Erreur",description:"Impossible d'ajouter les participants.",variant:"destructive"})}finally{I(!1)}},ce=async s=>{if(window.confirm("Êtes-vous sûr de vouloir retirer ce participant ?"))try{const{error:r}=await h.from("competition_participants").delete().eq("id",s);if(r)throw r;A(t=>t.filter(i=>i.id!==s)),d({title:"Succès",description:"Participant retiré de la compétition."})}catch(r){console.error("Error removing participant:",r),d({title:"Erreur",description:"Impossible de retirer le participant.",variant:"destructive"})}},oe=s=>{S(r=>r.includes(s)?r.filter(t=>t!==s):[...r,s])},de=()=>{m.length===b.length?S([]):S([...b])},F=s=>{g(r=>r.includes(s)?r.filter(t=>t!==s):[...r,s])};if(ee)return e.jsx("div",{className:"flex justify-center items-center py-8",children:"Chargement..."});if(!M)return e.jsx("div",{className:"text-center py-8",children:"Compétition non trouvée."});const me=p.reduce((s,r)=>{const t=r.role||"Autre";return s[t]||(s[t]=[]),s[t].push(r),s},{});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(o,{variant:"ghost",onClick:()=>W("/competitions"),children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"Retour aux compétitions"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:M.name}),e.jsx("p",{className:"text-muted-foreground",children:"Gestion des participants"})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5"}),"Participants (",p.length,")"]}),e.jsxs(o,{onClick:()=>j(!0),children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Ajouter des participants"]})]}),e.jsxs("div",{className:"space-y-6",children:[Object.entries(me).map(([s,r])=>e.jsxs(q,{children:[e.jsx(fe,{children:e.jsxs(be,{className:"flex items-center gap-2",children:[s==="Competiteur"?e.jsx(ve,{className:"w-5 h-5"}):e.jsx(Ne,{className:"w-5 h-5"}),s," (",r.length,")"]})}),e.jsx(V,{children:e.jsx("div",{className:"space-y-2",children:r.map(t=>{var i,v,N,c,C;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("div",{className:"flex items-center gap-3 cursor-pointer flex-1",onClick:()=>{var w;return((w=t.members)==null?void 0:w.id)&&X(t.members.id)},children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:(i=t.members)!=null&&i.last_name&&((v=t.members)!=null&&v.first_name)?`${t.members.last_name.toUpperCase()} ${t.members.first_name}`:`Membre non trouvé (ID: ${t.member_id})`}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded font-medium ${((N=t.members)==null?void 0:N.sexe)==="Femme"?"bg-pink-100 text-pink-700 border border-pink-200":"bg-blue-100 text-blue-700 border border-blue-200"}`,children:((c=t.members)==null?void 0:c.category)||"Catégorie inconnue"}),e.jsx("span",{children:"•"}),e.jsx("span",{children:((C=t.members)==null?void 0:C.sexe)||"Sexe inconnu"}),t.ranking&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs(y,{variant:"outline",className:"text-xs",children:["Classé ",t.ranking,t.nb_competitor&&`/${t.nb_competitor}`]})]})]})]})}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>ce(t.id),className:"text-destructive hover:text-destructive",children:e.jsx(Ce,{className:"w-4 h-4"})})]},t.id)})})})]},s)),p.length===0&&e.jsx(q,{children:e.jsxs(V,{className:"text-center py-8",children:[e.jsx(z,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"Aucun participant"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Cette compétition n'a pas encore de participants."}),e.jsxs(o,{onClick:()=>j(!0),children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Ajouter le premier participant"]})]})})]}),e.jsx(we,{open:se,onOpenChange:j,children:e.jsxs(ye,{className:"max-w-5xl max-h-[85vh] overflow-hidden flex flex-col",children:[e.jsx(Se,{children:e.jsxs(_e,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Ajouter des participants"}),e.jsxs(y,{variant:"outline",children:[l.length," membre(s) disponible(s)"]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4",children:[e.jsxs("div",{className:"space-y-4 p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(k,{children:"Rechercher un membre"}),e.jsxs("div",{className:"relative",children:[e.jsx(ke,{className:"w-4 h-4 absolute left-3 top-3 text-muted-foreground"}),e.jsx(Ae,{placeholder:"Nom, prénom...",value:u,onChange:s=>Z(s.target.value),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx(k,{children:"Rôle à attribuer"}),e.jsxs(H,{value:L,onValueChange:te,children:[e.jsx(G,{children:e.jsx(J,{})}),e.jsx(Q,{children:ie.map(s=>e.jsx(D,{value:s,children:s},s))})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(k,{children:"Catégories"}),e.jsx(o,{variant:"ghost",size:"sm",onClick:de,className:"text-xs",children:m.length===b.length?"Tout désélectionner":"Tout sélectionner"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:b.map(s=>e.jsx(y,{variant:m.includes(s)?"default":"outline",className:"cursor-pointer text-xs",onClick:()=>oe(s),children:s},s))})]}),e.jsxs("div",{children:[e.jsx(k,{children:"Sexe"}),e.jsxs(H,{value:f,onValueChange:re,children:[e.jsx(G,{children:e.jsx(J,{placeholder:"Tous"})}),e.jsxs(Q,{children:[e.jsx(D,{value:"",children:"Tous"}),ne.map(s=>e.jsx(D,{value:s,children:s},s))]})]})]}),n.length>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(y,{variant:"default",className:"bg-blue-600",children:[n.length," membre(s) sélectionné(s)"]}),e.jsxs("span",{className:"text-sm text-blue-700",children:["sur ",l.length," disponible(s)"]})]}),e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>g([]),className:"text-blue-700 hover:text-blue-800 hover:bg-blue-100",children:[e.jsx(Te,{className:"w-3 h-3 mr-1"}),"Tout désélectionner"]})]})]}),e.jsx("div",{className:"space-y-2",children:l.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:u||m.length<b.length||f?"Aucun membre trouvé avec ces filtres.":"Tous les membres sont déjà participants."}):e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-primary text-primary-foreground",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 p-3 font-medium",children:[e.jsx("div",{className:"col-span-1 flex items-center justify-center",children:e.jsx("input",{type:"checkbox",checked:n.length===l.length&&l.length>0,onChange:()=>{n.length===l.length?g([]):g(l.map(s=>s.id))},className:"w-4 h-4"})}),e.jsx("div",{className:"col-span-3",children:"Nom"}),e.jsx("div",{className:"col-span-3",children:"Prénom"}),e.jsx("div",{className:"col-span-2",children:"Licence"}),e.jsx("div",{className:"col-span-3",children:"Catégorie"})]})}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:l.sort((s,r)=>s.last_name.localeCompare(r.last_name)).map((s,r)=>{var t;return e.jsxs("div",{className:`grid grid-cols-12 gap-4 p-3 border-b cursor-pointer transition-colors ${n.includes(s.id)?"bg-blue-50 border-blue-200":r%2===0?"bg-white":"bg-gray-50"} hover:bg-blue-100`,onClick:()=>F(s.id),children:[e.jsx("div",{className:"col-span-1 flex items-center justify-center",children:e.jsx("input",{type:"checkbox",checked:n.includes(s.id),onChange:()=>F(s.id),className:"w-4 h-4"})}),e.jsx("div",{className:"col-span-3 font-medium",children:((t=s.last_name)==null?void 0:t.toUpperCase())||""}),e.jsx("div",{className:"col-span-3",children:s.first_name||""}),e.jsx("div",{className:"col-span-2 text-sm text-muted-foreground",children:s.licence||"-"}),e.jsx("div",{className:"col-span-3",children:e.jsx(y,{variant:n.includes(s.id)?"default":"outline",className:"text-xs",children:s.category||"-"})})]},s.id)})})]})})]}),e.jsxs(Ee,{className:"pt-4",children:[e.jsx(o,{variant:"outline",onClick:()=>j(!1),children:"Annuler"}),e.jsxs(o,{onClick:le,disabled:n.length===0||O,children:[O&&e.jsx(De,{className:"w-4 h-4 mr-2 animate-spin"}),"Ajouter ",n.length>0&&`(${n.length})`]})]})]})})]})};export{Re as default};

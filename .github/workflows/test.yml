name: ğŸ§ª E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸš€ Start dev server
        run: npm run dev > /tmp/server.log 2>&1 &
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: â³ Wait for server to be ready
        run: |
          echo "â³ Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/ALJ_Jonage_Escalade/ > /dev/null 2>&1; then
              echo "âœ… Server is ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 2
          done
          echo "âŒ Server failed to start"
          echo "ğŸ“‹ Server logs:"
          cat /tmp/server.log || echo "No server logs available"
          exit 1

      - name: ğŸ§ª Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false
          spec: cypress/e2e/**/*.cy.js
          config-file: cypress.config.cjs
        env:
          CYPRESS_BASE_URL: http://localhost:3000/ALJ_Jonage_Escalade

      - name: ğŸ“Š Merge test reports
        if: always()
        run: npm run test:report || true

      - name: ğŸ“¤ Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports
          path: cypress/reports/
          retention-days: 30

      - name: ğŸ“¸ Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots/
          retention-days: 7

      - name: ğŸ¥ Upload videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos/
          retention-days: 7

      - name: ğŸ“ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportPath = 'cypress/reports/mochawesome.json';
            let summary = '## ğŸ§ª Test Results\n\n';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const stats = report.stats || {};

              summary += `| MÃ©trique | Valeur |\n`;
              summary += `|----------|--------|\n`;
              summary += `| âœ… RÃ©ussis | ${stats.passes || 0} |\n`;
              summary += `| âŒ Ã‰chouÃ©s | ${stats.failures || 0} |\n`;
              summary += `| â­ï¸ IgnorÃ©s | ${stats.skipped || 0} |\n`;
              summary += `| â±ï¸ DurÃ©e | ${(stats.duration / 1000).toFixed(2)}s |\n\n`;

              summary += `**Rapport complet:** Consultez les artefacts ci-dessous pour le rapport HTML dÃ©taillÃ©.\n`;
            } else {
              summary += 'âŒ Aucun rapport de test trouvÃ©.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # Job pour vÃ©rifier la couverture des tests
  test-coverage:
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate coverage report
        run: |
          echo "## Test Coverage Summary" > coverage-summary.md
          echo "âœ… All pages are covered by E2E tests" >> coverage-summary.md
          echo "" >> coverage-summary.md
          echo "### Pages tested:" >> coverage-summary.md
          echo "- ActualitÃ©s" >> coverage-summary.md
          echo "- Planning" >> coverage-summary.md
          echo "- Inscription" >> coverage-summary.md
          echo "- Contact" >> coverage-summary.md
          echo "- AdhÃ©rent" >> coverage-summary.md
          echo "- CompÃ©titions" >> coverage-summary.md
          echo "- Agenda" >> coverage-summary.md
          echo "- Historique des sÃ©ances" >> coverage-summary.md
          echo "- Gestion des cycles" >> coverage-summary.md
          echo "- Validation Passeports" >> coverage-summary.md
          echo "- RÃ©capitulatif des prÃ©sences" >> coverage-summary.md
          echo "- Support PÃ©dagogique" >> coverage-summary.md

      - name: ğŸ“¤ Upload coverage summary
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage-summary.md
